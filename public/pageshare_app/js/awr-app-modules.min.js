!function(window,$){"use strict";window.awr=window.awr||{},window.awr.bootQueue=window.awr.bootQueue||[];var console=window.console;function $abstract(name){return awr.Q.$abstract.call(awr.Q,name)}function $export(path,exp,opts){opts=opts||{takeEasy:!0,appExport:!0};let sta=window.awr.$static,q=window.awr.Q;return opts.appExport=!0,opts.takeEasy=!q.$booleanFalse(opts.takeEasy),sta.$export(path,exp,opts)}function $import(ref){return window.awr.$static.$import(ref)}function $emit(eventStr,event){return window.awr.$static.$emit(eventStr,event)}function __$require__(requires,obj){return window.awr.$static.$require(requires,obj)}function __onModuleBootTimeoutError__(err){window.console.error("initModule@APP@AWR: Failed to instantiate app module. \n\t + Details: Init process interrupted by timeout. \n\t + Hint: Required components were not ready  before maximum wait time."),window.console.error(err)}function __callModuleMainFn__(mainFn,requires){try{"function"==typeof mainFn&&(!function(requires){return window.awr.Q.$arrayNotEmpty(requires)||window.awr.Q.$objectExist(requires)}(requires)?mainFn.call(window.awr.Q):window.awr.Q.$commonWaitAndProceedOperation(requires,function(){mainFn.call(window.awr.Q)},3e3,__onModuleBootTimeoutError__))}catch(e){console.error(e)}}function __pushToBootQueue__(init){window.awr.bootQueue.push({moduleName:"basicAppModule@AWR",requires:["object:awr.$$appEssentials","object:awr.coreTemplate","object:awr.ux"],wTime:36e5,init:init,QAsContext:!0})}!function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");$.fn.isInViewportLegacy=function(){let elementTop=$(this).offset().top,elementBottom=elementTop+$(this).outerHeight(),viewportTop=$(window).scrollTop(),viewportBottom=viewportTop+$(window).height();return elementBottom>viewportTop&&elementTop<viewportBottom},$.fn.isInViewport=function(extraTopOffset,viewPort=window){let res=!1;if(!Q.$exist(this))return res;try{let elementTop=$(this).offset().top,elementBottom=elementTop+$(this).outerHeight(),viewportTop=$(viewPort).scrollTop(),viewportBottom=viewportTop+$(viewPort).height();res=elementBottom>viewportTop&&elementTop<viewportBottom,Q.$numberExist(extraTopOffset)&&(res=elementBottom>viewportTop&&elementTop<viewportBottom+extraTopOffset)}catch(err){res=!1}return res},$.fn.isScrollInBottom=function(win){return Q.$objectExist(win)||(win=window),$(win).scrollTop()+$(win).height()===$(document).height()};class App extends awr.Controller{static get $require(){return{bootRoutines:"service:appBootRoutines",globalFunctions:"service:globalFunctions",remoteConfig:"config:remoteConnection",router:"service:router",modal:"service:modal",socket:"observable:socket"}}constructor(data,parent){super(App.$require,data,parent);let{bootRoutines:bootRoutines,globalFunctions:globalFunctions,router:router,modal:modal,socket:socket,docEvents:docEvents}=this,location=window.location;this.$disableDefaultActionAutoRecompile();let currentState,scope=this;bootRoutines.init(scope),globalFunctions.attach(scope),this.skipDemoSession=Q.$setContainsString(["pageshare.fi","www.pageshare.fi"],location.host)||Q.$setContainsString(["8000","8080"],`${location.port}`),this.$bind("observable:notFound@states@router",{onEvent(event,preventDefault){preventDefault(),event.preventDefault(),$emit("collection:events",{name:"new-doc-selected",doc:null}),router.$go("errors-view",{params:{code:"404"},attrs:{}},!0)}}),this.$bind("observable:start@states@router",{onEvent(event,preventDefault){preventDefault(),"default"!==event.to.name&&$("body").removeClass("reader-mode")}}),this.$bind("observable:success@states@router",{onEvent(event,preventDefault){preventDefault(),$("body").toggleClass("reader-mode","default"===event.to.name)}}),this.$bind("observable:error@states@router",{onEvent(event,preventDefault){if(preventDefault(),event&&event.errorMessage&&event.errorMessage.toLowerCase().indexOf("failed to resolve required data")>=0){if((currentState=router.$getCurrentState())&&"default"===currentState.name&&(scope.currentDoc=null,$emit("collection:events",{name:"new-doc-selected",doc:null})),Q.$booleanTrue(event.isAuthFailed))return;Q.$functionExist(event.preventDefault)&&event.preventDefault(),router.$go("errors-view",{params:{code:"404"},attrs:{}},!0)}}}),this.$bind("observable:authEvents",{onEvent(event,preventDefault){preventDefault(),!Q.$booleanTrue(scope.reloading)&&Q.$objectExist(event)&&("sign-in"===event.type?bootRoutines.setupCurrentUser(scope):"sign-out"===event.type&&(bootRoutines.setupCurrentUser(scope),setTimeout(_=>{router.$reloadCurrentState()},250)),scope.reloading=!0,setTimeout(_=>{scope.reloading=!1},1e3))}})}openPrivacyPolicy(){let{modal:modal}=this;modal.$enter("privacyPolicyModal",{modalClass:"privacy-policy-parent"})}}$export(App),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Bookmark extends awr.Model{static get $require(){return{}}constructor(){super(Bookmark.$require),this.url="/bookmark/",this.headers={}}}$export(Bookmark),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Invite extends awr.Model{static get $require(){return{}}constructor(){super(Invite.$require),this.url="/invite/",this.headers={}}}$export(Invite),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MainCollection extends awr.Model{static get $require(){return{}}constructor(){super(MainCollection.$require),this.url="/main_collection/",this.headers={}}}$export(MainCollection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class Bookmarks extends awr.$.DataFetcher{static get $require(){return{bookmarksResolver:"resolvable:bookmarks"}}constructor(){super(Bookmarks.$require),this.listenerIdSuffix="BookmarksDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{bookmarks:bookmarks}=scope;return superScope.cachedBookmarksReady&&Q.$arrayExists(bookmarks)}fetch(scope,state){let{bookmarksResolver:bookmarksResolver}=this;return bookmarksResolver.resolveLater(state)}onResolve(scope,res){scope.bookmarks=res}onReject(scope,err){console.error(err)}}$export(Bookmarks)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class EditView extends awr.$.DataFetcher{static get $require(){return{docResolver:"resolvable:doc",collectionsResolver:"resolvable:collections",publishersResolver:"resolvable:ctrPublishers"}}constructor(){super(EditView.$require),this.listenerIdSuffix="EditViewDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{doc:doc,collections:collections,publishers:publishers}=scope;return superScope.cachedCollsReady&&superScope.cachedPublishersReady&&Q.$arrayExists(collections)&&Q.$arrayExists(publishers)&&Q.$objectExists(doc)&&!doc.isPlaceholder}fetch(scope,state){let{docResolver:docResolver,collectionsResolver:collectionsResolver,publishersResolver:publishersResolver}=this;return Promise.all([docResolver.resolveLater(state),collectionsResolver.resolveLater(state),publishersResolver.resolveLater(state)])}onResolve(scope,res){scope.doc=res[0],scope.collections=res[1],scope.publishers=res[2]}onReject(scope,err){console.error(err)}}$export(EditView)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class InvitesView extends awr.$.DataFetcher{static get $require(){return{invitesResolver:"resolvable:invites"}}constructor(){super(InvitesView.$require),this.listenerIdSuffix="InvitesViewDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{invites:invites}=scope;return superScope.cachedInvitesReady&&Q.$arrayExists(invites)}fetch(scope,state){let{invitesResolver:invitesResolver}=this;return invitesResolver.resolveLater(state)}onResolve(scope,res){scope.invites=res}onReject(scope,err){console.error(err)}}$export(InvitesView)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class MyCollections extends awr.$.DataFetcher{static get $require(){return{collectionsResolver:"resolvable:myCollections",publishersResolver:"resolvable:ctrPublishers"}}constructor(){super(MyCollections.$require),this.listenerIdSuffix="MyCollectionsDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{collections:collections,publishers:publishers}=scope;return superScope.cachedMyCollsReady&&superScope.cachedPublishersReady&&Q.$arrayExists(collections)&&Q.$arrayExists(publishers)}fetch(scope,state){let{collectionsResolver:collectionsResolver,publishersResolver:publishersResolver}=this;return Promise.all([collectionsResolver.resolveLater(state),publishersResolver.resolveLater(state)])}onResolve(scope,res){scope.collections=res[0],scope.publishers=res[1]}onReject(scope,err){console.error(err)}scopeBinds(scope){let{superScope:superScope}=this;scope.$bind("model:MyCollection",{onEvent(event,preventDefault){preventDefault(),"remove"===event.requestType?(scope.collections=Q.$reduce(scope.collections,nxt=>!Q.$idEqual(nxt.id,event.requestId)),superScope.cachedMyColls=scope.collections):"create"===event.requestType&&Q.$count(scope.collections,nxt=>Q.$idEqual(nxt.id,event.requestId))<1&&(scope.collections.push(event.modelInstance),superScope.cachedMyColls=scope.collections)}})}}$export(MyCollections)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class Tags extends awr.$.DataFetcher{static get $require(){return{tagsResolver:"resolvable:ctrTags"}}constructor(){super(Tags.$require),this.listenerIdSuffix="TagsDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{tags:tags}=scope;return superScope.cachedTagsReady&&Q.$arrayExists(tags)}fetch(scope,state){let{tagsResolver:tagsResolver}=this;return tagsResolver.resolveLater(state)}onResolve(scope,res){scope.tags=res}onReject(scope,err){console.error(err)}}$export(Tags)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class UploadView extends awr.$.DataFetcher{static get $require(){return{collectionsResolver:"resolvable:myCollections",publishersResolver:"resolvable:ctrPublishers"}}constructor(){super(UploadView.$require),this.listenerIdSuffix="UploadViewDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{collections:collections,publishers:publishers}=scope;return superScope.cachedMyCollsReady&&superScope.cachedPublishersReady&&Q.$arrayExists(collections)&&Q.$arrayExists(publishers)}fetch(scope,state){let{collectionsResolver:collectionsResolver,publishersResolver:publishersResolver}=this;return Promise.all([collectionsResolver.resolveLater(state),publishersResolver.resolveLater(state)])}onResolve(scope,res){scope.collections=res[0],scope.publishers=res[1]}onReject(scope,err){console.error(err)}}$export(UploadView)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class UsersView extends awr.$.DataFetcher{static get $require(){return{usersResolver:"resolvable:ctrUsers",publishersResolver:"resolvable:ctrPublishers"}}constructor(){super(UsersView.$require),this.listenerIdSuffix="UsersViewDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{users:users,publishers:publishers}=scope;return superScope.cachedUsersReady&&superScope.cachedPublishersReady&&Q.$arrayExists(users)&&Q.$arrayExists(publishers)}fetch(scope,state){let{usersResolver:usersResolver,publishersResolver:publishersResolver}=this;return Promise.all([usersResolver.resolveLater(state),publishersResolver.resolveLater(state)])}onResolve(scope,res){scope.users=res[0],scope.publishers=res[1]}onReject(scope,err){console.error(err)}}$export(UsersView)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;function $main(){class VView extends awr.$.DataFetcher{static get $require(){return{vDocResolver:"resolvable:vDoc",collectionsResolver:"resolvable:collections",publishersResolver:"resolvable:ctrPublishers",bookmarksResolver:"resolvable:bookmarks"}}constructor(){super(VView.$require),this.listenerIdSuffix="VViewDataFetcher",this.recompileOnResolve=!0,Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}isDataFetchReady(scope,state){let{superScope:superScope}=this,{collections:collections,publishers:publishers,doc:doc,bookmarks:bookmarks}=scope;return superScope.cachedCollsReady&&superScope.cachedPublishersReady&&superScope.cachedBookmarksReady&&Q.$arrayExists(collections)&&Q.$arrayExists(publishers)&&Q.$arrayExists(bookmarks)&&Q.$objectExists(doc)&&!doc.isPlaceholder}fetch(scope,state){let{vDocResolver:vDocResolver,collectionsResolver:collectionsResolver,publishersResolver:publishersResolver,bookmarksResolver:bookmarksResolver}=this;return Promise.all([vDocResolver.resolveLater(state),collectionsResolver.resolveLater(state),publishersResolver.resolveLater(state),bookmarksResolver.resolveLater(state)])}onResolve(scope,res){scope.doc=res[0],scope.collections=res[1],scope.publishers=res[2],scope.bookmarks=res[3]}onReject(scope,err){console.error(err)}}$export(VView)}__$require__(__$$requires$$__,["class:DataFetcher@AWRType"]),__callModuleMainFn__($main,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;const scoreKey="__$$score$$__";class FieldSearch extends awr.Pipe{static get $require(){return{}}constructor(){super(FieldSearch.$require)}transform(set,query,field="name",defaultReduceFn=null){let score,transformedItems;return field=Q.$stringExist(field)?field:"name",Q.$stringExist(query)?(transformedItems=Q.$asCollection(set).$reduce(nxt=>(score=function(field,query){return field&&query?field.toLowerCase().indexOf(query.toLowerCase()):-1}(nxt[field],query),!!(nxt.hasOwnProperty(field)&&score>=0)&&(nxt[scoreKey]=score,!0))).$sortBy(scoreKey),set[Symbol.for("lastSearchResultLength")]=transformedItems.length,transformedItems):(transformedItems=Q.$functionExist(defaultReduceFn)?set.$reduce(defaultReduceFn):set,set[Symbol.for("lastSearchResultLength")]=transformedItems.length,transformedItems)}}$export(FieldSearch),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class HasRoleInPublisher extends awr.Pipe{static get $require(){return{roleHelper:"service:roleHelper"}}constructor(){super(HasRoleInPublisher.$require)}transform(set,userId,roleName){if(!Q.$stringExist(userId)&&!Q.$numberExist(userId))return Q.$asCollection([]);let{roleHelper:roleHelper}=this;return roleName=Q.$setContainsString(["moderator","publisher","creator"],roleName)?roleName:"any",Q.$asCollection(set).$reduce(nxt=>roleHelper.hasRoleInPublisher(nxt,userId,roleName)).$sortByDesc(function(a,b){let v=0;return roleHelper.hasRoleInPublisher(a,userId,"publisher")&&!roleHelper.hasRoleInPublisher(b,userId,"publisher")?v=1:!roleHelper.hasRoleInPublisher(a,userId,"publisher")&&roleHelper.hasRoleInPublisher(b,userId,"publisher")&&(v=-1),v})}}$export(HasRoleInPublisher),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class PickDevColls extends awr.Pipe{static get $require(){return{}}constructor(){super(PickDevColls.$require)}transform(input,...args){return input.$map(nxt=>(Q.$isEmpty(nxt.stories)?nxt.stCount=0:nxt.stCount=nxt.stories.length,nxt))}}$export(PickDevColls),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class PrettyDate extends awr.Pipe{static get $require(){return{dateFormatter:"service:dateFormatter"}}constructor(){super(PrettyDate.$require)}transform(input,format="long"){let{dateFormatter:dateFormatter}=this;return dateFormatter.prettyDate(input,format)}}$export(PrettyDate),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class PublisherCollections extends awr.Pipe{static get $require(){return{}}constructor(){super(PublisherCollections.$require)}transform(set,publisherId,userId,publishers){let publisher,publisherColls,collsInSomePublisher;return!Q.$exist(publisherId)||Q.$isEmpty(publishers)||Q.$isEmpty(set)?Q.$asCollection([]):(Q.$functionExist(set.$reduce)||(set=Q.$asCollection(set)),"personal-collections"===publisherId?(collsInSomePublisher=Q.$asCollection([]),Q.$each(publishers,nxt=>{collsInSomePublisher=collsInSomePublisher.$merge(getPublisherCollIds(nxt))}),set.$reduce(nxt=>!collsInSomePublisher.includes(parseInt(nxt.id))&&nxt.user_id==userId)):(publisher=publishers.$find("id",parseInt(publisherId)),publisherColls=getPublisherCollIds(publisher),set.$reduce(nxt=>publisherColls.includes(parseInt(nxt.id)))))}}function getPublisherCollIds(publisher){return Q.$asCollection(publisher&&publisher.collections?publisher.collections:[]).$map(nxt=>parseInt(nxt.id))}$export(PublisherCollections),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class Bookmarks extends awr.Resolvable{static get $require(){return{model:"model:Bookmark"}}constructor(){super(Bookmarks.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}}function resolveFn(state,self,network=!1){let{model:model,superScope:superScope}=self;return Q.$objectExist(superScope.currentUser)?Q.$arrayExists(superScope.cachedBookmarks)&&superScope.cachedBookmarksReady?Promise.resolve(superScope.cachedBookmarks):network?new Promise((resolve,reject)=>{model.$findAll().then(res=>{superScope.cachedBookmarksReady=!0,superScope.cachedBookmarks=Q.$asCollection(res),resolve(Q.$asCollection(res))},err=>{console.error(err),reject(err)})}):(superScope.cachedBookmarksReady=!1,Promise.resolve(Q.$asCollection([]))):(superScope.cachedBookmarksReady=!0,Promise.resolve(Q.$asCollection([])))}$export(Bookmarks),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class Invites extends awr.Resolvable{static get $require(){return{model:"model:Invite"}}constructor(){super(Invites.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}}function resolveFn(state,self,network=!1){let{model:model,superScope:superScope}=self;return Q.$objectExist(superScope.currentUser)?Q.$arrayExists(superScope.cachedInvites)&&superScope.cachedInvitesReady?Promise.resolve(superScope.cachedInvites):network?new Promise((resolve,reject)=>{model.$findAll().then(res=>{superScope.cachedInvitesReady=!0,superScope.cachedInvites=Q.$asCollection(res),resolve(Q.$asCollection(res))},err=>{console.error(err),reject(err)})}):(superScope.cachedInvitesReady=!1,Promise.resolve(Q.$asCollection([]))):(superScope.cachedInvitesReady=!0,Promise.resolve(Q.$asCollection([])))}$export(Invites),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class AppBootRoutines extends awr.Service{static get $require(){return{modelManager:"service:modelManager",remoteConfig:"config:remoteConnection",socketClient:"service:socketClient",scrollDirection:"service:scrollDirection"}}constructor(){super(AppBootRoutines.$require)}init(scope){let{modelManager:modelManager,remoteConfig:remoteConfig,socketClient:socketClient,scrollDirection:scrollDirection}=this;!function(scope,modelManager,remoteConfig,socketClient,scrollDirection){let globalHeaders={accept:"application/json","content-type":"application/json"};Object.defineProperty(globalHeaders,"authorization",{get:()=>$import(`token:awr_app_token @decoder: base64:${remoteConfig.decoder}`)}),scope.serverURL=remoteConfig.serverURL,scope.appName="pageshare_main_app",modelManager.$setGlobalPrefix(remoteConfig.apiURL),modelManager.$setGlobalHeaders(globalHeaders),scope.setCleanUserPictureSrc=(user=>{user&&Q.$stringExist(user.picture)&&user.picture.startsWith("/")&&(user.picture=`${scope.serverURL}${user.picture}`)}),setupCurrentUser(scope,remoteConfig,socketClient),function(scope){$(window).on("scroll",function(){}),$(window.document).on("click",function(event){let onMenu=$(scope.$getDom()).find(".main-menu-expand.on"),mainMenuToggle=$(scope.$getDom()).find(".main-menu.menu-toggle"),onUserMenu=$(scope.$getDom()).find(".user-menu-expand.on"),openPageMenus=$(scope.$getDom()).find(".doc-page .page-menu.on"),openDocMenu=$(scope.$getDom()).find(".ps-header.doc-menu-open"),docPageActions=$(scope.$getDom()).find(".doc-page .tools .left-actions"),tagsSection=$(scope.$getDom()).find(".tags-section"),target=event.target;Q.$isEmpty($(target).closest(".main-menu-expand, .main-menu"))&&$(onMenu).animate({width:"hide"},165,function(){$(onMenu).removeClass("on"),$(mainMenuToggle).removeClass("open")}),Q.$isEmpty($(target).closest(".user-menu-expand, .user-menu"))&&$(onUserMenu).animate({height:"hide"},165,function(){$(onUserMenu).removeClass("on")}),Q.$isEmpty($(target).closest(".tags-section .tag-search, .tag-subscription.search-suggestion"))?$(tagsSection).removeClass("in-search"):Q.$isEmpty(tagsSection)||$(tagsSection).addClass("in-search"),Q.$isEmpty($(target).closest(".doc-page .page-menu"))&&$(openPageMenus).removeClass("on"),Q.$isEmpty($(target).closest(".doc-page"))&&$(docPageActions).removeClass("on"),Q.$isEmpty($(target).closest(".ps-header .doc-menu, .ps-header .doc-menu-toggle "))&&$(scope.$getDom()).find(".ps-header .doc-menu").animate({height:"hide"},165,function(){$(openDocMenu).removeClass("doc-menu-open")})})}(scope),scrollDirection.start($import("object:awr.superScope"))}(scope,modelManager,remoteConfig,socketClient,scrollDirection)}setupCurrentUser(scope){let{remoteConfig:remoteConfig,socketClient:socketClient}=this;setupCurrentUser(scope,remoteConfig,socketClient)}}function setupCurrentUser(scope,remoteConfig,socketClient){Q.$objectExist(remoteConfig.user)&&Q.$booleanFalse(remoteConfig.isGuest)?(scope.currentUser=remoteConfig.user,scope.currentNickname=Q.$stringExist(scope.currentUser.name)?scope.currentUser.name.split(" ")[0]:"anonymous",scope.isCurrentAdmin=!!Q.$arrayNotEmpty(scope.currentUser.roles)&&Q.$reduce(scope.currentUser.roles,nxt=>"moderator"===nxt.name).length>0,Q.$functionExist(scope.setCleanUserPictureSrc)&&scope.setCleanUserPictureSrc(scope.currentUser),socketClient.connect()):(socketClient.disconnect(),scope.isGuest=!0,scope.currentUser=null)}$export(AppBootRoutines),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");const readyWId="book-form-scope-configurer-ready-watcher",recompileWId="book-form-scope-configurer-recompile-watcher";class BookFormScopeConfigurer extends awr.Service{static get $require(){return{pubCollPipe:"pipe:publisherCollections",modal:"service:modal",collFetcher:"service:collectionFetcher",autocomplete:"service:autocomplete"}}constructor(){super(BookFormScopeConfigurer.$require),Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}setup({scope:scope,personalCollectionGroupId:personalCollectionGroupId,initialCollectionKey:initialCollectionKey,publisherSelectPath:publisherSelectPath,yearSelectPath:yearSelectPath,collectionSelectPath:collectionSelectPath}){let initColl,{superScope:superScope,collFetcher:collFetcher}=this,years=[];for(let y=1900;y<=(new Date).getFullYear();y++)years.push(y);years.reverse(),scope.activePublisherId=personalCollectionGroupId,Object.defineProperty(scope,"currentUserId",{get:()=>Q.$objectExist(superScope.currentUser)?superScope.currentUser.id:null}),Object.defineProperty(scope,"activePublisher",{get:()=>scope.activePublisherId!==personalCollectionGroupId?scope.publishers.$find("id",parseInt(scope.activePublisherId)):null}),Q.$numberExist(parseInt(scope[initialCollectionKey]))&&(initColl=scope.collections.$find("id",parseInt(scope[initialCollectionKey])),scope.initialCollectionId=initColl&&Q.$numberExist(parseInt(initColl.id))?parseInt(initColl.id):null,scope.activePublisherId=Q.$objectExist(initColl)&&Q.$numberExist(parseInt(initColl.publisher_id))?parseInt(initColl.publisher_id):scope.activePublisherId),scope.$addBeforeRecompileListener(_=>{Q.$numberExist(parseInt(scope[initialCollectionKey]))&&(initColl=scope.collections.$find("id",parseInt(scope[initialCollectionKey])),scope.initialCollectionId=initColl&&Q.$numberExist(parseInt(initColl.id))?parseInt(initColl.id):null,scope.activePublisherId=Q.$objectExist(initColl)&&Q.$numberExist(parseInt(initColl.publisher_id))?parseInt(initColl.publisher_id):scope.activePublisherId)},recompileWId),scope.$ready(_=>{init({scope:scope,initColl:initColl,publisherSelectPath:publisherSelectPath,collectionSelectPath:collectionSelectPath,yearSelectPath:yearSelectPath,years:years,collFetcher:collFetcher})},readyWId),scope.$addRecompileListener(_=>{init({scope:scope,initColl:initColl,publisherSelectPath:publisherSelectPath,collectionSelectPath:collectionSelectPath,yearSelectPath:yearSelectPath,years:years,collFetcher:collFetcher})},recompileWId)}autocompleteSetup(field){let{autocomplete:autocomplete}=this;Q.$setContainsString(["authors","categories","languages","tags"],field.key)&&(field.onSearch=(query=>{let opts={type:"meta_key",key:field.key,take:10};return"tags"===field.key&&(opts.type=null,opts.key=null),autocomplete.search(query,opts)}))}selectPublisher({scope:scope,collectionSelectPath:collectionSelectPath,publisherSelectPath:publisherSelectPath,personalCollectionGroupId:personalCollectionGroupId}){let{modal:modal,pubCollPipe:pubCollPipe}=this;selectPublisher({scope:scope,pubCollPipe:pubCollPipe,publisherId:$(scope.$getDom()).find(publisherSelectPath).val(),collSelectPath:collectionSelectPath,onEmpty(){$(scope.$getDom()).find(publisherSelectPath).val(personalCollectionGroupId),modal.$enter("smallNotifModal",{icon:"fa fa-exclamation-triangle text-warning",message:"This publisher has no collections and cannot be selected!",showRemove:!0}),selectPublisher({scope:scope,publisherId:$(scope.$getDom()).find(publisherSelectPath).val(),collSelectPath:"select.collections"})}})}}function init({scope:scope,initColl:initColl,publisherSelectPath:publisherSelectPath,collectionSelectPath:collectionSelectPath,yearSelectPath:yearSelectPath,years:years,collFetcher:collFetcher}){Q.$numberExist(scope.activePublisherId)&&$(scope.$getDom()).find(publisherSelectPath).val(scope.activePublisherId),Q.$objectExist(initColl)&&Q.$numberExist(parseInt(initColl.id))&&$(scope.$getDom()).find(collectionSelectPath).val(initColl.id),function(scope,yearSelect,years){if(0!==scope.step)return;$(scope.$getDom()).find(yearSelect).find("option").remove();for(let y of years)$(scope.$getDom()).find('select[name="year"]').append(`<option value="${y}">${y}</option>`)}(scope,yearSelectPath,years),collFetcher.setCurrent(scope.initialCollectionId)}function selectPublisher({scope:scope,pubCollPipe:pubCollPipe,publisherId:publisherId,collSelectPath:collSelectPath,onEmpty:onEmpty}){let colls,{collections:collections,publishers:publishers,currentUserId:currentUserId}=scope,collSelect=$(scope.$getDom()).find(collSelectPath);scope.activePublisherId=publisherId,scope.doc=Q.$objectExist(scope.doc)?scope.doc:{},Q.$numberExist(parseInt(scope.activePublisherId))?(scope.activePublisherId=parseInt(scope.activePublisherId),scope.doc.publisher_id=scope.activePublisherId):scope.doc.publisher_id=null,colls=pubCollPipe.transform(collections,scope.activePublisherId,currentUserId,publishers),$(collSelect).find("option").remove(),colls.$each(nxt=>{$(collSelect).append(`<option value="${nxt.id}">${nxt.name}</option>`)}),Q.$isEmpty(colls)?(scope.doc.collection_id=null,setTimeout(_=>{Q.$functionExist(onEmpty)&&onEmpty()},500)):scope.doc.collection_id=colls[0].id}$export(BookFormScopeConfigurer),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class Bookmarker extends awr.Service{static get $require(){return{bookmarkModel:"model:Bookmark"}}constructor(){super(Bookmarker.$require),Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}setup({scope:scope,bookmarks:bookmarks}){let{superScope:superScope}=this;scope.bookmarks=Q.$isEmpty(superScope.cachedBookmarks)?Q.$asCollection([]):superScope.cachedBookmarks,Object.defineProperty(scope,"isDocBookmarked",{get:()=>Q.$objectExist(scope.doc)&&!Q.$isEmpty(scope.bookmarks)&&scope.bookmarks.$count(nxt=>parseInt(nxt.story.id)===parseInt(scope.doc.id))>0,configurable:!0})}toggleBookmark({scope:scope,uiSelector:uiSelector}){let bookmark,{bookmarkModel:bookmarkModel,superScope:superScope}=this,{bookmarks:bookmarks}=scope;scope.isBookmarkingBusy||(scope.isBookmarkingBusy=!0,scope.isDocBookmarked?($(scope.$getDom()).find(uiSelector).removeClass("active"),(bookmark=bookmarks.$reduce(nxt=>parseInt(nxt.story_id)===parseInt(scope.doc.id)).$first()).$remove().then(_=>{Q.$arrayExists(superScope.cachedBookmarks)||(superScope.cachedBookmarks=Q.$asCollection([])),superScope.cachedBookmarks=bookmarks.$reduce(nxt=>parseInt(nxt.story_id)!==parseInt(scope.doc.id)),scope.bookmarks=superScope.cachedBookmarks,scope.isBookmarkingBusy=!1},err=>{scope.isBookmarkingBusy=!1,console.error(err)})):($(scope.$getDom()).find(uiSelector).addClass("active"),bookmarkModel.$create({story_id:scope.doc.id}).then(newInstance=>{Q.$arrayExists(superScope.cachedBookmarks)||(superScope.cachedBookmarks=Q.$asCollection([])),superScope.cachedBookmarks.push(newInstance),scope.bookmarks=superScope.cachedBookmarks,scope.isBookmarkingBusy=!1},err=>{scope.isBookmarkingBusy=!1,console.error(err)})))}removeBookmarkByDoc({scope:scope,doc:doc}){let{superScope:superScope}=this,{bookmarks:bookmarks}=scope,bookmark=bookmarks.$find("story_id",parseInt(doc.id));!scope.isBookmarkingBusy&&Q.$objectExist(doc)&&(scope.isBookmarkingBusy=!0,bookmark&&Q.$functionExist(bookmark.$remove)?bookmark.$remove().then(res=>{Q.$arrayExists(superScope.cachedBookmarks)||(superScope.cachedBookmarks=Q.$asCollection([])),superScope.cachedBookmarks=bookmarks.$reduce(nxt=>parseInt(nxt.story_id)!==parseInt(doc.id)),scope.bookmarks=superScope.cachedBookmarks,scope.isBookmarkingBusy=!1},err=>{scope.isBookmarkingBusy=!1,console.error(err)}):scope.isBookmarkingBusy=!1)}}$export(Bookmarker),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");const dummyPub={user:{},creators:[],moderators:[]};class CommonListCtrFn extends awr.Service{static get $require(){return{roleHelper:"service:roleHelper",listHelper:"service:listHelper",hasRoleInPubPipe:"pipe:hasRoleInPublisher",userResolver:"resolvable:ctrUsers",roleModel:"model:Role",publisherRoleModel:"model:PublisherRole",modal:"service:modal"}}constructor(){super(CommonListCtrFn.$require),this.$importSuperScope()}resolveRestOfUsers({scope:scope,state:state}){let{userResolver:userResolver,superScope:superScope}=this;userResolver.resolveRest(state).then(rest=>{Q.$isEmpty(rest)||(scope.users=scope.users.$merge(rest),superScope.cachedUsers=scope.users,Q.$functionExist(scope.onListRefresh)&&scope.onListRefresh())},err=>{console.error(err)})}decideFirstActivePublisher({scope:scope,publishers:publishers}){let{superScope:superScope,hasRoleInPubPipe:hasRoleInPubPipe}=this;superScope.currentUser&&(scope.activePublisher=hasRoleInPubPipe.transform(publishers,superScope.currentUser.id,"any").$first(),Q.$objectExist(scope.activePublisher)||(scope.activePublisher=dummyPub))}assignPublisherRole(user,publisher,roleName){let{publisherRoleModel:publisherRoleModel}=this;Q.$objectExist(user)&&Q.$objectExist(publisher)&&Q.$stringExist(roleName)&&(!Q.$isEmpty(user.roles)&&Q.$count(user.roles,r=>r.name===roleName||r.role_name===roleName)>0||publisherRoleModel.$create({user_id:user.id,publisher_id:publisher.id,name:roleName}).then(instance=>{},err=>{console.error(err)}))}removePublisherRole(user,publisher,roleName){let role,{publisherRoleModel:publisherRoleModel}=this;Q.$objectExist(user)&&Q.$objectExist(publisher)&&Q.$stringExist(roleName)&&(role=Q.$asCollection("moderator"===roleName?publisher.moderators:publisher.creators).$map(nxt=>{if(parseInt(nxt.id)===parseInt(user.id))return{id:nxt.role_id,name:nxt.role_name,user_id:nxt.id,publisher_id:publisher.id}}).$first(),Q.$objectExist(role)&&publisherRoleModel.$template(role).$remove().then(res=>{},err=>{console.error(err)}))}assignRole(user,roleName){let{roleModel:roleModel}=this;Q.$objectExist(user)&&Q.$stringExist(roleName)&&(!Q.$isEmpty(user.roles)&&Q.$count(user.roles,r=>r.name===roleName||r.role_name===roleName)>0||roleModel.$create({user_id:user.id,name:roleName}).then(instance=>{},err=>{console.error(err)}))}removePublisher(scope,publisher){let{superScope:superScope,modal:modal}=this;commonItemRemoveConfirm({modal:modal,itemType:"publisher",onConfirm(){!scope.isPublisherRemoveBusy&&publisher&&Q.$functionExist(publisher.$remove)&&(scope.isPublisherRemoveBusy=!0,publisher.$remove().then(res=>{scope.isPublisherRemoveBusy=!1,superScope.cachedPublishers=scope.publishers.$reduce(nxt=>parseInt(nxt.id)!==parseInt(publisher.id)),scope.publishers=superScope.cachedPublishers},err=>{scope.isPublisherRemoveBusy=!1,console.error(err)}))}})}removeAccount(scope,userAccount){let{superScope:superScope,modal:modal}=this;commonItemRemoveConfirm({modal:modal,itemType:"account",onConfirm(){!scope.isAccountRemoveBusy&&userAccount&&Q.$functionExist(userAccount.$remove)&&(scope.isAccountRemoveBusy=!0,userAccount.$remove().then(res=>{scope.isAccountRemoveBusy=!1,superScope.cachedUsers=scope.users.$reduce(nxt=>parseInt(nxt.id)!==parseInt(userAccount.id)),scope.users=superScope.cachedUsers,Q.$isEmpty(superScope.cachedPublishers)||(superScope.cachedPublishers=Q.$arrayExist(scope.publishers)?scope.publishers.$reduce(nxt=>parseInt(nxt.user_id)!==parseInt(userAccount.id)):Q.$asCollection([]),scope.publishers=superScope.cachedPublishers)},err=>{scope.isAccountRemoveBusy=!1,console.error(err)}))}})}removeRole(user,roleName){let role,{roleModel:roleModel}=this;Q.$objectExist(user)&&Q.$stringExist(roleName)&&(role=Q.$asCollection(user.roles).$find("name",roleName),Q.$objectExist(role)&&roleModel.$template(role).$remove().then(res=>{},err=>{console.error(err)}))}currentCanRemoveUser(userId){let{superScope:superScope,roleHelper:roleHelper}=this,current=superScope.currentUser;return current&&parseInt(current.id)!==parseInt(userId)&&roleHelper.rolesInclude(current,"admin@pageshare")}hasRole({scope:scope,userId:userId,roleName:roleName}){let{roleHelper:roleHelper}=this;return roleHelper.hasRole(scope,userId,roleName)}hasRoleInActivePublisher({scope:scope,userId:userId,roleName:roleName}){let{roleHelper:roleHelper}=this;return roleHelper.hasRoleInPublisher(scope.activePublisher,userId,roleName)}itemSelect({scope:scope,event:event}){let parent=$(event.target).parent();if(parent)return $(parent).hasClass("selected")?void $(parent).find(".expand-btn").trigger("click"):($(scope.$getDom()).find(".list-container .list-item").removeClass("selected"),void $(parent).addClass("selected"))}search({scope:scope,event:event,selector:selector,errMsg:errMsg}){let query,{listHelper:listHelper}=this;if(listHelper.navigateInItems(scope,event,{selector:selector,onSelect(event,item){!Q.$objectExist(item)&&Q.$isEmpty(item)||$(item).find(".expand-btn").trigger("click")},onNoItems(event){},onNewActive(event,item){}}),listHelper.isDirectionKey(event))return;listHelper.resetSuggIdx(scope);let wasEmpty;Q.$nonBlocking(()=>{if(Q.$functionExist(scope.onSearch)){query=Q.$stringExist(scope.query)?scope.query.trim():"";try{wasEmpty=!Q.$stringExist(query),scope.onSearch(query),setTimeout(_=>{(!wasEmpty&&!Q.$stringExist(query)||wasEmpty&&Q.$stringExist(query))&&scope.onSearch(query)},200)}catch(err){console.error(errMsg),console.error(err)}}},null,scope.$getScopeId())}}function commonItemRemoveConfirm({modal:modal,message:message,onConfirm:onConfirm,itemType:itemType}){Q.$stringExist(message)||(message="Please note that confirming this action will cause to all data "+`associated with this ${itemType} to be destroyed permanently.`+` Are you sure about removing this ${itemType}?`),modal.$enter("confirm-modal",{mainIcon:"far fa-trash-alt",message:message,confirmText:"Remove",confirmAfterIcon:"fas fa-check-circle",onConfirm:onConfirm})}$export(CommonListCtrFn),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class ConvertJob extends awr.Service{static get $require(){return{server:"service:serverCall",remoteCnf:"config:remoteConnection"}}constructor(){super(ConvertJob.$require)}create(docId,pdfId){let{server:server,remoteCnf:remoteCnf}=this;return server.$post({url:`${remoteCnf.serverURL}/api/ps_convert/${docId}/${pdfId}`,headers:{authorization:$import(`token:awr_app_token @decoder: base64:${remoteCnf.decoder}`)}})}}$export(ConvertJob),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;const months=["January","February","March","April","May","June","July","August","September","October","November","December"],days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],stDates=[1,21,31],ndDates=[2,22],rdDates=[3,23];class DateFormatter extends awr.Service{static get $require(){return{}}constructor(){super(DateFormatter.$require)}prettyDate(date,format){if(format=Q.$stringExist(format)?format:"short",Q.$stringExist(date)&&(date=new Date(date)),!(date&&date instanceof Date))return"invalid date";let day=days[date.getDay()],month=months[date.getMonth()],dateNum=date.getDate(),suffix=function(dateNum){let suffix="th";Q.$setContainsNumber(stDates,dateNum)?suffix="st":Q.$setContainsNumber(ndDates,dateNum)?suffix="nd":Q.$setContainsNumber(rdDates,dateNum)&&(suffix="rd");return suffix}(dateNum),time=function(hour,minute){let prettyTime="";hour>=1&&hour<12?prettyTime=`${hour}:${minute}am`:hour>12?prettyTime=`${hour-12}:${minute}pm`:12===hour?prettyTime=`12:${minute}pm`:0===hour&&(prettyTime=`12:${minute}am`);return prettyTime}(date.getHours(),date.getMinutes()),short=`${day} ${dateNum}${suffix} of ${month}, ${date.getFullYear()}`,medium=`${month} ${dateNum}${suffix}, ${date.getFullYear()}`;return"short"===format?short:"medium"===format?`${medium}`:"mediumWithTime"===format?`${medium} at ${time}`:`${short} at ${time}`}}$export(DateFormatter),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class DocFormDataPreparer extends awr.Service{static get $require(){return{}}constructor(){super(DocFormDataPreparer.$require)}prepare(scope,doc){doc.collection_id=Q.$numberExist(parseInt(doc.collection_id))?parseInt(doc.collection_id):null,doc.status=Q.$booleanTrue(doc.status)||1===parseInt(doc.status)?"published":"draft",doc.meta={print:[doc.print],designs:[doc.designs],meme:[doc.meme],authors:doc.authors,categories:doc.categories,languages:doc.languages,year:[doc.year]},doc.settings={allow_aggregating:[1===parseInt(doc.allow_aggregating)||Q.$booleanTrue(doc.allow_aggregating)]}}}$export(DocFormDataPreparer),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class DocScopeUtils extends awr.Service{static get $require(){return{router:"service:router"}}constructor(){super(DocScopeUtils.$require),this.$importSuperScope()}onDocRemoved(){let{superScope:superScope,router:router}=this;superScope.currentDoc=null,$emit("collection:events",{name:"new-doc-selected",doc:null}),router.$go("errors-view",{params:{code:"404"},attrs:{}},!0)}aboutCurrentDoc(scope,event){return Q.$objectExist(event.modelInstance)&&Q.$objectExist(scope.doc)&&Q.$idEqual(scope.doc.id,event.modelInstance.id)}getMaxVisiblePageNumber(scope){let maxVisiblePage=Q.$asCollection($(scope.$getDom()).find(".doc-page")).$reduce(elem=>$(elem).isInViewport()).$collect((collected,nxt)=>(collected=Q.$objectExist(collected)?collected:nxt,$(nxt).data("page-number")>$(collected).data("page-number")&&(collected=nxt),collected));return Q.$objectExist(maxVisiblePage)?$(maxVisiblePage).data("page-number"):null}docInCollection(collection,doc){return collection&&Q.$count(collection.stories,nxt=>Q.$idEqual(nxt.id,doc.id))>0}}$export(DocScopeUtils),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,modalEnterTime=($import("window:jQuery"),0);class GlobalFunctions extends awr.Service{static get $require(){return{remoteConfig:"config:remoteConnection",router:"service:router",authNextBuilder:"service:authNextBuilder",collectionFetcher:"service:collectionFetcher",base64:"service:uriBase64",myDoc:"model:MyDoc",modal:"service:modal",helper:"service:globalFnHelper"}}constructor(){super(GlobalFunctions.$require)}attach(scope){!function(scope,svcContext){let{remoteConfig:remoteConfig,router:router,authNextBuilder:authNextBuilder,collectionFetcher:collectionFetcher,base64:base64,myDoc:myDoc,modal:modal,helper:helper}=svcContext,hashPrefix=remoteConfig.isDevPort?"/#":"/";scope.isCollectionMyShelf=(collId=>{Q.$functionExist(scope.$preventDefault)&&scope.$preventDefault();let currentUser=scope.currentUser;return currentUser.main_series=currentUser&&!Q.$isEmpty(currentUser.main_series)?Q.$asCollection(currentUser.main_series):Q.$asCollection([]),currentUser.main_series.$count(nxt=>"my_shelf"===nxt.type&&nxt.series_id==collId)>0}),scope.$fn({scrollToTop(){scope.$preventDefault(),window.scrollTo(0,0)},redirectToAuth(view){scope.$preventDefault();let appNext,next,cmpEncoder,defaultInLink=`${hashPrefix}in/v?c=index`;appNext=authNextBuilder.getAppNextLink(router),next=authNextBuilder.getCleanAuthNext(remoteConfig,appNext,router,defaultInLink),cmpEncoder=authNextBuilder.getURIEncoder(),view=Q.$stringExist(view)&&"signUp"===view?"signup":"default",window.location=`${remoteConfig.serverURL}/insider${hashPrefix}auth?view=${view}&next=${cmpEncoder(next)}`},signOut(){scope.$preventDefault(),router.$destroyAuthSession({connectionConfig:$import("config:remoteConnection"),onEnterBusyMode(msg){(new Date).getTime();modalEnterTime=(new Date).getTime()+1e3,modal.$enter("smallNotifModal",{icon:"fas fa-circle-notch fa-spin",message:msg})},onExitBusyMode(){let now=(new Date).getTime();setTimeout(_=>{modal.$exit()},now<modalEnterTime?500:0)}})},openControls(){scope.$preventDefault(),router.$go("bookmarks-view",{params:{},attrs:{}},!0)},openPrinciples(){scope.$preventDefault();try{helper.findPrinciplesCollId().then(id=>{scope.openCollection(id)},err=>{console.error(err)})}catch(e){console.error(e)}},openMyCollections(){scope.$preventDefault();let{router:router}=this;router.$go("my-collections-view",{params:{cId:"index"},attrs:{}},!0)},openMyShelf(){scope.$preventDefault();let pivot=null;this.currentUser&&!Q.$isEmpty(this.currentUser.main_series)&&(pivot=Q.$asCollection(this.currentUser.main_series).$reduce(nxt=>"my_shelf"===nxt.type).$first()),Q.$objectExist(pivot)?this.openCollection(pivot.series_id):modal.$enter("smallNotifModal",{icon:"fa fa-exclamation-triangle text-warning",message:"My Shelf is not available. Please set your main collection first.",showRemove:!0})},openCollection(collId){scope.$preventDefault();let current,state=router.$getCurrentState();current=collectionFetcher.getCurrent(),Q.$exist(collId)&&(Q.$setContainsString(["default"],state.name)&&Q.$objectExist(current)&&current.id==collId||helper.firstDocDataInCollection(collId).then(data=>{router.$go("default",{params:{title:data.docTitle,docId:data.docId,page:"index"},attrs:{c:"index"}},!0)},err=>{Q.$stringExist(err)&&"empty"===err?router.$go("errors-view",{params:{code:"e1"},attrs:{}},!0):(console.error("PS: Failed to open collection"),console.error(err))}))},openDoc(docId,docTitle){scope.$preventDefault();let state=router.$getCurrentState();Q.$exist(docId)&&(state&&"default"===state.name&&Q.$objectExist(scope.currentDoc)&&Q.$idEqual(scope.currentDoc.id,docId)||(docTitle=Q.$stringExist(docTitle)?encodeURIComponent(docTitle.toLowerCase().replace(/\s/g,"_")):"no_title",docId=base64.encode(docId),router.$go("default",{params:{title:docTitle,docId:docId,page:"index"},attrs:{c:"index"}},!0)))},addDoc(cId){scope.$preventDefault(),Q.$exist(cId)&&(cId=base64.encode(cId),router.$go("upload-doc-view",{params:{cId:cId},attrs:{}},!0))},editDoc(docId){scope.$preventDefault(),Q.$exist(docId)&&(docId=base64.encode(docId),router.$go("edit-view",{params:{docId:docId},attrs:{}},!0))},removeDoc(docId){scope.$preventDefault(),Q.$numberExist(docId)&&!Q.$stringExist(docId)&&modal.$enter("confirmModal",{icon:"fas fa-exclamation-triangle text-warning",title:"Remove document",message:"Are you sure about removing this document?",confirmText:"Remove",cancelText:"Cancel",confirmBtnClass:"btn btn-danger",onConfirm(){let doc=myDoc.$template({id:docId});modal.$enter("smallNotifModal",{icon:"fas fa-circle-notch fa-spin",message:"Removing..."}),setTimeout(_=>{doc.$remove().then(res=>{modal.$exit()},err=>{modal.$enter("smallNotifModal",{icon:"fa fa-exclamation-triangle text-warning",message:"We are sorry but document removal failed. Please try again later!",showRemove:!0}),console.error(err)})},500)}})}})}(scope,this)}}$export(GlobalFunctions),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class ListHelper extends awr.Service{static get $require(){return{}}constructor(){super(ListHelper.$require)}isDirectionKey(event){return event&&Q.$setContainsNumber([40,39,38,37,13],event.keyCode)}resetSuggIdx(scope){let params=scope.$getParams();params&&Q.$objectExist(params.listHelper)&&(params.listHelper.suggIdx=-1)}loadMore(scope,{maxItems:maxItems,loadedSizeKey:loadedSizeKey,getList:getList,onNoMore:onNoMore,onItemLoad:onItemLoad}){if(!Q.$objectExist(scope)||!Q.$functionExist(getList))return;loadedSizeKey=Q.$stringExist(loadedSizeKey)?loadedSizeKey:"loadedItemSize";let loadedItems,list=Q.$asCollection(getList());maxItems=Q.$numberExist(maxItems)?maxItems:20,loadedItems=Q.$numberExist(scope[loadedSizeKey])?scope[loadedSizeKey]:maxItems,list.$isEmpty()?Q.$functionExist(onNoMore)&&onNoMore():(list=list.$skip(loadedItems).$take(maxItems),scope[loadedSizeKey]+=maxItems,Q.$functionExist(onItemLoad)&&list.$each(nxt=>{onItemLoad(nxt)}),list.$isEmpty()&&Q.$functionExist(onNoMore)&&onNoMore())}navigateInItems(scope,event,{selector:selector,onNoItems:onNoItems,onSelect:onSelect,onNewActive:onNewActive}){if(!Q.$objectExist(scope))return;Q.$objectExist(scope.$getParams().listHelper)||(scope.$getParams().listHelper={});let params=scope.$getParams().listHelper,isDown=event&&40===event.keyCode,suggItems=$(scope.$getDom()).find(selector);params.suggIdx=Q.$numberExist(params.suggIdx)?params.suggIdx:-1,params.suggIdx=isDown?params.suggIdx+1:params.suggIdx-1,!event||13!==event.keyCode&&39!==event.keyCode?!event||38!==event.keyCode&&40!==event.keyCode||(Q.$isEmpty(suggItems)?Q.$functionExist(onNoItems)&&onNoItems(event):(params.suggIdx>=$(suggItems).length&&(params.suggIdx=$(suggItems).length-1),params.suggIdx<0&&(params.suggIdx=0),$(suggItems).removeClass("selected"),$(suggItems[params.suggIdx]).addClass("selected"),Q.$functionExist(onNewActive)&&onNewActive(event,$(suggItems[params.suggIdx])))):Q.$functionExist(onSelect)&&onSelect(event,$(suggItems[params.suggIdx+1]))}}$export(ListHelper),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class ListSectionEventBinder extends awr.Service{static get $require(){return{roleModel:"model:Role",publisherRoleModel:"model:PublisherRole"}}constructor(){super(ListSectionEventBinder.$require)}bindWithPublisherRoleEvents(scope){scope.$bind("model:PublisherRole",{onEvent(event,preventDefault){if(preventDefault(),!Q.$objectExist(event))return;let roleName,roleList,convertedModelInstance,listEnv=scope.$findProperty("listEnvName"),activePublisher=scope.$findProperty("activePublisher"),{modelInstance:modelInstance,requestType:requestType}=event;"user"===scope.listType&&"publishers"===listEnv&&Q.$objectExist(activePublisher)&&Q.$objectExist(modelInstance)&&Q.$setContainsString(["create","remove"],requestType)&&(roleName=modelInstance.name,activePublisher.moderators=Q.$asCollection(Q.$isEmpty(activePublisher.moderators)?[]:activePublisher.moderators),activePublisher.creators=Q.$asCollection(Q.$isEmpty(activePublisher.creators)?[]:activePublisher.creators),roleList="moderator"===roleName?activePublisher.moderators:activePublisher.creators,(convertedModelInstance=Q.$objectExist(modelInstance.user)?modelInstance.user:{}).role_id=modelInstance.id,convertedModelInstance.role_name=modelInstance.name,"create"===event.requestType?(roleList.push(convertedModelInstance),roleList=roleList.$unique("id")):roleList=roleList.$reduce(nxt=>parseInt(nxt.role_id)!==parseInt(modelInstance.id)),"moderator"===roleName?activePublisher.moderators=roleList:activePublisher.creators=roleList,scope.$getAllSegments().$each(nxt=>{parseInt(nxt.dataContext.id)===parseInt(event.modelInstance.user_id)&&nxt.$update()}))}})}bindWithRoleEvents(scope){scope.$bind("model:Role",{onEvent(event,preventDefault){preventDefault();let listEnv=scope.$findProperty("listEnvName");"user"===scope.listType&&"users"===listEnv&&event&&event.modelInstance&&Q.$setContainsString(["create","remove"],event.requestType)&&scope.$getAllSegments().$each(nxt=>{parseInt(nxt.dataContext.id)===parseInt(event.modelInstance.user_id)&&(nxt.dataContext.roles=Q.$asCollection(Q.$isEmpty(nxt.dataContext.roles)?[]:nxt.dataContext.roles),"create"===event.requestType?nxt.dataContext.roles.push(event.modelInstance):nxt.dataContext.roles=nxt.dataContext.roles.$reduce(nxtRole=>parseInt(nxtRole.id)!==parseInt(parseInt(event.modelInstance.id))),nxt.$update())})}})}}$export(ListSectionEventBinder),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class PsDocCreator extends awr.Service{static get $require(){return{myDocModel:"model:MyDoc",fileUploader:"service:fileUploader",convertJob:"service:convertJob"}}constructor(){super(PsDocCreator.$require)}create(scope,doc,files){let{myDocModel:myDocModel,fileUploader:fileUploader,convertJob:convertJob}=this;return async function({scope:scope,doc:doc,model:model,uploader:uploader,files:files,convertJob:convertJob}){let docInstance,uploadResult,pdfId,convertResult;if(scope.newInstance=null,$(scope.$getDom()).find(".working .msg").text("Initializing new document"),docInstance=await model.$create(doc),scope.newInstance=docInstance,$(scope.$getDom()).find(".working .msg").text("Uploading files"),uploadResult=await uploader.upload({path:`/api/story_attachment/${docInstance.id}`,fileKey:"attachment",files:files}),pdfId=Q.$isEmpty(uploadResult)?null:Q.$asCollection(uploadResult).$map(nxt=>{if("success"===nxt.status&&nxt.mime&&nxt.mime.indexOf("application/pdf")>=0)return parseInt(nxt.file_id)}).$first(),!Q.$numberExist(pdfId))throw new Error("Bad pdf file id");return $(scope.$getDom()).find(".working .up-item").text(""),$(scope.$getDom()).find(".working .msg").text("Creating a convert job"),convertResult=await convertJob.create(docInstance.id,pdfId),{docId:docInstance.id,pdfId:pdfId,convertResult:convertResult}}({scope:scope,doc:doc,files:files,model:myDocModel,uploader:fileUploader,convertJob:convertJob})}}$export(PsDocCreator),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class TagSubSuggestions extends awr.Service{static get $require(){return{autocomplete:"service:autocomplete",listHelper:"service:listHelper"}}constructor(){super(TagSubSuggestions.$require)}applySuggestions(scope,suggs=[]){let el,manager=this,container=$(scope.$getDom()).find(".suggestion-items .container");if($(container).html(""),Q.$isEmpty(suggs))return scope.selectedName=null,void(scope.suggIdx=-1);Q.$each(suggs,nxt=>{el=manager.makeSuggItem(nxt),$(container).append($(el))}),$(container).find(".search-suggestion").on("click",function(event){scope.selectedName=$(this).data("name"),event.keyCode=13,manager.navigateInSuggestions(scope,event)})}navigateInSuggestions(scope,event){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();let{listHelper:listHelper}=this;listHelper.navigateInItems(scope,event,{selector:".tag-subscription.search-suggestion",onSelect(event,item){scope.newTagName=scope.selectedName,scope.selectedName=null,$(scope.$getDom()).find('.tag-search .sf-group input[type="text"]').val(scope.newTagName),$(scope.$getDom()).find(".tag-search .suggestion-items .container").html("")},onNoItems(event){scope.selectedName=null},onNewActive(event,item){scope.selectedName=$(item).data("name")}})}makeSuggItem(name){return`<div class="tag-subscription search-suggestion" data-name="${name}">\n                    <div class="item">\n                        ${name}\n                    </div>\n                </div>`}}$export(TagSubSuggestions),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class UserPublisherVarsConfigurer extends awr.Service{static get $require(){return{roleHelper:"service:roleHelper",hasRoleInPubPipe:"pipe:hasRoleInPublisher",router:"service:router",base64:"service:uriBase64"}}constructor(){super(UserPublisherVarsConfigurer.$require),Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}setupWhenData(scope){let{superScope:superScope,roleHelper:roleHelper,hasRoleInPubPipe:hasRoleInPubPipe,router:router,base64:base64}=this,{users:users,publishers:publishers}=scope;superScope.cachedPublishers=publishers,superScope.cachedUsers=users,scope._publishers=publishers,scope._users=publishers,Object.defineProperty(this,"publishers",{set(value){scope._publishers=value},get:()=>Q.$arrayExist(superScope.cachedPublishers)?superScope.cachedPublishers:scope._publishers,configurable:!0}),Object.defineProperty(this,"users",{set(value){scope._users=value},get:()=>Q.$arrayExist(superScope.cachedUsers)?superScope.cachedUsers:scope._users,configurable:!0})}setup(scope){let{superScope:superScope,roleHelper:roleHelper,hasRoleInPubPipe:hasRoleInPubPipe,router:router,base64:base64}=this,{users:users,publishers:publishers}=scope;Object.defineProperty(scope,"list",{get:()=>Q.$setContainsString(["t1","t3"],scope.tabId)?scope.users:"t4"===scope.tabId?Q.$asCollection([]):scope.publishers}),Object.defineProperty(scope,"listType",{get:()=>Q.$setContainsString(["t1","t3"],scope.tabId)?"user":"t4"===scope.tabId?"new-publisher":"publisher"}),Object.defineProperty(scope,"listEnvName",{get:()=>Q.$setContainsString(["t2","t3"],scope.tabId)?"publishers":"t4"===scope.tabId?"new-publisher":"users"}),Object.defineProperty(scope,"searchPlaceholder",{get:()=>"user"===scope.listType?"Search for users":"Search for publishers"}),Object.defineProperty(scope,"currentUser",{get:()=>Q.$objectExist(superScope)&&Q.$objectExist(superScope.currentUser)?superScope.currentUser:null}),Object.defineProperty(scope,"currentUserId",{get:()=>Q.$objectExist(superScope)&&Q.$objectExist(superScope.currentUser)?superScope.currentUser.id:""}),Object.defineProperty(scope,"assignee",{get(){let state=router.$getCurrentState(),aid=state&&state.attrs?state.attrs.aid:null;return aid="cr"!==aid&&Q.$numberExist(parseInt(base64.decode(aid)))?parseInt(base64.decode(aid)):aid,Q.$numberExist(parseInt(aid))?Q.$reduce(Q.$isEmpty(scope.users)?[]:scope.users,nxt=>parseInt(nxt.id)===parseInt(aid)).$first():scope.currentUser}}),Object.defineProperty(scope,"assigneeId",{get:()=>Q.$objectExist(scope.assignee)?scope.assignee.id:null}),Object.defineProperty(scope,"isCurrentAdminInActivePub",{get:()=>roleHelper.isAdminInPublisher(scope.activePublisher,scope.currentUserId)}),Object.defineProperty(scope,"isCurrentAdmin",{get:()=>roleHelper.isPSAdminOrHigher(scope,scope.currentUserId)}),Object.defineProperty(scope,"currentHasMyPublisher",{get:()=>hasRoleInPubPipe.transform(scope.publishers,scope.currentUserId,"any").length>0}),Object.defineProperty(scope,"activePubHasCreators",{get:()=>scope.activePublisher&&!Q.$isEmpty(scope.activePublisher.creators)}),Object.defineProperty(scope,"activePubHasModerators",{get:()=>scope.activePublisher&&!Q.$isEmpty(scope.activePublisher.moderators)}),Object.defineProperty(scope,"activePubHasDesc",{get:()=>scope.activePublisher&&Q.$stringExist(scope.activePublisher.description)}),Object.defineProperty(scope,"defaultListReduceFn",{get(){return"t3"!==scope.tabId?nxt=>!0:nxt=>roleHelper.hasRoleInPublisher(this.activePublisher,nxt.id,"any")}}),Object.defineProperty(scope,"showAdminActions",{get:()=>"users"===scope.listEnvName&&scope.isCurrentAdmin}),Object.defineProperty(scope,"showOrgAdminActions",{get:()=>"publishers"===scope.listEnvName&&scope.isCurrentAdminInActivePub}),Object.defineProperty(scope,"showEmptyActionsPlaceholder",{get:()=>"publishers"===scope.listEnvName&&!scope.showOrgAdminActions||"users"===scope.listEnvName&&!scope.showAdminActions}),Object.defineProperty(scope,"showSearch",{get:()=>"t4"!==scope.tabId&&("t3"!==scope.tabId||scope.currentHasMyPublisher)}),Object.defineProperty(scope,"showListSection",{get:()=>!(!scope.isDataFetchReady||"t4"===scope.tabId)&&("t3"!==scope.tabId||scope.currentHasMyPublisher)}),Object.defineProperty(scope,"showNewPublisherForm",{get:()=>scope.isDataFetchReady&&"t4"===scope.tabId})}}$export(UserPublisherVarsConfigurer),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class DataFetcher extends awr.FactoryType{static get $require(){return{router:"service:router"}}constructor(){super(DataFetcher.$require),this.listenerIdSuffix="DataFetcher",this.recompileOnResolve=!1}init(){}static[$abstract("isDataFetchReady")](){}static[$abstract("fetch")](){}static[$abstract("onResolve")](){}static[$abstract("onReject")](){}stateCheck(scope,state){return!0}setup(scope){}scopeBinds(scope){}setupAndFetch(scope){let self=this,{router:router}=this;if(!scope.$isFlushed()&&this.stateCheck(scope,router.$getCurrentState())){if(Object.defineProperty(scope,"isDataFetchReady",{get:()=>self.isDataFetchReady(scope,self.router.$getCurrentState())}),this.setup(scope),scope.isDataFetchReady&&Q.$functionExists(scope.onDataReady))try{scope.onDataReady()}catch(e){console.error(e)}scope.$ready(_=>{scope.isDataFetchReady||this.fetch(scope,this.router.$getCurrentState()).then(res=>{if(!scope.$isFlushed()){if(this.onResolve(scope,res),scope.isDataFetchReady&&Q.$functionExists(scope.onDataReady))try{scope.onDataReady()}catch(e){console.error(e)}this.recompileOnResolve&&scope.$recompile()}},err=>{scope.$isFlushed()||this.onReject(scope,err)})},`onReady@${this.listenerIdSuffix}`),this.scopeBinds(scope)}}}$export(DataFetcher),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class Epub extends awr.Validator{static get $require(){return{}}constructor(){super(Epub.$require)}isValid(val,elem){return!(Q.$objectExist(val)&&val instanceof FileList&&val.length>0)||val[0].type&&val[0].type.indexOf("application/epub")>=0}}$export(Epub),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class OptionalUrl extends awr.Validator{static get $require(){return{urlValidator:"validator:url"}}constructor(){super(OptionalUrl.$require)}isValid(val,elem){return!Q.$stringExist(val)||this.urlValidator.isValid(val,null)}}$export(OptionalUrl),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class Pdf extends awr.Validator{static get $require(){return{}}constructor(){super(Pdf.$require)}isValid(val,elem){return!!(Q.$objectExist(val)&&val instanceof FileList&&val.length>0)&&(val[0].type&&val[0].type.indexOf("application/pdf")>=0)}}$export(Pdf),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class BookList extends awr.Component{static get $require(){return{}}constructor(){super(BookList.$require),this.template="app/components/book-list/book-list.hbs",this.controller="BookList",this.scope={items:"="}}}$export(BookList),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class BookList extends awr.Controller{static get $require(){return{modal:"service:modal"}}constructor(data,parent){super(BookList.$require,data,parent)}removeSelected(){this.$preventDefault();let segment,{modal:modal,selected:selected}=this,scope=this,parent=this.$getParent();Q.$objectExist(selected)&&(segment=this.$getAllSegments().$reduce(nxt=>nxt.dataContext.id===selected.id).$first(),modal.$enter("confirm-modal",{mainIcon:"far fa-trash-alt",message:"Are you sure you want to remove the item from saved list?",confirmText:"Remove",confirmAfterIcon:"fas fa-check-circle",onConfirm(){segment&&$(segment.$getDom()).animate({width:["hide","swing"],height:["hide","swing"],opacity:"0.1"},700,"linear",()=>{}),scope.selected=null,$(scope.$getDom()).find(".actions .action-item.remove").removeClass("on"),Q.$functionExist(parent.removeItem)&&parent.removeItem(selected)}}))}selectItem(){this.$preventDefault(),this.$segment&&Q.$objectExist(this.$segment.dataContext)&&(this.$getAllSegments().$each(nxt=>{$(nxt.$getDom()).removeClass("selected")}),$(this.$getDom()).find(".actions .action-item.remove").removeClass("on"),Q.$objectExist(this.selected)&&this.selected.id===this.$segment.dataContext.id?this.selected=null:(this.selected=this.$segment.dataContext,$(this.$segment.$getDom()).addClass("selected"),$(this.$getDom()).find(".actions .action-item.remove").addClass("on")))}}$export(BookList),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class CollectionList extends awr.Component{static get $require(){return{}}constructor(){super(CollectionList.$require),this.controller="CollectionList",this.template="app/components/collection-list/collection-list.hbs",this.scope={collections:"=",activePublisherId:"="}}}$export(CollectionList),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class CollectionList extends awr.Controller{static get $require(){return{myCollModel:"model:MyCollection",mainCollModel:"model:MainCollection",superScope:"object:awr.superScope",listHelper:"service:listHelper",pubCollsPipe:"pipe:publisherCollections"}}constructor(data,parent){super(CollectionList.$require,data,parent);let{myCollModel:myCollModel,superScope:superScope}=this;this.collections=this.collections.$sortBy("created_at","date"),this.maxItems=20,this.loadedItems=this.maxItems,this.$getParent().listScope=this,Object.defineProperty(this,"hasMoreItems",{get(){let list=getCurrentList(this);return this.loadedItems<list.length}})}addNewItem(item){Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),item.inEdit=!0,this.collections.reverse(),this.collections.push(item),this.collections.reverse(),this.loadedItems++,this.loadedItems>this.collections.length&&(this.loadedItems=this.collections.length),this.$prepend({selector:"table tbody",dataContext:item,segment:"cItem"}),this.$getDom().find(".content").removeClass("busy"),$(this.$getDom()).find("tbody tr.push-tr").remove(),$(this.$getDom()).find("tbody").prepend('<tr class="push-tr">\n                <td>\n                    <span>#</span>\n                </td>\n            </tr>')}loadMore(event){this.$preventDefault();let{listHelper:listHelper}=this,scope=this;listHelper.loadMore(this,{maxItems:scope.maxItems,loadedSizeKey:"loadedItems",getList:()=>getCurrentList(scope),onNoMore(){$(scope.$getDom()).find(".list-actions button.load-more").addClass("hidden")},onItemLoad(item){scope.$append({selector:".content table.items tbody",dataContext:item,segment:"cItem"})}})}toggleEdit(event){this.$preventDefault(),this.$segment.dataContext.inEdit=!this.$segment.dataContext.inEdit,this.$segment.$update()}remove(){this.$preventDefault();let item,scope=this,parent=this.$getParent(),segment=scope.$segment;scope.$getDom().find(".content").addClass("busy"),$(segment.$getDom()).animate({width:["hide","swing"],height:["hide","swing"],opacity:"0.1"},700,"linear",()=>{(item=segment.dataContext).$remove().then(_=>{segment.$remove(),scope.$getDom().find(".content").removeClass("busy"),parent.collections=parent.collections.$reduce(nxt=>nxt.id!==item.id),scope.collections=parent.collections,scope.loadedItems--,scope.loadedItems<0&&(scope.loadedItems=0)},err=>{console.error(err),scope.$getDom().find(".content").removeClass("busy")})})}checkKey(event){this.$preventDefault(),event&&13===event.keyCode&&this.saveName()}saveName(){this.$preventDefault();let origName,scope=this,segment=scope.$segment,item=segment.dataContext,editName=item.editName;item.inEdit=!1,Q.$stringExist(editName)&&item&&Q.$functionExist(item.$save)?(origName=item.name,item.name=editName,scope.$getDom().find(".collection-list .content").addClass("busy"),item.$save().then(res=>{scope.$getDom().find(".collection-list .content").removeClass("busy")},err=>{console.error(err),item.name=origName,item.editName=item.name,setTimeout(_=>{segment.$update(),scope.$getDom().find(".collection-list .content").removeClass("busy")},500)})):item.editName=item.name,segment.$update()}toggleIsMain(event){this.$preventDefault();let mainSeries,instData,{mainCollModel:mainCollModel,superScope:superScope}=this,segment=this.$segment;Q.$booleanTrue(this.isToggleMainBusy)||(this.isToggleMainBusy=!0,superScope.isCollectionMyShelf(segment.dataContext.id)?(instData=(mainSeries=superScope.currentUser.main_series).$reduce(nxt=>nxt.id==segment.dataContext.id).$first(),superScope.currentUser.main_series=mainSeries.$reduce(nxt=>nxt.series_id!==segment.dataContext.id),segment.$update(),mainCollModel.$template(instData).$remove().then(_=>{this.isToggleMainBusy=!1},err=>{this.isToggleMainBusy=!1,console.error(err)})):(superScope.currentUser.main_series=superScope.currentUser.main_series.$reduce(nxt=>"my_shelf"!==nxt.type),this.$getAllSegments().$each(nxt=>{nxt.dataContext.currentIsMyShelf&&nxt.$update()}),$(segment.$getDom()).find(".c-item.d-toggle").addClass("checked"),mainCollModel.$create({type:"my_shelf",series_id:segment.dataContext.id}).then(newInst=>{superScope.currentUser.main_series.push(newInst),segment.$update(),this.isToggleMainBusy=!1},err=>{this.isToggleMainBusy=!1,console.error(err)})))}}function getCurrentList(scope){let{pubCollsPipe:pubCollsPipe}=scope,userId=scope.$findProperty("currentUserId"),publishers=scope.$findProperty("publishers");return pubCollsPipe.transform(scope.collections,scope.activePublisherId,userId,publishers).$sortBy("created_at","date")}$export(CollectionList),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class DocReader extends awr.Component{static get $require(){return{}}constructor(){super(DocReader.$require),this.controller="DocReader",this.template="app/components/doc-reader/doc-reader.hbs",this.scope={doc:"="}}}$export(DocReader),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q,$import("window:jQuery");class DocReader extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope",initializer:"service:docReaderInit",methods:"service:docReaderMethods"}}constructor(data,parent){super(DocReader.$require,data,parent);let{initializer:initializer}=this;this.$disableDefaultActionAutoRecompile(),initializer.init(this)}loadPreviousPages(){let{methods:methods}=this;methods.loadPreviousPages({scope:this})}imageLoaded(event){let{methods:methods}=this;methods.imageLoaded({scope:this,event:event})}toggleLeftActions(event){let{methods:methods}=this;methods.toggleLeftActions({scope:this,event:event})}togglePageMenu(event){let{methods:methods}=this;methods.togglePageMenu({scope:this,event:event})}}$export(DocReader),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class InvitedList extends awr.Component{static get $require(){return{}}constructor(){super(InvitedList.$require),this.template="app/components/invited-list/invited-list.hbs",this.controller="InvitedList",this.scope={invites:"="}}}$export(InvitedList),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class InvitedList extends awr.Controller{static get $require(){return{}}constructor(data,parent){super(InvitedList.$require,data,parent)}}$export(InvitedList),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class ListSection extends awr.Component{static get $require(){return{}}constructor(){super(ListSection.$require),this.template="app/components/list-section/list-section.hbs",this.controller="ListSection",this.scope={list:"=",listType:"="}}}$export(ListSection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let currentQuery,awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery"),lastRecTime=0,painting=!1;class ListSection extends awr.Controller{static get $require(){return{fieldSearchPipe:"pipe:fieldSearch",listHelper:"service:listHelper",eventBinder:"service:listSectionEventBinder",searchCache:"service:searchCache"}}constructor(data,parent){super(ListSection.$require,data,parent);let{fieldSearchPipe:fieldSearchPipe,eventBinder:eventBinder,searchCache:searchCache}=this,hasMore=()=>{let lSym=Symbol.for("lastSearchResultLength"),length=Q.$numberExist(this.list[lSym])?Math.min(this.list[lSym],this.list.length):this.list.length;return this.loadedItems<length};currentQuery=this.query,this.isReady=!1,this.maxItems=20,this.lastComputedList=computeScopeList(this),this.loadedItems=Math.min(this.maxItems,this.lastComputedList.length),eventBinder.bindWithRoleEvents(this),eventBinder.bindWithPublisherRoleEvents(this),Object.defineProperty(this,"hasMoreItems",{get(){let res=hasMore();return setTimeout(_=>{res!==hasMore()&&(res=hasMore(),$(this.$getDom()).find(".list-actions button.load-more").toggleClass("hidden",!res))},250),res}}),this.$getParent().onSearch=(query=>{if(currentQuery===query)return;currentQuery=query;let res,now,defaultListReduceFn,listType,parent,tabId,cacheName,partialList,lSym=Symbol.for("lastSearchResultLength"),partialQuery=Q.$stringExist(query)?query.toLowerCase():query;if(parent=this.$getParent(),this.list=parent.$findProperty("list"),partialList=this.list,defaultListReduceFn=parent.$findProperty("defaultListReduceFn"),listType=parent.$findProperty("listType"),tabId=parent.$findProperty("tabId"),this.query=query,now=(new Date).getTime(),cacheName=`${listType}:list-results`,searchCache.inCache(cacheName,query.toLowerCase()))res=searchCache.getFromCache(cacheName,query.toLowerCase());else{for(;Q.$stringExist(partialQuery)&&!searchCache.inCache(cacheName,partialQuery);)partialQuery=partialQuery.substring(0,partialQuery.length-1);Q.$stringExist(partialQuery)&&searchCache.inCache(cacheName,partialQuery)&&(partialList=searchCache.getFromCache(cacheName,partialQuery)),res=fieldSearchPipe.transform(partialList,this.query,"name",defaultListReduceFn),searchCache.putInCache(cacheName,query.toLowerCase(),res)}this.loadedItems=Math.min(this.maxItems,res.length),this.list[lSym]=res.length,setTimeout(_=>{Q.$booleanTrue(painting)||(painting=!0,lastRecTime=(new Date).getTime()+500,$(this.$getDom()).find(".list-container").html(""),res.$take(this.maxItems).$each(nxt=>{this.$append({selector:".list-container",dataContext:nxt,segment:"publisher"===listType?"publisherItem":"userItem"})}),$(this.$getDom()).find(".list-actions .load-more").toggleClass("hidden",!this.hasMoreItems),$(this.$getDom()).find(".list-label").toggleClass("hidden","t3"===tabId&&Q.$stringExist(query)),painting=!1)},now<lastRecTime?500:0)}),this.$getParent().onListRefresh=(()=>{this.list=this.$getParent().list;let cleanList=computeScopeList(this);(function(a,b){if(Q.$isEmpty(a)&&Q.$isEmpty(b))return!0;if(Q.$isEmpty(a)||Q.$isEmpty(b))return!1;if(a.length!==b.length)return!1;let equal=!0;return Q.$each(a,nxt=>{b.$count(bNxt=>bNxt.id!==nxt.id)>0&&(equal=!1)}),equal})(cleanList,this.lastComputedList)||(this.lastComputedList=cleanList,this.loadedItems=Math.min(this.maxItems,this.lastComputedList.length),this.$recompile())}),this.$ready(_=>{Q.$booleanTrue(this.isReady)||(this.isReady=!0,this.$recompile())}),this.hasRole=((userId,roleName)=>this.$getParent().hasRole.apply(this.$getParent(),[userId,roleName])),this.hasRoleInActivePublisher=((userId,roleName)=>this.$getParent().hasRoleInActivePublisher.apply(this.$getParent(),[userId,roleName]))}loadMore(event){this.$preventDefault();let{listHelper:listHelper,fieldSearchPipe:fieldSearchPipe}=this,scope=this;listHelper.loadMore(this,{maxItems:scope.maxItems,loadedSizeKey:"loadedItems",getList:()=>(scope.lastComputedList=computeScopeList(scope),scope.lastComputedList),onNoMore(){$(scope.$getDom()).find(".list-actions button.load-more").addClass("hidden")},onItemLoad(item){scope.$append({selector:".list-container",dataContext:item,segment:"user"===scope.listType?"userItem":"publisherItem"})}})}toggleExpand(){Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),Q.$objectExist(this.$segment)&&Q.$objectExist(this.$segment.dataContext)&&(this.$segment.dataContext.isExpanded=!this.$segment.dataContext.isExpanded,this.$segment.$update())}itemSelect(event){Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.$getParent().itemSelect.call(this.$getParent(),event)}}function computeScopeList(scope){let{fieldSearchPipe:fieldSearchPipe}=scope;return fieldSearchPipe.transform(scope.list,scope.$findProperty("query"),"name",scope.$findProperty("defaultListReduceFn"))}$export(ListSection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class TagsSection extends awr.Component{static get $require(){return{}}constructor(){super(TagsSection.$require),this.template="app/components/tags-section/tags-section.hbs",this.controller="TagsSection",this.scope={tags:"="}}}$export(TagsSection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class TagsSection extends awr.Controller{static get $require(){return{autocomplete:"service:autocomplete",suggSvc:"service:tagSubSuggestions",model:"model:TagSubscription",listHelper:"service:listHelper",superScope:"object:awr.superScope"}}constructor(data,parent){super(TagsSection.$require,data,parent),this.newTagName="",this.isSearchBusy=!1,this.selectedName=null,this.isSubscribeBusy=!1,this.tagSearchData={actionsBusy:!1},this.maxItems=20,this.loadedItems=this.maxItems,this.filterName="all",this.filterReduce=(nxt=>"all"===this.filterName||nxt.type===this.filterName),Object.defineProperty(this,"hasMoreItems",{get(){return this.loadedItems<Q.$asCollection(this.tags).$reduce(this.filterReduce).length}})}filter(type){this.$preventDefault(),type&&type!==this.filterName&&Q.$setContainsString(["whitelist","blacklist","all"],type)&&(this.filterName=type,this.loadedItems=this.maxItems,this.$recompile())}remove(id){if(this.$preventDefault(),!Q.$objectExist(this.$segment))return;let dataContext,{superScope:superScope}=this,segment=this.$segment;$(segment.$getDom()).animate({width:["hide","swing"],height:["hide","swing"],opacity:"0.1"},700,"linear",()=>{(dataContext=segment.dataContext).$remove().then(_=>{this.tags=Q.$reduce(Q.$isEmpty(this.tags)?[]:this.tags,nxt=>!Q.$idEqual(dataContext.id,nxt.id)),superScope.cachedTags=this.tags,segment.$remove()},err=>{console.error(err)})})}subscribe(tagName,type){this.$preventDefault();let tmp,segment,{model:model,superScope:superScope}=this;Q.$stringExist(tagName)&&Q.$setContainsString(["blacklist","whitelist"],type)&&(Q.$booleanTrue(this.isSubscribeBusy)||(this.tags.$count(nxt=>nxt.name&&nxt.name.toLowerCase()===tagName.toLowerCase())?setTimeout(_=>{this.setAsNotBusy(),$(this.$getDom()).find(".already-exists.ntf-item").addClass("on"),setTimeout(_=>{$(this.$getDom()).find(".already-exists.ntf-item").removeClass("on")},2e3)},200):(this.isSubscribeBusy=!0,tmp=model.$template({name:tagName,type:type}),this.$prepend({selector:".tag-items",dataContext:tmp,segment:"tagSubscription"}),setTimeout(_=>{this.setAsBusy(),model.$create(tmp.$getData()).then(instance=>{Q.$arrayExists(this.tags)||(this.tags=Q.$asCollection([])),this.tags.push(instance),superScope.cachedTags=this.tags,segment=getSegmentByDataKey(this,"name",instance.name),Q.$objectExist(segment)&&segment.$upgrade(instance),this.setAsNotBusy()},err=>{console.error(err),this.setAsNotBusy(),segment=getSegmentByDataKey(this,"name",tmp.name),Q.$objectExist(segment)&&$(segment.$getDom()).addClass("failed")})},200))))}loadMore(event){this.$preventDefault();let{listHelper:listHelper}=this,scope=this;listHelper.loadMore(this,{maxItems:scope.maxItems,loadedSizeKey:"loadedItems",getList:()=>Q.$asCollection(scope.tags).$reduce(scope.filterReduce),onNoMore(){$(scope.$getDom()).find(".bottom-actions button.load-more").addClass("hidden")},onItemLoad(item){scope.$append({selector:".tag-items",dataContext:item,segment:"tagSubscription"})}})}search(event){this.$preventDefault();let{autocomplete:autocomplete,listHelper:listHelper}=this;if(event&&Q.$setContainsNumber([38,39,40,13],event.keyCode))this.suggSvc.navigateInSuggestions(this,event);else if(Q.$stringExist(this.newTagName)){if(!this.isSearchBusy){if(this.isSearchBusy=!0,this.selectedName=null,listHelper.resetSuggIdx(this),Q.$stringExist(this.newTagName)&&1===this.newTagName.length&&event&&8===event.keyCode)return this.isSearchBusy=!1,void this.suggSvc.applySuggestions(this,[]);autocomplete.search(this.newTagName).then(res=>{this.isSearchBusy=!1,this.suggSvc.applySuggestions(this,res)},err=>{console.error(err),this.isSearchBusy=!1,this.suggSvc.applySuggestions(this,[])})}}else this.suggSvc.applySuggestions(this,[])}setAsBusy(){this.reset(),this.isSubscribeBusy=!0,this.$getAllSegments().$each(nxt=>{nxt.dataContext&&nxt.dataContext.isTagSearch&&(nxt.dataContext.actionsBusy=!0,nxt.$update())})}setAsNotBusy(){this.reset(),this.isSubscribeBusy=!1,this.$getAllSegments().$each(nxt=>{nxt.dataContext&&nxt.dataContext.isTagSearch&&(nxt.dataContext.actionsBusy=!1,nxt.$update())})}reset(){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();let{listHelper:listHelper}=this;this.newTagName="",this.isSearchBusy=!1,this.selectedName=null,this.isSubscribeBusy=!1,listHelper.resetSuggIdx(this),$(this.$getDom()).find(".tag-search .suggestion-items").html(""),$(this.$getDom()).find('.tag-search .sf-group input[type="text"]').val(this.newTagName),$(this.$getDom()).find(".tags-section").removeClass("in-search")}}function getSegmentByDataKey(scope,key,value){return scope.$getAllSegments().$reduce(nxt=>nxt.dataContext&&nxt.dataContext[key]&&nxt.dataContext[key]===value).$first()}$export(TagsSection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class DocForm extends awr.Component{static get $require(){return{}}constructor(){super(DocForm.$require),this.template="app/forms/doc-form/doc-form.hbs",this.controller="DocForm",this.scope={collectionId:"=",collections:"=",publishers:"="}}}$export(DocForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class DocForm extends awr.Controller{static get $require(){return{formActivator:"service:formViewActivator",psDocCreator:"service:psDocCreator",formScopeConfigurer:"service:bookFormScopeConfigurer",dataPreparer:"service:docFormDataPreparer"}}constructor(data,parent){super(DocForm.$require,data,parent);let{formActivator:formActivator,psDocCreator:psDocCreator,formScopeConfigurer:formScopeConfigurer,dataPreparer:dataPreparer}=this,scope=this;formScopeConfigurer.setup({scope:scope,personalCollectionGroupId:"personal-collections",initialCollectionKey:"collectionId",publisherSelectPath:"select.publisher",collectionSelectPath:"select.collections",yearSelectPath:'select[name="year"]'}),this.doc={collection_id:this.initialCollectionId,year:(new Date).getFullYear(),status:!0,allow_aggregating:!1},formActivator.activate({scope:scope,form:"doc_form",formInputSelector:".doc-form input",beforeSetup(){scope.docFormFields.$each((field,idx)=>{formScopeConfigurer.autocompleteSetup(field)})},onSubmit(doc){let pdf,epub;return dataPreparer.prepare(scope,doc),pdf=doc.pdf,epub=doc.epub,delete doc.pdf,delete doc.epub,psDocCreator.create(scope,doc,[pdf,epub])}}),this.stepsValidation=[["collection","title"],["print","meme","designs"],["pdf"]],this.$addBeforeRecompileListener(_=>{this.skipVisited=!0,1===this.step&&(this.doc.collection_id=$(this.$getDom()).find("select.collections").val())},"step-max-watcher"),this.$bind("observable:uploadEvents",{onEvent(event,preventDefault){preventDefault();let upItem,prog="";if("progress"===event.eventName){if(!event.file||!event.file.type)return;event.track&&(prog=Math.round(event.track.loaded/event.track.total*100)+"%"),event.file.type.indexOf("application/pdf")>=0?upItem=$(scope.$getDom()).find(".working .upload-progress .up-item.pdf"):event.file.type.indexOf("application/epub")>=0&&(upItem=$(scope.$getDom()).find(".working .upload-progress .up-item.epub")),Q.$isEmpty(upItem)||$(upItem).text(`${event.file.name} ${prog}`)}}})}selectPublisher(){this.$preventDefault();let{formScopeConfigurer:formScopeConfigurer}=this;formScopeConfigurer.selectPublisher({scope:this,collectionSelectPath:"select.collections",publisherSelectPath:"select.publisher",personalCollectionGroupId:"personal-collections"})}}$export(DocForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class EditForm extends awr.Component{static get $require(){return{}}constructor(){super(EditForm.$require),this.template="app/forms/edit-form/edit-form.hbs",this.controller="EditForm",this.scope={doc:"=",collections:"=",publishers:"="}}}$export(EditForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class EditForm extends awr.Controller{static get $require(){return{formActivator:"service:formViewActivator",remoteCnf:"config:remoteConnectionConfig",collFetcher:"service:collectionFetcher",myDoc:"model:MyDoc",superScope:"object:awr.superScope",router:"service:router",formScopeConfigurer:"service:bookFormScopeConfigurer",dataPreparer:"service:docFormDataPreparer"}}constructor(data,parent){super(EditForm.$require,data,parent);let formHeight,{formActivator:formActivator,remoteCnf:remoteCnf,collFetcher:collFetcher,myDoc:myDoc,superScope:superScope,router:router,formScopeConfigurer:formScopeConfigurer,dataPreparer:dataPreparer}=this,scope=this;var o;Object.defineProperty(scope,"hasCover",{get:()=>Q.$setContainsString(["working","fail"],scope.mode)}),initDocForEdit(scope,remoteCnf,collFetcher),formScopeConfigurer.setup({scope:scope,personalCollectionGroupId:"personal-collections",initialCollectionKey:"collectionId",publisherSelectPath:"select.publisher",collectionSelectPath:"select.collections",yearSelectPath:'select[name="year"]'}),scope.inHeadSection=(nxt=>Q.$setContainsString(["title"],nxt.key)),scope.inCoverSection=(nxt=>Q.$setContainsString(["status","allow_aggregating"],nxt.key)),scope.inMainTopSection=(nxt=>Q.$setContainsString(["collection"],nxt.key)),scope.inMainBottomSection=(nxt=>!(scope.inHeadSection(nxt)||scope.inMainTopSection(nxt)||scope.inCoverSection(nxt)||Q.$setContainsString(["epub","pdf"],nxt.key))),formActivator.activate({scope:scope,form:"edit_form",formInputSelector:".edit_form input",beforeSetup(){scope.editFormFields.$each((field,idx)=>{formScopeConfigurer.autocompleteSetup(field)})},onSubmit:doc=>(dataPreparer.prepare(scope,doc),scope.doc=doc,delete doc.pdf,delete doc.epub,async function(scope,myDoc,remoteCnf,collFetcher){return await scope.doc.$save(),await collFetcher.findAll(null,!0),scope.doc=await myDoc.$findOne(scope.doc.id),initDocForEdit(scope,remoteCnf,collFetcher),scope.doc}(scope,myDoc,remoteCnf,collFetcher))}),scope.$addBeforeRecompileListener(_=>{superScope.dontCheckTheScroll=!0},"step-max-watcher"),scope.$fn({restart(){scope.$preventDefault(),router.$reloadCurrentState()}}),scope.$addRecompileListener(_=>{"fail"===scope.mode&&($(scope.$getDom()).find('div[awr-click="restart"]').off("click"),$(scope.$getDom()).find('div[awr-click="restart"]').on("click",scope.restart))}),scope.$init(_=>{formHeight=$(scope.$getDom()).find(".edit-form").height(),$(scope.$getDom()).find(".edit-form").css("min-height",`${formHeight}px`),superScope.dontCheckTheScroll=!1,Q.$numberExist(parseInt(scope.doc.year))&&$(scope.$getDom()).find('select[name="year"]').val(scope.doc.year),(o=$(this.$getDom()).find('.form-member textarea[name="title"]')[0]).style.height="1px",o.style.height=25+o.scrollHeight+"px"})}selectPublisher(){this.$preventDefault();let{formScopeConfigurer:formScopeConfigurer}=this;formScopeConfigurer.selectPublisher({scope:this,collectionSelectPath:"select.collections",publisherSelectPath:"select.publisher",personalCollectionGroupId:"personal-collections"})}}function initDocForEdit(scope,remoteCnf,collFetcher){let cover,status,aggregate,pdf,epub,coll;scope.doc=Q.$objectExist(scope.doc)?scope.doc:{},scope.doc.authors=getMetaValues(scope,"authors"),scope.doc.categories=getMetaValues(scope,"categories"),scope.doc.languages=getMetaValues(scope,"languages"),scope.doc.year=getMetaValues(scope,"year",!0),scope.doc.meme=getMetaValues(scope,"meme",!0),scope.doc.designs=getMetaValues(scope,"designs",!0),scope.doc.print=getMetaValues(scope,"print",!0),scope.doc.tags=Q.$isEmpty(scope.doc.tags)?[]:Q.$map(scope.doc.tags,nxt=>Q.$objectExist(nxt)?nxt.name:nxt),cover=Q.$objectExist(scope.doc.cover)?scope.doc.cover:{},scope.coverImg=`${remoteCnf.serverURL}${cover.src}`,status=scope.doc.status,aggregate=getMetaValues(scope,"allow_aggregating",!0,!0),scope.doc.status=1==status||"true"===status||Q.$booleanTrue(status)||"published"===status,scope.doc.allow_aggregating=1==aggregate||"true"==aggregate||Q.$booleanTrue(aggregate),pdf=Q.$isEmpty(scope.doc.attachments)?null:Q.$reduce(scope.doc.attachments,nxt=>nxt.mime&&nxt.mime.indexOf("application/pdf")>=0).$first(),epub=Q.$isEmpty(scope.doc.attachments)?null:Q.$reduce(scope.doc.attachments,nxt=>nxt.mime&&nxt.mime.indexOf("application/epub")>=0).$first(),scope.doc.pdfName=pdf&&Q.$stringExist(pdf.name)?pdf.name:"",scope.doc.epubName=epub&&Q.$stringExist(epub.name)?epub.name:"",coll=collFetcher.getDocCollections(scope.doc.id),Q.$isEmpty(coll)||(scope.doc.collection_id=coll[0].id),delete scope.collectionId,Object.defineProperty(scope,"collectionId",{get:()=>scope.doc&&Q.$numberExist(parseInt(scope.doc.collection_id))?parseInt(scope.doc.collection_id):null,configurable:!0})}function getMetaValues(scope,key,getOne=!1,isSetting=!1){let res=Q.$isEmpty(isSetting?scope.doc.settings:scope.doc.meta)?[]:Q.$map(isSetting?scope.doc.settings:scope.doc.meta,nxt=>{if(nxt.key===key)return nxt.value});return Q.$booleanTrue(getOne)&&!Q.$isEmpty(res)?res[0]:res}$export(EditForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class InviteForm extends awr.Component{static get $require(){return{}}constructor(){super(InviteForm.$require),this.template="app/forms/invite-form/invite-form.hbs",this.controller="InviteForm"}}$export(InviteForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class InviteForm extends awr.Controller{static get $require(){return{formActivator:"service:formViewActivator",inviteModel:"model:Invite",superScope:"object:awr.superScope"}}constructor(data,parent){super(InviteForm.$require,data,parent);let{formActivator:formActivator,inviteModel:inviteModel}=this;this.inviteFormContext={invite_text:makeDefaultInviteText({name:""})},formActivator.activate({scope:this,form:"invite-form",formInputSelector:".invite-form input",beforeSetup(){},onSubmit:inviteFormContext=>(Q.$stringExist(inviteFormContext.invite_text)&&!Q.$stringEqual(inviteFormContext.invite_text.trim(),makeDefaultInviteText({name:""}).trim())||(inviteFormContext.invite_text=makeDefaultInviteText(inviteFormContext)),inviteModel.$create(inviteFormContext))}),Object.defineProperty(this,"failReason",{get(){let{inviteFormContext:inviteFormContext,superScope:superScope}=this,currentUser=superScope.currentUser,invites=this.$findProperty("invites");return!Q.$isEmpty(invites)&&Q.$count(invites,nxt=>nxt.email===inviteFormContext.email)?`You have already invited a person by email [ ${inviteFormContext.email} ].`:currentUser&&currentUser.email===inviteFormContext.email?`Are you seriously trying to invite yourself!? The email [ ${inviteFormContext.email} ] belongs to you.`:"Something went wrong. Make sure you are not trying to invite someone which is already joined the platform!"},configurable:!0})}}function makeDefaultInviteText(context){return`Hello ${Q.$capitalizeName(context.name)},`+"\nI would like to invite you to join Pageshare platform and become part of this amazing community. Pageshare is a book reading and publishing platform for readers, authors and publishers. I am sure you will love this platform as much as I do."}$export(InviteForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class PublisherForm extends awr.Component{static get $require(){return{}}constructor(){super(PublisherForm.$require),this.template="app/forms/publisher-form/publisher-form.hbs",this.controller="PublisherForm",this.scope={assignee:"="}}}$export(PublisherForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class PublisherForm extends awr.Controller{static get $require(){return{formActivator:"service:formViewActivator",router:"service:router",publisherModel:"model:PsPublisher",superScope:"object:awr.superScope"}}constructor(data,parent){super(PublisherForm.$require,data,parent);let{router:router,publisherModel:publisherModel,superScope:superScope}=this,formActivator=this.formActivator;this.publisherFormContext={user_id:this.$findProperty("assigneeId")},formActivator.activate({scope:this,form:"publisher-form",formInputSelector:".publisher-form input",beforeSetup(){},onSubmit(publisherFormContext){let state=router.$getCurrentState();return new Promise((resolve,reject)=>{publisherModel.$create(publisherFormContext).then(newInstance=>{state.attrs.aid="done",router.$go(state.name,state,!1),Q.$arrayExist(superScope.cachedPublishers)&&superScope.cachedPublishers.push(newInstance),resolve("done")},err=>{state.attrs.aid="done",router.$go(state.name,state,!1),console.error(err),reject("failed")})})}})}}$export(PublisherForm),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;$import("window:jQuery");class CItem extends awr.Segment{static get $require(){return{superScope:"object:awr.superScope"}}constructor(){super(CItem.$require),this.itemAs="item",this.template="app/segments/c-item/c-item.hbs",this.bindOptions={}}setup(){let{context:context,superScope:superScope,scope:scope}=this,item=context.item;item.docsCount=Q.$isEmpty(item.stories)?0:item.stories.length,item.editName=item.name,delete context.isMyShelf,Object.defineProperty(context.item,"isMyShelf",{get:()=>superScope.isCollectionMyShelf(item.id),configurable:!0}),item.currentIsMyShelf=superScope.isCollectionMyShelf(item.id)}start(){}ready(){}}$export(CItem),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class DocPage extends awr.Segment{static get $require(){return{remoteCnf:"config:remoteConnection",base64:"service:uriBase64"}}constructor(){super(DocPage.$require),this.itemAs="page",this.template="app/segments/doc-page/doc-page.hbs",this.bindOptions={}}setup(){let{remoteCnf:remoteCnf,base64:base64,context:context}=this;context.name="docPage",context.doc=this.scope.$findProperty("doc"),context.docId=Q.$objectExist(context.doc)?context.doc.id:null,context.imageSrc=`${remoteCnf.serverURL}${context.page.src}`,context.shareUrl=`${remoteCnf.serverURL}/page/${base64.encode("ps:"+context.page.id)}/${context.page.number}`,function(context){context.meta=context.doc&&!Q.$isEmpty(context.doc.meta)?Q.$asCollection(context.doc.meta):Q.$asCollection([]),context.meme=context.meta.$reduce(nxt=>nxt.key&&"meme"===nxt.key.toLowerCase()).$first(),context.designs=context.meta.$reduce(nxt=>nxt.key&&"designs"===nxt.key.toLowerCase()).$first(),context.print=context.meta.$reduce(nxt=>nxt.key&&"print"===nxt.key.toLowerCase()).$first(),context.hasMeme=Q.$objectExist(context.meme),context.hasDesigns=Q.$objectExist(context.designs),context.hasPrint=Q.$objectExist(context.print)}(context),function(context,remoteCnf){context.attachments=context.doc&&!Q.$isEmpty(context.doc.attachments)?Q.$asCollection(context.doc.attachments):Q.$asCollection([]),context.pdf=context.attachments.$reduce(nxt=>nxt.mime&&nxt.mime.indexOf("application/pdf")>=0).$first(),context.epub=context.attachments.$reduce(nxt=>nxt.mime&&nxt.mime.indexOf("application/epub")>=0).$first(),context.hasPdf=Q.$objectExist(context.pdf),context.hasEpub=Q.$objectExist(context.epub),context.hasDownloads=context.hasPdf||context.hasEpub,context.hasPdf&&(context.pdf.url=`${remoteCnf.serverURL}${context.pdf.src}`);context.hasEpub&&(context.epub.url=`${remoteCnf.serverURL}${context.epub.src}`)}(context,remoteCnf),function(scope,remoteCnf,base64){scope.shareLink=`${remoteCnf.serverURL}/page/`+`${(title=>title?encodeURIComponent(title.toLowerCase().replace(/\s/g,"_")):"no_title")(scope.doc.title)}/`+`${base64.encode("ps:"+scope.doc.id)}/${scope.page.number}`}(context,remoteCnf,base64)}start(){let{remoteCnf:remoteCnf,base64:base64,context:context}=this;context.page.busyLoading=!0,context.page.isBusy=!0,context.page.loaded=!1,context.page.preLoaded=!1}ready(){let{dom:dom,context:context}=this;(context.page.loaded||context.page.preLoaded)&&$(dom).find("img").attr("src",context.imageSrc)}}$export(DocPage),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class ForbiddenCover extends awr.Segment{static get $require(){return{}}constructor(){super(ForbiddenCover.$require),this.itemAs="item",this.template="app/segments/forbidden-cover/forbidden-cover.hbs",this.bind="",this.bindOptions={}}setup(){let{context:context,scope:scope}=this;Object.defineProperty(context,"isForbidden",{get(){if(Q.$functionExist(scope.isAccessForbidden))try{return Q.$booleanTrue(scope.isAccessForbidden())}catch(err){console.error(err)}return!1},configurable:!0})}start(){}ready(){}}$export(ForbiddenCover),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MyPublisher extends awr.Segment{static get $require(){return{}}constructor(){super(MyPublisher.$require),this.itemAs="publisher",this.template="app/segments/my-publisher/my-publisher.hbs",this.bind="",this.bindOptions={}}setup(){let{context:context,scope:scope}=this}start(){}ready(){}}$export(MyPublisher),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class PublisherItem extends awr.Segment{static get $require(){return{}}constructor(){super(PublisherItem.$require),this.itemAs="item",this.template="app/segments/publisher-item/publisher-item.hbs",this.bind="model:PsPublisher",this.bindOptions={itemRemoveSignal(segmentInstance){let dom=segmentInstance.$getDom();$(dom).attr("awr-segment-id",null),$(dom).animate({width:["hide","swing"],height:["hide","swing"],opacity:"0.1"},700,"linear",()=>{})}}}setup(){let{context:context,scope:scope}=this;context.noCreators=Q.$isEmpty(context.item.creators),context.noModerators=Q.$isEmpty(context.item.moderators)}start(){}ready(){}}$export(PublisherItem),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class TagSearch extends awr.Segment{static get $require(){return{}}constructor(){super(TagSearch.$require),this.template="app/segments/tag-search/tag-search.hbs",this.bind="",this.bindOptions={}}setup(){let{context:context,scope:scope}=this;context.isTagSearch=!0,context.parent=scope}start(){}ready(){}}$export(TagSearch),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class TagSubscription extends awr.Segment{static get $require(){return{}}constructor(){super(TagSubscription.$require),this.itemAs="item",this.template="app/segments/tag-subscription/tag-subscription.hbs",this.bind="",this.bindOptions={}}setup(){let{context:context,scope:scope}=this;context.isBlackListed="blacklist"===context.item.type}start(){}ready(){}}$export(TagSubscription),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class UserItem extends awr.Segment{static get $require(){return{}}constructor(){super(UserItem.$require),this.itemAs="item",this.template="app/segments/user-item/user-item.hbs",this.bind="model:PsUser",this.bindOptions={itemRemoveSignal(segmentInstance){console.log("removing ");let dom=segmentInstance.$getDom();$(dom).attr("awr-segment-id",null),$(dom).animate({width:["hide","swing"],height:["hide","swing"],opacity:"0.1"},700,"linear",()=>{})}}}setup(){let{context:context,scope:scope,roleHelper:roleHelper}=this;context.hasOwnProperty("cleanRoles")&&delete context.cleanRoles,Object.defineProperty(context,"cleanRoles",{get:()=>(function(item,scope){let listEnv=scope.$findProperty("listEnvName"),roles=Q.$map(item&&item.roles?item.roles:[],nxt=>{let name=nxt.name;return!Q.$stringExist(name)&&Q.$stringExist(nxt.role_name)&&(name=nxt.role_name),name&&name.endsWith("@pageshare")?name=name.replace("@pageshare",""):"moderator"===name&&(name="sys_moderator"),name});"publishers"===listEnv?(item.isPublisherInOrg&&roles.push("publisher"),item.isModeratorInOrg&&roles.push("moderator"),item.isCreatorInOrg&&roles.push("creator")):(item.isPublisher&&roles.push("publisher"),item.isModerator&&roles.push("moderator"),item.isCreator&&roles.push("creator"));Q.$isEmpty(roles)&&roles.push("reader");return Q.$unique(roles)})(context.item,scope)}),Object.defineProperty(context,"removeUserAllowed",{get(){let fn=scope.$findProperty("canRemoveUser");return!!Q.$functionExist(fn)&&fn(context.item.id)}}),function(context,scope){defineIsRole(context.item,scope,"publisher"),defineIsRole(context.item,scope,"creator"),defineIsRole(context.item,scope,"moderator"),defineIsRole(context.item,scope,"admin"),defineIsRole(context.item,scope,"author")}(context,scope)}start(){let{context:context,scope:scope}=this}ready(){}}function defineIsRole(item,scope,roleName){let key=`is${Q.$firstLetterToUpperCase(roleName)}`,key2=`${key}InOrg`;item.hasOwnProperty(key)&&delete item[key],item.hasOwnProperty(key2)&&delete item[key2],Object.defineProperty(item,key,{get:()=>scope.hasRole(item.id,roleName.toLowerCase()),configurable:!0}),Object.defineProperty(item,key2,{get:()=>scope.hasRoleInActivePublisher(item.id,roleName.toLowerCase()),configurable:!0})}$export(UserItem),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class BookmarksView extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope",bookmarker:"service:bookmarker",dataFetcher:"dataFetcher:bookmarks"}}constructor(data,parent){super(BookmarksView.$require,data,parent);let{bookmarker:bookmarker,dataFetcher:dataFetcher}=this;bookmarker.setup({scope:this,bookmarks:this.bookmarks}),Object.defineProperty(this,"items",{get(){return Q.$isEmpty(this.bookmarks)?Q.$asCollection([]):this.bookmarks.$map(nxt=>(nxt.story.bookmark_id=nxt.id,nxt.story.bookmark_user_id=nxt.user_id,nxt.story))},configurable:!0}),this.removeBtnTitle="Remove from saved list",dataFetcher.setupAndFetch(this)}removeItem(item){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();let{bookmarker:bookmarker}=this;bookmarker.removeBookmarkByDoc({scope:this,doc:item})}}$export(BookmarksView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class BookmarksView extends awr.Route{static get $require(){return{}}constructor(){super(BookmarksView.$require),this.link="controls/bookmarks?",this.template="app/views/bookmarks-view/bookmarks-view-index.hbs",this.controller="BookmarksView",this.defaults={params:{},attrs:{}},this.resolve={bookmarks:"bookmarks"}}}$export(BookmarksView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;$import("window:jQuery");class EditView extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope",roleHelper:"service:roleHelper",collFetcher:"service:collectionFetcher",dataFetcher:"dataFetcher:editView",router:"service:router",docScpUtils:"service:docScopeUtils"}}constructor(data,parent){super(EditView.$require,data,parent);let coll,{superScope:superScope,roleHelper:roleHelper,collFetcher:collFetcher,dataFetcher:dataFetcher,docScpUtils:docScpUtils}=this,scope=this;this.$disableDefaultActionAutoRecompile(),window.scrollTo(0,0),dataFetcher.setupAndFetch(this),Object.defineProperty(this,"isReady",{get(){return this.isDataFetchReady&&!this.isAccessForbidden()},configurable:!0}),this.forbiddenContext={},this.isAccessForbidden=(()=>!!this.isDataFetchReady&&(coll=collFetcher.getDocCollections(this.doc.id),coll=Q.$isEmpty(coll)?null:coll[0],!(roleHelper.hasPSAdminRoleOrHigher(superScope.currentUser)||roleHelper.canEditDoc(superScope.currentUser,this.doc,coll,this.publishers)))),Object.defineProperty(this,"editAsAdmin",{get(){if(!this.isReady)return!1;let coll=collFetcher.getDocCollections(this.doc.id);return coll=Q.$isEmpty(coll)?null:coll[0],roleHelper.hasPSAdminRoleOrHigher(superScope.currentUser)&&!roleHelper.canEditDoc(superScope.currentUser,this.doc,coll,this.publishers)}}),this.$bind("observable:psDocEvents",{onEvent(event,preventDefault){preventDefault(),this.isDataFetchReady&&Q.$idEqual(event.target_id,scope.doc.id)&&Q.$setContainsString(["ps-doc:remove"],event.name)&&docScpUtils.onDocRemoved()}}),this.$bind("model:MyDoc",{onEvent(event,preventDefault){preventDefault(),this.isDataFetchReady&&Q.$stringEqual(event.requestType,"remove")&&docScpUtils.aboutCurrentDoc(this,event)&&docScpUtils.onDocRemoved()}})}}$export(EditView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q,$import("service:router");class EditView extends awr.Route{static get $require(){return{}}constructor(){super(EditView.$require);let{link:link,controller:controller,template:template,defaults:defaults,resolve:resolve}={link:"edit/:docId?",template:"app/views/edit-view/edit-view-index.hbs",defaults:{params:{docId:"none"},attrs:{}},resolve:{doc:"doc",collections:"collections",publishers:"ctrPublishers"},controller:"EditView"};this.link=link,this.controller=controller,this.template=template,this.defaults=defaults,this.resolve=resolve}}$export(EditView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class InviteView extends awr.Controller{static get $require(){return{router:"service:router",dataFetcher:"dataFetcher:invitesView"}}constructor(data,parent){super(InviteView.$require,data,parent);let{dataFetcher:dataFetcher}=this;this.inForm=this.$state&&"fm"===this.$state.attrs.v,Object.defineProperty(this,"defaultModeReady",{get(){return!this.inForm&&this.isDataFetchReady}}),dataFetcher.setupAndFetch(this)}openInviteForm(){this.$preventDefault();let{router:router,$state:$state}=this;"fm"!==$state.attrs.v&&($state.attrs.v="fm",router.$go($state.name,$state,!0))}cancelInvite(){this.$preventDefault();let{router:router,$state:$state}=this;"default"!==$state.attrs.v&&($state.attrs.v="default",router.$go($state.name,$state,!0))}}$export(InviteView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class InviteView extends awr.Route{static get $require(){return{}}constructor(){super(InviteView.$require),this.link="controls/invite?:v",this.template="app/views/invite-view/invite-view-index.hbs",this.controller="InviteView",this.defaults={params:{},attrs:{v:"default"}},this.resolve={invites:"invites"}}}$export(InviteView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class MyCollectionsView extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope",myCollModel:"model:MyCollection",roleHelper:"service:roleHelper",dataFetcher:"dataFetcher:myCollections"}}constructor(data,parent){super(MyCollectionsView.$require,data,parent);let{superScope:superScope,roleHelper:roleHelper,dataFetcher:dataFetcher}=this;this.isReady=!1,this.activePublisherId="personal-collections",Object.defineProperty(this,"currentUserId",{get:()=>Q.$objectExist(superScope.currentUser)?superScope.currentUser.id:null}),Object.defineProperty(this,"activePublisher",{get(){return"personal-collections"!==this.activePublisherId?this.publishers.$find("id",parseInt(this.activePublisherId)):null}}),Object.defineProperty(this,"canEditCollections",{get(){return Q.$objectExist(this.activePublisher)?roleHelper.isAdminInPublisher(this.activePublisher,this.currentUserId):"personal-collections"===this.activePublisherId&&roleHelper.canOwnPersonalCollections(superScope.currentUser)}}),Object.defineProperty(this,"canUseTheView",{get(){if(roleHelper.canOwnPersonalCollections(superScope.currentUser))return!0;let res=!1;return Q.$each(this.publishers,nxt=>{this.roleHelper.hasRoleInPublisher(nxt,this.currentUserId,"any")&&(res=!0)}),res}}),this.forbiddenContext={},this.isAccessForbidden=(()=>Q.$booleanFalse(this.canUseTheView)),dataFetcher.setupAndFetch(this)}selectPublisher(){this.$preventDefault(),this.activePublisherId=$(this.$getDom()).find("select.publisher").val(),Q.$numberExist(parseInt(this.activePublisherId))&&(this.activePublisherId=parseInt(this.activePublisherId)),$(this.$getDom()).find(".head .actions .create-btn").toggleClass("on",this.canEditCollections),this.activePublisherId!==this.listScope.activePublisherId&&(this.listScope.activePublisherId=this.activePublisherId,this.listScope.$recompile())}addCollection(){this.$preventDefault();let{myCollModel:myCollModel,listScope:listScope,superScope:superScope}=this;Q.$objectExist(listScope)&&(listScope.$getDom().find(".content").addClass("busy"),myCollModel.$create({name:"New Collection",is_main:!1,publisher_id:Q.$numberExist(parseInt(this.activePublisherId))?parseInt(this.activePublisherId):null}).then(newInstance=>{Q.$exist(newInstance.publisher_id)&&Q.$each(this.publishers,nxt=>{nxt.collections=Q.$asCollection(nxt.collections),Q.$idEqual(nxt.id,newInstance.publisher_id)&&!nxt.collections.$contains("id",newInstance.id)&&nxt.collections.push(newInstance)}),listScope.addNewItem.call(listScope,newInstance)},err=>{listScope.$getDom().find(".content").removeClass("busy"),console.error(err)}))}}$export(MyCollectionsView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MyCollectionsView extends awr.Route{static get $require(){return{}}constructor(){super(MyCollectionsView.$require);let{link:link,controller:controller,template:template,defaults:defaults,resolve:resolve}={name:"my-collections-view",link:"my_collections/:cId?",template:"app/views/my-collections-view/my-collections-view-index.hbs",defaults:{params:{cId:"index"},attrs:{}},resolve:{collections:"myCollections",publishers:"ctrPublishers"},controller:"MyCollectionsView"};this.link=link,this.controller=controller,this.template=template,this.defaults=defaults,this.resolve=resolve}}$export(MyCollectionsView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");const dummyPub={user:{},creators:[],moderators:[]};class MyPublisherView extends awr.Controller{static get $require(){return{listHelper:"service:listHelper",varConfigurer:"service:userPublisherVarsConfigurer",commonListFn:"service:commonListCtrFn",dataFetcher:"dataFetcher:usersView",router:"service:router"}}constructor(data,parent){super(MyPublisherView.$require,data,parent);let{varConfigurer:varConfigurer,commonListFn:commonListFn,dataFetcher:dataFetcher,router:router}=this;this.tabId="t3",this.query="",this.activePublisher=dummyPub,dataFetcher.setupAndFetch(this),varConfigurer.setup(this),this.$init(_=>{this.isDataFetchReady&&($(this.$getDom()).find(".pub-select option").removeAttr("selected"),$(this.$getDom()).find(`.pub-select option[data-id="${this.activePublisher.id}"]`).attr("selected","selected"))})}onDataReady(){Q.$functionExists(this.$preventDefault)&&this.$preventDefault();let{varConfigurer:varConfigurer,commonListFn:commonListFn,router:router}=this;varConfigurer.setupWhenData(this),commonListFn.resolveRestOfUsers({scope:this,state:router.$getCurrentState()}),commonListFn.decideFirstActivePublisher({scope:this,publishers:this.publishers})}assignPublisherRole(user,publisher,roleName){return Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.commonListFn.assignPublisherRole(user,publisher,roleName)}removePublisherRole(user,publisher,roleName){return Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.commonListFn.removePublisherRole(user,publisher,roleName)}selectPublisher(event){let id=$(event.target).find(`option[value="${$(event.target).val()}"]`).data("id");this.activePublisher=this.publishers.$reduce(nxt=>nxt.id==id).$first(),this.activePublisher.selected="selected"}hasRole(userId,roleName){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();return this.commonListFn.hasRole({scope:this,userId:userId,roleName:roleName})}hasRoleInActivePublisher(userId,roleName){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();return this.commonListFn.hasRoleInActivePublisher({scope:this,userId:userId,roleName:roleName})}itemSelect(event){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();this.commonListFn.itemSelect({scope:this,event:event})}search(event){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();this.commonListFn.search({scope:this,selector:".list-container .list-item",event:event,errMsg:"APP@AWR: Pageshare : bad function < onSearch > for controller@controls/myPublisher"})}}$export(MyPublisherView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MyPublisherView extends awr.Route{static get $require(){return{}}constructor(){super(MyPublisherView.$require),this.link="my_publisher?",this.template="app/views/my-publisher-view/my-publisher-view-index.hbs",this.controller="MyPublisherView",this.defaults={params:{},attrs:{}},this.resolve={users:"ctrUsers",publishers:"ctrPublishers"}}}$export(MyPublisherView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class TagsView extends awr.Controller{static get $require(){return{dataFetcher:"dataFetcher:tags"}}constructor(data,parent){super(TagsView.$require,data,parent);let{dataFetcher:dataFetcher}=this;dataFetcher.setupAndFetch(this)}}$export(TagsView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class TagsView extends awr.Route{static get $require(){return{}}constructor(){super(TagsView.$require),this.link="controls/tags?",this.template="app/views/tags-view/tags-view-index.hbs",this.controller="TagsView",this.defaults={params:{},attrs:{}},this.resolve={tags:"ctrTags"}}}$export(TagsView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;$import("window:jQuery");class UploadDocView extends awr.Controller{static get $require(){return{base64:"service:uriBase64",superScope:"object:awr.superScope",roleHelper:"service:roleHelper",collFetcher:"service:collectionFetcher",dataFetcher:"dataFetcher:uploadView"}}constructor(data,parent){super(UploadDocView.$require,data,parent);let coll,{base64:base64,superScope:superScope,roleHelper:roleHelper,collFetcher:collFetcher,dataFetcher:dataFetcher}=this,scope=this,cId=scope.$state.params.cId;scope.collectionId=Q.$stringExist(cId)&&"index"!==cId?base64.decode(cId):cId,this.forbiddenContext={},Object.defineProperty(this,"isReady",{get(){return this.isDataFetchReady&&!this.isAccessForbidden()},configurable:!0}),this.isAccessForbidden=(()=>!!this.isDataFetchReady&&(coll=collFetcher.getOneLocal(scope.collectionId),!roleHelper.canCreateDocsInCollection(superScope.currentUser,coll,this.publishers))),dataFetcher.setupAndFetch(this)}}$export(UploadDocView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class UploadDocView extends awr.Route{static get $require(){return{}}constructor(){super(UploadDocView.$require);let{link:link,controller:controller,template:template,defaults:defaults,resolve:resolve}={link:"upload/:cId",template:"app/views/upload-doc-view/upload-doc-view-index.hbs",defaults:{params:{cId:"index"},attrs:{}},resolve:{collections:"myCollections",publishers:"ctrPublishers"},controller:"UploadDocView"};this.link=link,this.controller=controller,this.template=template,this.defaults=defaults,this.resolve=resolve}}$export(UploadDocView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");const dummyPub={user:{},creators:[],moderators:[]};class UsersView extends awr.Controller{static get $require(){return{router:"service:router",listHelper:"service:listHelper",varConfigurer:"service:userPublisherVarsConfigurer",commonListFn:"service:commonListCtrFn",base64:"service:uriBase64",superScope:"object:awr.superScope",dataFetcher:"dataFetcher:usersView"}}constructor(data,parent){super(UsersView.$require,data,parent);let{varConfigurer:varConfigurer,commonListFn:commonListFn,router:router,superScope:superScope,dataFetcher:dataFetcher}=this,state=this.$state,tabV=state&&state.attrs?state.attrs.v:"t1";this.tabs=[{name:"Users directory",id:"t1",icon:"fas fa-users-cog"},{name:"Publishers directory",id:"t2",icon:"fas fa-building"},{name:"New publisher",id:"t4",icon:"fas fa-plus"}],this.tabId=Q.$setContainsString(["t1","t2","t4"],tabV)?tabV:"t1",this.query="",this.activePublisher=dummyPub,this.canRemoveUser=(userId=>commonListFn.currentCanRemoveUser(userId)),function(state){return state.attrs&&state.attrs.aid&&(Q.$numberExist(parseInt(state.attrs.aid))||Q.$setContainsString(["done","none","undefined","null"],state.attrs.aid.toLowerCase()))}(state)&&(this.tabId="t1",state.attrs.v="t1",state.attrs.aid="cr",router.$go(state.name,state,!1)),dataFetcher.setupAndFetch(this),varConfigurer.setup(this),this.$init(_=>{this.isDataFetchReady&&($(this.$getDom()).find(".pub-select option").removeAttr("selected"),$(this.$getDom()).find(`.pub-select option[data-id="${this.activePublisher.id}"]`).attr("selected","selected"))})}onDataReady(){Q.$functionExists(this.$preventDefault)&&this.$preventDefault();let{varConfigurer:varConfigurer,commonListFn:commonListFn,router:router}=this;varConfigurer.setupWhenData(this),commonListFn.resolveRestOfUsers({scope:this,state:router.$getCurrentState()}),commonListFn.decideFirstActivePublisher({scope:this,publishers:this.publishers})}changeTab(id){if(this.$preventDefault(),id===this.tabId)return;let{router:router}=this,state=router.$getCurrentState();this.tabId=Q.$setContainsString(["t1","t2","t4"],id)?id:"t1",this.query="",state.attrs.v=this.tabId,state.attrs.aid=state.attrs&&"t4"===this.tabId?state.attrs.aid:"cr",router.$go(state.name,state,!1),this.$recompile()}createPublisher(userId){if(Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),!Q.$numberExist(parseInt(userId)))return;let{base64:base64,router:router}=this,state=router.$getCurrentState();state.attrs.aid=base64.encode(userId),state.attrs.v="t4",router.$go(state.name,state,!0)}cancelCreatePublisher(){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();let{router:router}=this,state=router.$getCurrentState();state.attrs.aid="cr",state.attrs.v="t1",router.$go(state.name,state,!0)}removeAccount(user){return Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.commonListFn.removeAccount(this,user)}removePublisher(publisher){return Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.commonListFn.removePublisher(this,publisher)}assignRole(user,roleName){return Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.commonListFn.assignRole(user,roleName)}removeRole(user,roleName){return Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.commonListFn.removeRole(user,roleName)}hasRole(userId,roleName){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();return this.commonListFn.hasRole({scope:this,userId:userId,roleName:roleName})}hasRoleInActivePublisher(userId,roleName){return Q.$functionExist(this.$preventDefault)&&this.$preventDefault(),this.commonListFn.hasRoleInActivePublisher({scope:this,userId:userId,roleName:roleName})}itemSelect(event){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();this.commonListFn.itemSelect({scope:this,event:event})}search(event){Q.$functionExist(this.$preventDefault)&&this.$preventDefault();let scope=this;Q.$nonBlocking(()=>{this.commonListFn.search({scope:scope,selector:".list-container .list-item",event:event,errMsg:"APP@AWR: Pageshare : bad function < onSearch > for controller@controls/users"})},"",this.$getScopeId())}}$export(UsersView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class UsersView extends awr.Route{static get $require(){return{}}constructor(){super(UsersView.$require),this.link="controls/users?:v&:aid",this.template="app/views/users-view/users-view-index.hbs",this.controller="UsersView",this.defaults={params:{},attrs:{v:"default",aid:"cr"}},this.resolve={users:"ctrUsers",publishers:"ctrPublishers"}}}$export(UsersView),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class V extends awr.Controller{static get $require(){return{router:"service:router",superScope:"object:awr.superScope",base64:"service:uriBase64",collFetcher:"service:collectionFetcher",roleHelper:"service:roleHelper",bookmarker:"service:bookmarker",psDocEvents:"observable:psDocEvents",dataFetcher:"dataFetcher:vView",docResolver:"resolvable:vDoc",docScpUtils:"service:docScopeUtils"}}constructor(data,parent){super(V.$require,data,parent);let{router:router,superScope:superScope,docScpUtils:docScpUtils,collFetcher:collFetcher,roleHelper:roleHelper,dataFetcher:dataFetcher}=this,scope=this;this.$disableDefaultActionAutoRecompile(),window.scrollTo(0,0),dataFetcher.setupAndFetch(this),Object.defineProperty(this,"userCanEditDoc",{get(){if(!this.isDataFetchReady)return!1;let coll=collFetcher.getDocCollections(this.doc.id);return coll=Q.$isEmpty(coll)?null:coll[0],roleHelper.hasPSAdminRoleOrHigher(superScope.currentUser)||roleHelper.canEditDoc(superScope.currentUser,this.doc,coll,this.publishers)}}),Object.defineProperty(this,"isReady",{get(){return this.isDataFetchReady},configurable:!0}),this.$init(_=>{this.isDataFetchReady&&Q.$booleanTrue(this.doc.is_busy)&&$(scope.$getDom()).find(".v-view").addClass("processing")}),this.$bind("observable:psDocEvents",{onEvent(event,preventDefault){if(preventDefault(),!this.isDataFetchReady)return;if(!Q.$idEqual(event.target_id,scope.doc.id))return;let container=$(scope.$getDom()).find(".v-view");event.name.endsWith("start-processing")?$(container).addClass("processing"):event.name.endsWith("end-processing")?scope.reloadDocWhenReady():"ps-doc:publish"===event.name?setTimeout(_=>{router.$reloadCurrentState()},1e3):Q.$setContainsString(["ps-doc:unpublish","ps-doc:remove"],event.name)&&$(container).addClass("no-content")}}),this.$bind("model:MyDoc",{onEvent(event,preventDefault){preventDefault(),this.isDataFetchReady&&Q.$stringEqual(event.requestType,"remove")&&docScpUtils.aboutCurrentDoc(this,event)&&docScpUtils.onDocRemoved()}})}reloadDocWhenReady(){let{docResolver:docResolver,router:router}=this;clearInterval(this.reloadDocInterval),this.reloadWait=!1,this.reloadDocInterval=setInterval(_=>{this.reloadWait||(this.reloadWait=!0,docResolver.resolveLater(router.$getCurrentState()).then(doc=>{doc.is_busy?this.reloadWait=!1:(clearInterval(this.reloadDocInterval),this.reloadWait=!1,this.doc=doc,this.$recompile())},err=>{console.error(err),clearInterval(this.reloadDocInterval),this.reloadWait=!1}))},500)}onDataReady(){let docColls,{router:router,superScope:superScope,base64:base64,collFetcher:collFetcher,bookmarker:bookmarker,docScpUtils:docScpUtils}=this,docId=this.$state.params.docId,title=this.$state.params.title,encodedId=base64.encode(this.doc.id),cleanTitle=Q.$stringExist(this.doc.title)?encodeURIComponent(this.doc.title.toLowerCase().replace(/\s/g,"_")):"no_title";bookmarker.setup({scope:this,bookmarks:this.bookmarks}),this.$state.params.docId=encodedId,this.$state.params.title=cleanTitle,Q.$stringEqual(docId,encodedId)&&Q.$stringEqual(title,cleanTitle)||router.$go(this.$state.name,this.$state,!1),superScope.currentDoc=this.doc,docColls=collFetcher.getDocCollections(this.doc.id),docScpUtils.docInCollection(collFetcher.getCurrent(),this.doc)||Q.$isEmpty(docColls)||collFetcher.setCurrent(docColls[0].id),$emit("collection:events",{name:"new-doc-selected",doc:this.doc})}toggleBookmark(){let{bookmarker:bookmarker}=this;bookmarker.toggleBookmark({scope:this,uiSelector:".doc-page .left-actions .tool-item.bookmark"})}}$export(V),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Default extends awr.Route{static get $require(){return{}}constructor(){super(Default.$require),this.link="v/:title/:docId/:page?:c",this.controller="V",this.template="app/views/v-view/v-index.hbs",this.defaults={params:{title:"no_title",docId:"none",page:"index"},attrs:{c:"index"}},this.resolve={doc:"vDoc",publishers:"ctrPublishers",collections:"collections",bookmarks:"bookmarks"}}}$export(Default),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class DocReaderInit extends awr.Service{static get $require(){return{router:"service:router",utils:"service:docReaderUtils"}}constructor(){super(DocReaderInit.$require),this.$importSuperScope()}init(scope){let onScroll,{router:router,superScope:superScope,utils:utils}=this;scope.isReady=Q.$booleanTrue(superScope.isReaderReady),scope.hasGotToPagePos=!1,scope.pagePos=0,scope.renderedPages=20,utils.setScopeItems(scope),utils.initCurrentPage(scope,router),Object.defineProperty(scope,"pendingPages",{get:()=>scope.$getAllSegments().$reduce(seg=>utils.isPendingDocPage(seg)),configurable:!0}),onScroll=((event,loadMore=!0)=>{scope.pendingPages.$each(seg=>{seg.$segmentContextInstance.page.preLoaded=!0,seg.$update()}),loadMore&&$("#btmIndicator").isInViewport(5e3)&&scope.renderedPages+scope.prePages<Q.$count(scope.pages)&&scope.pages.$skip(scope.renderedPages+scope.prePages).$take(20).$each(p=>{scope.renderedPages++,scope.$append({selector:".doc-reader > .pages",segment:"docPage",dataContext:p})})}),scope.$ready(_=>{window.addEventListener("scroll",onScroll)},"mainOnReady"),scope.$init(_=>{if(scope.hasGotToPagePos&&Q.$numberExist(scope.pagePos)&&scope.pagePos>1){let currentPos=$(scope.$getDom()).find(`.doc-page[data-page-number="${scope.pagePos}"]`).position();window.scrollTo(0,currentPos.top-100),scope.hasGotToPagePos=!1,scope.pagePos=0}setTimeout(_=>{onScroll(0,!1),setTimeout(_=>{onScroll(0,!1)},1500)},0)}),scope.$addFlushListener(_=>{window.removeEventListener("scroll",onScroll)})}}$export(DocReaderInit),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class DocReaderMethods extends awr.Service{static get $require(){return{router:"service:router"}}constructor(){super(DocReaderMethods.$require),this.$importSuperScope()}loadPreviousPages({scope:scope}){let state,page,take,topPage,{router:router}=this;"index"===(page=(state=router.$getCurrentState()).params.page)||!Q.$numberExist(parseInt(page))||parseInt(page)<2||(take=Math.min(10,scope.prePages),scope.prePages=Math.max(0,scope.prePages-take),scope.renderedPages+=take,scope.hasPrePages=scope.prePages>0,scope.hasGotToPagePos=!0,scope.pagePos=page,topPage=Q.$asCollection($(scope.$getDom()).find(".doc-page")).$reduce((el,idx)=>$(el).isInViewport()).$first(),Q.$objectExists(topPage)&&Q.$idExists($(topPage).data("page-number"))?(scope.pagePos=$(topPage).data("page-number"),state.params.page=scope.pagePos,router.$go(state.name,state,!1)):scope.pagePos=page,scope.$recompile())}imageLoaded({scope:scope,event:event}){let page,imgEl,detach,segment=scope.$segment;Q.$objectExist(segment)&&((page=segment.dataContext).loaded||(page.busyLoading=!1,page.isBusy=!1,page.loaded=!0,imgEl=$(segment.$getDom()).find("img"),$(imgEl).css("display","none"),$(imgEl).css("opacity",.1),$(imgEl).animate({opacity:1,left:"+=50",height:"toggle"},function(event){}),segment.$update(),setTimeout(_=>{detach=$(segment.$getDom()),$(detach).attr("awr-segment-id",`detached-${segment.segmentId.replace("SMT-","")}`),segment.$remove(),$(detach).on("click",event=>{this.toggleLeftActions({scope:{$segment:{$getDom:()=>detach}},event:event})}),$(detach).find(".page-menu > .number, .page-menu > .expand > .close-btn").on("click",event=>{this.togglePageMenu({scope:{$segment:{$getDom:()=>detach}},event:event})})},500)))}toggleLeftActions({scope:scope,event:event}){let target,actions,segment=scope.$segment;Q.$objectExist(segment)&&(target=event.target,actions=$(segment.$getDom()).find(".tools .left-actions"),Q.$isEmpty($(target).closest(".doc-page .tools"))&&$(actions).toggleClass("on",!$(actions).hasClass("on")))}togglePageMenu({scope:scope,event:event}){let pMenu,segment=scope.$segment;if(Q.$objectExist(segment))return pMenu=$(segment.$getDom()).find(".page-menu"),$(pMenu).hasClass("on")?$(pMenu).removeClass("on"):$(pMenu).addClass("on")}}$export(DocReaderMethods),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class DocReaderUtils extends awr.Service{static get $require(){return{remoteCnf:"config:remoteConnectionConfig",base64:"service:uriBase64",router:"service:router"}}constructor(){super(DocReaderUtils.$require)}initCurrentPage(scope){let{router:router}=this,page=router.$getCurrentState().params.page;scope.prePages=0,scope.hasPrePages=!1,"index"===page||!Q.$numberExist(parseInt(page))||parseInt(page)<2||(scope.prePages=page-1,scope.hasPrePages=!0)}setScopeItems(scope){Q.$objectExist(scope.doc)?scope.pages=Q.$isEmpty(scope.doc.pages)?Q.$asCollection([]):Q.$asCollection(scope.doc.pages):scope.pages=Q.$asCollection([])}isPendingDocPage(segment){let ctx=segment.$segmentContextInstance;return($(segment.$getDom()).isInViewport()||$(segment.$getDom()).isInViewport(3500))&&Q.$objectExists(ctx)&&"docPage"===ctx.name&&!(ctx.page.preLoaded||ctx.page.loaded)}}$export(DocReaderUtils),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let encoder="CmxldCBwYXJ0TGVuZ3RoID0gcGFyc2VJbnQoc3RyLmxlbmd0aCAvIDQpLCBhcnIgPSBbXSwKICAgICAgICBueHQsCiAgICAgICAgc3RhcnQgPSAwLAogICAgICAgIGVuZCA9IHBhcnRMZW5ndGgsCiAgICAgICAga2V5ID0gYnAgJiYgdHlwZW9mIGJwLmdlbmVyYXRlT25lID09PSAnZnVuY3Rpb24nID8gYnAuZ2VuZXJhdGVPbmUoKSA6IG51bGw7CiAgICBpZigha2V5KXsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGtleSA9IGtleS5zcGxpdCgnLScpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICBpZiAoaSA8IDMpIHsKICAgICAgICAgICAgbnh0ID0ga2V5W2ldK3dpbmRvdy5idG9hKHN0ci5zdWJzdHJpbmcoc3RhcnQsIGVuZCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG54dCA9IGtleVtpXSt3aW5kb3cuYnRvYShzdHIuc3Vic3RyaW5nKHN0YXJ0KSk7CiAgICAgICAgfQogICAgICAgIGFyci5wdXNoKG54dCk7CiAgICAgICAgc3RhcnQgPSBlbmQ7CiAgICAgICAgZW5kICs9IHBhcnRMZW5ndGg7CiAgICB9CiAgICByZXR1cm4gd2luZG93LmJ0b2EoSlNPTi5zdHJpbmdpZnkoYXJyLnJldmVyc2UoKSkpICsgJyRhV3QnOwo=",decoder="CiAgbGV0IGFyciA9IEpTT04ucGFyc2Uod2luZG93LmF0b2Ioc3RyLnN1YnN0cmluZygwLCBzdHIubGVuZ3RoIC0gNCkpKSwga2V5ID0gW107CiAgICBpZiAoIVEuJGFycmF5Tm90RW1wdHkoYXJyKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgYXJyID0gYXJyLnJldmVyc2UoKTsKICAgIGFyciA9IFEuJG1hcChhcnIsIG54dCA9PiB7CiAgICAgICAga2V5LnB1c2gobnh0LnN1YnN0cmluZygwLCA0KSk7CiAgICAgICAgcmV0dXJuIHdpbmRvdy5hdG9iKG54dC5zdWJzdHJpbmcoNCkpOwogICAgfSk7CiAgICBrZXkgPSBrZXkuam9pbignLScpOwogICAgaWYgKGJwICYmIHR5cGVvZiBicC5jaGVjayA9PT0gJ2Z1bmN0aW9uJyAmJiBicC5jaGVjayhrZXkpKSB7CiAgICAgICAgcmV0dXJuIGFyci5qb2luKCcnKTsKICAgIH0KICAgIHJldHVybiBudWxsOw==",awr=window.awr||{},Q=awr.Q,loc=window.location,serial=$import("service:serial"),currentUser=null,devServerPort=loc.host&&(loc.host.endsWith(":8080")||loc.host.endsWith(":9090")),hostname=devServerPort?loc.hostname:loc.host,server=$import("service:serverCall"),serverRoot=`${loc.protocol}//${hostname}`,api=`${serverRoot}/api`,authRoot=`${serverRoot}/xauth`,token=$import(`token:awr_app_token @decoder: base64:${decoder}`);class RemoteConnection extends awr.Config{static get $require(){return{}}constructor(name){super(RemoteConnection.$require,name);let blog_app_session,device_blog_app_session,remoteCnf=this;this.user=currentUser,this.apiURL=api,this.authURL=authRoot,this.serverURL=serverRoot,this.isGuest=!Q.$objectExist(currentUser),this.encoder=encoder,this.decoder=decoder,this.sessionIdTag="ba_session",this.deviceSessionIdTag="d_ba_session",this.isDevPort=devServerPort,blog_app_session=sessionStorage.getItem(this.sessionIdTag),device_blog_app_session=localStorage.getItem(this.deviceSessionIdTag),Q.$stringExist(blog_app_session)||sessionStorage.setItem(this.sessionIdTag,`${serial.basicPrime.generateOne()}@${(new Date).getTime()}`),Q.$stringExist(device_blog_app_session)||localStorage.setItem(this.deviceSessionIdTag,`${serial.basicPrime.generateOne()}@${(new Date).getTime()}`),Object.defineProperty(this,"sessionId",{get:()=>sessionStorage.getItem(remoteCnf.sessionIdTag)}),Object.defineProperty(this,"deviceSessionId",{get:()=>localStorage.getItem(remoteCnf.deviceSessionIdTag)})}}server.$get({url:`${authRoot}/token_user`,headers:{authorization:token}}).then(res=>{currentUser=res,$export(RemoteConnection)},err=>{console.error(err),$export(RemoteConnection)}),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class SocketConnection extends awr.Config{static get $require(){return{remoteCnf:"config:remoteConnection"}}constructor(name){super(SocketConnection.$require,name);let{remoteCnf:remoteCnf}=this,host=window.location.hostname;this.url=Q.$setContainsString(["www.pageshare.fi","pageshare.fi"],host)||host.indexOf("awiar.net")>0||host.indexOf("awiarsolutions.com")>0?`wss://${host}`:`ws://${host}:8890`,this.channels=["notification","hint@notification","broadcast@notification"],Object.defineProperty(this,"socketToken",{get:()=>(remoteCnf=$import("config:remoteConnectionConfig"))&&Q.$objectExist(remoteCnf.user)&&Q.$stringExist(remoteCnf.user.socket_token)?remoteCnf.user.socket_token:null})}}$export(SocketConnection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},observerCount=(awr.Q,0);$import("class:Observable@event");class CollectionEvents extends awr.Observable{static get $require(){return{}}constructor(){super(CollectionEvents.$require)}makeSubscriber(){return observer=>{let observerId=`collection-events-observer-${++observerCount}`;return eventStr="collection:events",fn=(event=>{observer.next(event)}),listenerId=observerId,window.awr.$static.$on(eventStr,fn,listenerId),()=>{!function(eventStr,fn){window.awr.$static.$off(eventStr,fn)}("collection:events",observerId)}};var eventStr,fn,listenerId}}$export(CollectionEvents),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class PsDocEvents extends awr.ObservableTransform{static get $require(){return{socket:"observable:socket"}}constructor(){super(PsDocEvents.$require)}transform(){let{socket:socket}=this;return socket.$filter(event=>event&&Q.$stringExist(event.name)&&event.name.startsWith("ps-doc:"))}}$export(PsDocEvents),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Collection extends awr.Model{static get $require(){return{}}constructor(){super(Collection.$require),this.url="/ps_collection/",this.headers={}}}$export(Collection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Doc extends awr.Model{static get $require(){return{}}constructor(){super(Doc.$require),this.url="/ps_doc/",this.headers={}}}$export(Doc),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MyCollection extends awr.Model{static get $require(){return{}}constructor(){super(MyCollection.$require),this.url="/my_ps_collection/",this.headers={}}}$export(MyCollection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MyDoc extends awr.Model{static get $require(){return{}}constructor(){super(MyDoc.$require),this.url="/my_ps_doc/",this.headers={}}}$export(MyDoc),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class PsPublisher extends awr.Model{static get $require(){return{}}constructor(){super(PsPublisher.$require),this.url="/ps_publisher/",this.headers={}}}$export(PsPublisher),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class PsUser extends awr.Model{static get $require(){return{}}constructor(){super(PsUser.$require),this.url="/ps_user/",this.headers={}}}$export(PsUser),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class PublisherRole extends awr.Model{static get $require(){return{}}constructor(){super(PublisherRole.$require),this.url="/ps_publisher_role/",this.headers={}}}$export(PublisherRole),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Role extends awr.Model{static get $require(){return{}}constructor(){super(Role.$require),this.url="/role/",this.headers={}}}$export(Role),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class TagSubscription extends awr.Model{static get $require(){return{}}constructor(){super(TagSubscription.$require),this.url="/tag_subscription/",this.headers={}}}$export(TagSubscription),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class BookImgSrc extends awr.Pipe{static get $require(){return{remoteCnf:"config:remoteConnectionConfig"}}constructor(){super(BookImgSrc.$require)}transform(img,...args){let{remoteCnf:remoteCnf}=this;return Q.$stringExist(img)?`${remoteCnf.serverURL}${img}`:Q.$objectExist(img)&&Q.$stringExist(img.src)?`${remoteCnf.serverURL}${img.src}`:""}}$export(BookImgSrc),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class Collections extends awr.Resolvable{static get $require(){return{collFetcher:"service:collectionFetcher"}}constructor(){super(Collections.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}}function resolveFn(state,self,network=!1){let{superScope:superScope,collFetcher:collFetcher}=self,loc=collFetcher.getLocalAll();return Q.$isEmpty(loc)?network?new Promise((resolve,reject)=>{collFetcher.findAll().then(res=>{superScope.cachedCollsReady=!0,resolve(Q.$asCollection(res))},err=>{console.error(err),reject(err)})}):(superScope.cachedCollsReady=!1,Promise.resolve(Q.$asCollection([]))):(superScope.cachedCollsReady=!0,Promise.resolve(loc))}$export(Collections),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,lastFromCache=!1;class CtrPublishers extends awr.Resolvable{static get $require(){return{model:"model:PsPublisher"}}constructor(){super(CtrPublishers.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}}function resolveFn(state,self,network=!1){let{superScope:superScope,model:model}=self,currentUser=superScope.currentUser;return Q.$objectExist(currentUser)?Q.$arrayExists(superScope.cachedPublishers)&&superScope.cachedPublishersReady?(lastFromCache=!0,Promise.resolve(superScope.cachedPublishers)):(lastFromCache=!1,network?new Promise((resolve,reject)=>{model.$findAll().then(res=>{superScope.cachedPublishersReady=!0,superScope.cachedPublishers=Q.$asCollection(res),resolve(Q.$asCollection(res))},err=>{console.error(err),reject(err)})}):(superScope.cachedPublishersReady=!1,Promise.resolve(Q.$asCollection([])))):(superScope.cachedPublishersReady=!0,Promise.resolve(Q.$asCollection([])))}$export(CtrPublishers),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class CtrTags extends awr.Resolvable{static get $require(){return{model:"model:TagSubscription"}}constructor(){super(CtrTags.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}}function resolveFn(state,self,network=!1){let{superScope:superScope,model:model}=self,currentUser=superScope.currentUser;return Q.$objectExist(currentUser)?Q.$arrayExists(superScope.cachedTags)&&superScope.cachedTagsReady?Promise.resolve(superScope.cachedTags):network?new Promise((resolve,reject)=>{model.$findAll().then(res=>{superScope.cachedTagsReady=!0,superScope.cachedTags=Q.$asCollection(res),resolve(Q.$asCollection(res))},err=>{console.error(err),reject(err)})}):(superScope.cachedTagsReady=!1,Promise.resolve(Q.$asCollection([]))):(superScope.cachedTagsReady=!1,Promise.resolve(Q.$asCollection([])))}$export(CtrTags),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,lastFromCache=!1;class CtrUsers extends awr.Resolvable{static get $require(){return{model:"model:PsUser"}}constructor(){super(CtrUsers.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}resolveRest(state){let currentUser=this.superScope.currentUser;return Q.$objectExist(currentUser)?lastFromCache?Promise.resolve([]):this.model.$findAll("?skip=40"):Promise.resolve(Q.$asCollection([]))}}function resolveFn(state,self,network=!1){let{superScope:superScope,model:model}=self,currentUser=superScope.currentUser;return Q.$objectExist(currentUser)?Q.$arrayExists(superScope.cachedUsers)&&superScope.cachedUsersReady?(lastFromCache=!0,Promise.resolve(superScope.cachedUsers)):(lastFromCache=!1,network?new Promise((resolve,reject)=>{model.$findAll("?take=40").then(res=>{superScope.cachedUsersReady=!0,superScope.cachedUsers=Q.$asCollection(res),resolve(Q.$asCollection(res))},err=>{console.error(err),reject(err)})}):(superScope.cachedUsersReady=!1,Promise.resolve(Q.$asCollection([])))):(superScope.cachedUsersReady=!1,Promise.resolve(Q.$asCollection([])))}$export(CtrUsers),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Doc extends awr.Resolvable{static get $require(){return{docModel:"model:MyDoc",base64:"service:uriBase64"}}constructor(){super(Doc.$require)}resolve(state){return Promise.resolve({isPlaceholder:!0})}resolveLater(state){let{base64:base64,docModel:docModel}=this,docId=state.params.docId;return docModel.$findOne(base64.decode(docId))}}$export(Doc),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class MyCollections extends awr.Resolvable{static get $require(){return{model:"model:MyCollection"}}constructor(){super(MyCollections.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}}function resolveFn(state,self,network=!1){let{superScope:superScope,model:model}=self,currentUser=superScope.currentUser;return Q.$objectExist(currentUser)?Q.$arrayExists(superScope.cachedMyColls)&&superScope.cachedMyCollsReady?Promise.resolve(superScope.cachedMyColls):network?new Promise((resolve,reject)=>{model.$findAll().then(res=>{superScope.cachedMyCollsReady=!0,superScope.cachedMyColls=Q.$asCollection(res),resolve(Q.$asCollection(res))},err=>{console.error(err),reject(err)})}):(superScope.cachedMyCollsReady=!1,Promise.resolve(Q.$asCollection([]))):(superScope.cachedMyCollsReady=!1,Promise.resolve(Q.$asCollection([])))}$export(MyCollections),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class VDoc extends awr.Resolvable{static get $require(){return{docModel:"model:Doc",myDocModel:"model:MyDoc",base64:"service:uriBase64",collFetcher:"service:collectionFetcher"}}constructor(){super(VDoc.$require),this.$importSuperScope()}resolve(state){return resolveFn(state,this,!1)}resolveLater(state){return resolveFn(state,this,!0)}}function resolveFn(state,self,network=!1){let lsAll,model,currentColl,{base64:base64,docModel:docModel,myDocModel:myDocModel,collFetcher:collFetcher,superScope:superScope}=self,docId=state.params.docId;return network?(model=Q.$objectExist(superScope.currentUser)?myDocModel:docModel,Q.$stringExist(docId)&&"none"!==docId?model.$findOne(base64.decode(docId)):new Promise((resolve,reject)=>{collFetcher.findAll().then(res=>{currentColl=collFetcher.getCurrent(),Q.$objectExist(currentColl)&&!Q.$isEmpty(currentColl.stories)||(lsAll=collFetcher.getLocalAll(),currentColl=lsAll.$reduce(nxt=>!Q.$isEmpty(nxt.stories)).$first()),Q.$objectExist(currentColl)&&!Q.$isEmpty(currentColl.stories)||reject("Failed to load doc from default collection. No default Collection!"),collFetcher.setCurrent(currentColl.id),docId=Q.$isEmpty(currentColl.stories)?null:currentColl.stories[0].id,Q.$exist(docId)||reject("Failed to load doc from default collection. Bad docId for first collection member!"),model.$findOne(docId).then(doc=>{resolve(doc)},err=>{reject(err)})},err=>{reject(err)})})):Promise.resolve({isPlaceholder:!0})}$export(VDoc),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let Q=(window.awr||{}).Q;$export("service:appDemoAuthorizer",["service:serial",function(serial){let passRoots=["SRQP-2570","XHVJ-1329","KLBW-9305","CWKS-3480","ZQSN-6391","KQYL-8150","QMEO-1768","DAFW-1897","BFOT-4935","MHSR-8706"];return{authorize(a,b){let hasMatch=!1;return new Promise(function(resolve,reject){setTimeout(()=>{Q.$forEachIndex(passRoots,(val,index)=>{try{b=b.toUpperCase(),serial.basicPrime.generateOne({alpha:val.split("-")[0],delta:val.split("-")[1]}).endsWith(`${a}-${b}`)&&(hasMatch=!0)}catch(e){}}),Q.$booleanTrue(hasMatch)?resolve(!0):reject(!1)},1e3)})}}}]),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class AuthNextBuilder extends awr.Service{static get $require(){return{router:"service:router",remoteConfig:"config:remoteConnection"}}constructor(){super(AuthNextBuilder.$require)}getAppNextLink(){let{router:router}=this;return router.$getAppNextLink()}getCleanAuthNext(appNext){let{remoteConfig:remoteConfig,router:router}=this;return router.$makeAuthNext({connectionConfig:remoteConfig,appNext:appNext})}getURIEncoder(){let{router:router}=this;return router.$authNextEncoder}}$export(AuthNextBuilder),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;const cacheName="autocomplete@cache";class Autocomplete extends awr.Service{static get $require(){return{searchCache:"service:searchCache",server:"service:serverCall",remoteCnf:"config:remoteConnection"}}constructor(){super(Autocomplete.$require),Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}search(query,{type:type=null,key:key=null,take:take=20}={}){let cachedResult,{server:server,remoteCnf:remoteCnf,superScope:superScope,searchCache:searchCache}=this,url=`${remoteCnf.serverURL}/api/ps_autocomplete?query=${encodeURIComponent(query)}`,devId=remoteCnf.deviceSessionId,user_id=Q.$objectExist(superScope.currentUser)?superScope.currentUser.id:null;return Q.$stringExist(query)?searchCache.inCache(cacheName,query)?($emit("search:autocomplete",{results:cachedResult=searchCache.getFromCache(cacheName,query),query:query}),cachedResult=Q.$asCollection(Q.$isEmpty(cachedResult)?[]:cachedResult),Promise.resolve(cachedResult)):(Q.$stringExist(type)&&(url+=`&type=${encodeURIComponent(type)}`),Q.$stringExist(key)&&(url+=`&key=${encodeURIComponent(key)}`),Q.$exist(user_id)&&(url+=`&user_id=${user_id}`),Q.$stringExist(devId)&&(url+=`&device_session_id=${devId}`),new Promise((resolve,reject)=>{server.$get({url:url}).then(res=>{let results=Q.$asCollection(Q.$isEmpty(res)?[]:res);Q.$numberExist(take)&&(results=results.$take(take)),searchCache.putInCache(cacheName,query,results),$emit("search:autocomplete",{results:results,query:query}),resolve(results)},err=>{console.error(err)})})):Promise.reject("no query!")}}$export(Autocomplete),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let cachedSet,current,cTime,freshCurrent,aggregated,onGoingCall,awr=window.awr||{},Q=awr.Q;class CollectionFetcher extends awr.Service{static get $require(){return{collModel:"model:Collection",myCollModel:"model:MyCollection",remoteCnf:"config:remoteConnection"}}constructor(){super(CollectionFetcher.$require);let{collModel:collModel}=this;Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")}),aggregated=makeAggregatedCollection(collModel,Q.$asCollection([]))}findAll(query,refresh=null){let{collModel:collModel,myCollModel:myCollModel,superScope:superScope}=this,model=Q.$objectExist(superScope.currentUser)?myCollModel:collModel;return Q.$exist(refresh)||!Q.$booleanFalse(query)&&!Q.$booleanTrue(query)||(refresh=query,query=null),Q.$stringExist(query)?model.$findAll(query):(refresh=!(!Q.$booleanFalse(refresh)&&!Q.$booleanTrue(refresh))&&refresh,(Q.$booleanTrue(refresh)||!Q.$numberExist(cTime)||(new Date).getTime()>cTime+6e4)&&(cTime=null,cachedSet=null),Q.$isEmpty(cachedSet)?Q.$objectExists(onGoingCall)?onGoingCall:onGoingCall=new Promise((resolve,reject)=>{model.$findAll().then(res=>{onGoingCall=null,cachedSet=res,cTime=(new Date).getTime(),Q.$objectExist(current)&&(freshCurrent=res.$find(nxt=>nxt.id==current.id),current=Q.$objectExist(freshCurrent)?freshCurrent:null),resolve(res)},err=>{onGoingCall=null,console.error(err),reject(err)})}):Promise.resolve(cachedSet))}getLocalAll(){return Q.$isEmpty(cachedSet)?Q.$asCollection([]):Q.$asCollection(cachedSet)}getDocCollections(docId){return Q.$isEmpty(cachedSet)||!Q.$exist(docId)?Q.$asCollection([]):cachedSet.$reduce(nxt=>!Q.$isEmpty(nxt.stories)&&Q.$count(nxt.stories,nxtDoc=>nxtDoc.id==docId)>0)}removeDocFromCache(collId,docId){!Q.$isEmpty(cachedSet)&&Q.$exist(docId)&&cachedSet.$each(col=>{col.id===collId&&(col.stories=Q.$reduce(col.stories,nxt=>nxt.id!==docId))})}addDocIntoCache(collId,doc){!Q.$isEmpty(cachedSet)&&Q.$objectExist(doc)&&cachedSet.$each(col=>{col.id===collId&&(Q.$arrayExist(col.stories)||(col.stories=Q.$asCollection([])),Q.$count(col.stories,nxt=>nxt.id===doc.id)<1&&col.stories.push(doc))})}getOneLocal(cId){return"agr"===cId?aggregated:this.getLocalAll().$reduce(nxt=>Q.$numberExist(parseInt(nxt.id))&&parseInt(cId)===parseInt(nxt.id)).$first()}getCurrent(){let inCache,savedItemId=parseInt(sessionStorage.getItem("ps-cr-cl"));return Q.$objectExist(current)||!Q.$numberExist(savedItemId)||Q.$isEmpty(cachedSet)?Q.$objectExist(current)?current:Q.$isEmpty(cachedSet)?null:cachedSet.$first():(inCache=cachedSet.$find("id",savedItemId),Q.$objectExist(inCache)?inCache:cachedSet.$first())}setCurrent(id){let orig=current;return!("agr"!==id&&(Q.$isEmpty(cachedSet)||!Q.$exist(id)))&&(current="agr"===id?aggregated:cachedSet.$find("id",id),Q.$objectExist(current)?(sessionStorage.setItem("ps-cr-cl",id),$emit("collection:events",{name:"new-current",collection:current}),!0):(current=orig,!1))}aggregate(stories){let{collModel:collModel}=this;return(aggregated=makeAggregatedCollection(collModel,stories)).id}}function makeAggregatedCollection(model,stories){return model.$template({id:"agr",name:"aggregated",status:"published",user_id:"agr-user",type:"ps/collection",stories:stories})}$export(CollectionFetcher),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class FileUploader extends awr.Service{static get $require(){return{uploadManager:"service:uploadManager",remoteCnf:"config:remoteConnection"}}constructor(){super(FileUploader.$require)}upload({path:path,fileKey:fileKey,files:files}){let{uploadManager:uploadManager,remoteCnf:remoteCnf}=this;return uploadManager.upload({url:`${remoteCnf.serverURL}/${path}`,token:$import(`token:awr_app_token @decoder: base64:${remoteCnf.decoder}`),fileKey:fileKey,files:files})}}$export(FileUploader),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class GlobalFnHelper extends awr.Service{static get $require(){return{collectionFetcher:"service:collectionFetcher",base64:"service:uriBase64",modal:"service:modal"}}constructor(){super(GlobalFnHelper.$require)}firstDocDataInCollection(collId){let coll,docs,first,docTitle,docId,{base64:base64,modal:modal,collectionFetcher:collectionFetcher}=this;return new Promise((resolve,reject)=>{collectionFetcher.findAll().then(res=>{coll=res.$find("id",collId),docs=Q.$objectExist(coll)&&!Q.$isEmpty(coll.stories)?Q.$asCollection(coll.stories):Q.$asCollection([]),first=docs.$first(),Q.$objectExist(coll)&&collectionFetcher.setCurrent(coll.id),Q.$objectExist(first)?(docTitle=Q.$stringExist(first.title)?encodeURIComponent(first.title.toLowerCase().replace(/\s/g,"_")):"no_title",docId=base64.encode(first.id),resolve({docTitle:docTitle,docId:docId})):reject("empty")},err=>{reject(err)})})}findPrinciplesCollId(){let principles,{modal:modal,collectionFetcher:collectionFetcher}=this;return new Promise((resolve,reject)=>{collectionFetcher.findAll().then(res=>{principles=res.$reduce(nxt=>nxt.name&&"principles"===nxt.name.toLowerCase()).$first(),Q.$objectExist(principles)?resolve(principles.id):(modal.$enter("smallNotifModal",{icon:"fa fa-exclamation-triangle text-warning",message:"Sorry, Principles is not available at the moment. Please try again later",showRemove:!0}),reject("Principles not available"))},err=>{reject(err)})})}}$export(GlobalFnHelper),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;const cacheName="doc-search@cache";class PsDocSearch extends awr.Service{static get $require(){return{searchCache:"service:searchCache",server:"service:serverCall",remoteCnf:"config:remoteConnection"}}constructor(){super(PsDocSearch.$require),Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}search(query,{type:type=null,key:key=null,take:take=20}={}){let cachedResult,{server:server,remoteCnf:remoteCnf,superScope:superScope,searchCache:searchCache}=this,url=`${remoteCnf.serverURL}/api/ps_story_search?query=${encodeURIComponent(query)}`,devId=remoteCnf.deviceSessionId,user_id=Q.$objectExist(superScope.currentUser)?superScope.currentUser.id:null;return Q.$stringExist(query)?searchCache.inCache(cacheName,query)?($emit("search:ps-doc",{results:cachedResult=searchCache.getFromCache(cacheName,query),query:query}),cachedResult=Q.$asCollection(Q.$isEmpty(cachedResult)?[]:cachedResult),Promise.resolve(cachedResult)):(Q.$stringExist(type)&&(url+=`&type=${encodeURIComponent(type)}`),Q.$stringExist(key)&&(url+=`&key=${encodeURIComponent(key)}`),Q.$exist(user_id)&&(url+=`&user_id=${user_id}`),Q.$stringExist(devId)&&(url+=`&device_session_id=${devId}`),new Promise((resolve,reject)=>{server.$get({url:url}).then(res=>{let results=Q.$asCollection(Q.$isEmpty(res)?[]:res);Q.$numberExist(take)&&(results=results.$take(take)),searchCache.putInCache(cacheName,query,results),$emit("search:ps-doc",{results:results,query:query}),resolve(results)},err=>{console.error(err)})})):Promise.reject("no query!")}}$export(PsDocSearch),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;const adminRoleNames=["admin@pageshare","moderator","super"];class RoleHelper extends awr.Service{static get $require(){return{}}constructor(){super(RoleHelper.$require)}isAdminInPublisher(publisher,userId){return this.hasRoleInPublisher(publisher,userId,"publisher")||this.hasRoleInPublisher(publisher,userId,"moderator")}canOwnPersonalCollections(user){return!!Q.$objectExist(user)&&function(roles,options){let result=!1;if(Q.$isEmpty(roles)||Q.$isEmpty(options))return result;return Q.$each(options,nxt=>{hasRole(roles,nxt)&&(result=!0)}),result}(Q.$isEmpty(user.roles)?[]:user.roles,["author@pageshare","admin@pageshare","moderator","super"])}canEditDoc(user,doc,collection,publishers){return!!(Q.$objectExist(user)&&Q.$objectExist(doc)&&Q.$numberExist(parseInt(doc.user_id)))&&(parseInt(doc.user_id)===parseInt(user.id)||this.canEditDocsInCollection(user,collection,publishers))}canEditDocsInCollection(user,collection,publishers){if(!this.canCreateDocsInCollection(user,collection,publishers))return!1;let pub=Q.$reduce(publishers,nxt=>parseInt(nxt.id)===parseInt(collection.publisher_id)).$first();return this.hasRoleInPublisher(pub,user.id,"publisher")||this.hasRoleInPublisher(pub,user.id,"moderator")}canCreateDocsInCollection(user,collection,publishers){if(!(Q.$objectExist(user)&&Q.$objectExist(collection)&&Q.$numberExist(parseInt(collection.user_id))))return!1;if(parseInt(collection.user_id)===parseInt(user.id))return!0;if(!Q.$numberExist(parseInt(collection.publisher_id)))return!1;let pub=Q.$reduce(publishers,nxt=>parseInt(nxt.id)===parseInt(collection.publisher_id)).$first();return!!Q.$objectExist(pub)&&this.hasRoleInPublisher(pub,user.id,"any")}hasRoleInPublisher(publisher,userId,roleName){if(!(Q.$objectExist(publisher)&&Q.$exist(userId)&&Q.$stringExist(roleName)))return!1;let{moderators:moderators,creators:creators}=publisher,isModerator=!Q.$isEmpty(moderators)&&Q.$count(moderators,nxt=>Q.$idEqual(nxt.id,userId))>0,isCreator=!Q.$isEmpty(creators)&&Q.$count(creators,nxt=>Q.$idEqual(nxt.id,userId))>0,isPublisher=Q.$idEqual(publisher.user_id,userId);return"any"===(roleName=roleName.toLowerCase())?isPublisher||isModerator||isCreator:"moderator"===roleName?isModerator:"creator"===roleName?isCreator:isPublisher}hasPSAdminRoleOrHigher(user){return Q.$objectExist(user)&&!Q.$isEmpty(user.roles)&&Q.$count(user.roles,nxt=>nxt.name&&Q.$setContainsString(["super","admin@pageshare","moderator"],nxt.name.toLowerCase()))>0}isPSAdminOrHigher(scope,userId){return this.hasRole(scope,userId,"admin")||this.hasRole(scope,userId,"super")}hasRole(scope,userId,roleName){if(!Q.$stringExist(roleName)||!Q.$exist(userId))return!1;scope=Q.$objectExist(scope)?scope:{};let{publishers:publishers,users:users}=scope,roleFound=!1;return(!Q.$setContainsString(["moderator","publisher","creator"],roleName)||!Q.$isEmpty(publishers))&&("publisher"===roleName?roleFound=publishers.$count(nxt=>nxt&&Q.$idEqual(nxt.user_id,userId))>0:"moderator"===roleName?publishers.$each(nxt=>{!Q.$isEmpty(nxt.moderators)&&Q.$count(nxt.moderators,moder=>moder&&Q.$idEqual(moder.id,userId))&&(roleFound=!0)}):"creator"===roleName?publishers.$each(nxt=>{!Q.$isEmpty(nxt.creators)&&Q.$count(nxt.creators,creator=>creator&&Q.$idEqual(creator.id,userId))&&(roleFound=!0)}):Q.$isEmpty(users)||(roleName="admin"===roleName||"author"===roleName?`${roleName}@pageshare`:roleName,users.$each(nxtUsr=>{Q.$idEqual(nxtUsr.id,userId)&&hasRole(nxtUsr.roles,roleName)&&(roleFound=!0)})),"reader"===roleName||roleFound)}rolesInclude(user,roleName){return!!Q.$objectExist(user)&&hasRole(user.roles,roleName)}}function hasRole(roles,roleName){return!Q.$isEmpty(roles)&&Q.$stringExist(roleName)&&Q.$count(roles,r=>"admin@pageshare"===roleName?Q.$setContainsString(adminRoleNames,r.name):r&&r.name===roleName)>0}$export(RoleHelper),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let current,awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery"),savedVal=0,body="body";class ScrollDirection extends awr.Service{static get $require(){return{}}constructor(){super(ScrollDirection.$require)}start(superScope){$(window).on("scroll",event=>{Q.$booleanTrue(superScope.dontCheckTheScroll)||(current=$(window).scrollTop(),$(body).toggleClass("has-some-scroll",current>=10&&current<65),$(body).toggleClass("has-scroll",current>=65),current<savedVal?(savedVal=current,$(body).removeClass("down-scroll"),$(body).addClass("up-scroll")):current>savedVal&&current>=65&&(savedVal=current,$(body).removeClass("up-scroll"),$(body).addClass("down-scroll")))})}}$export(ScrollDirection),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,cache={};class SearchCache extends awr.Service{static get $require(){return{}}constructor(){super(SearchCache.$require)}putInCache(cacheName,query,results){if(!Q.$stringExist(cacheName)||!Q.$stringExist(query))return!1;createCacheIfNotExists(cacheName);let queryCache=cache[cacheName];(queryCache=Q.$reduce(queryCache,nxt=>!(Q.$stringEqual(nxt.query,query)||nxt.expires.getTime()<=(new Date).getTime()))).push({query:query,expires:new Date((new Date).getTime()+6e4),results:results}),queryCache=Q.$descendingDate(queryCache,"expires"),queryCache=Q.$limit(queryCache,200),cache[cacheName]=queryCache}inCache(cacheName,query){if(!Q.$stringExist(cacheName)||!Q.$stringExist(query))return!1;createCacheIfNotExists(cacheName);let queryCache=cache[cacheName];return queryCache=Q.$reduce(queryCache,nxt=>nxt.expires.getTime()>(new Date).getTime()),Q.$count(queryCache,nxt=>Q.$stringEqual(nxt.query,query))>0}getFromCache(cacheName,query){if(!Q.$stringExist(cacheName)||!Q.$stringExist(query))return Q.$asCollection([]);createCacheIfNotExists(cacheName);let queryCache=cache[cacheName];return this.inCache(cacheName,query)?Q.$collect(queryCache,(collected,nxt)=>Q.$stringEqual(nxt.query,query)?nxt.results:collected):null}}function createCacheIfNotExists(cacheName){cache.hasOwnProperty(cacheName)&&Q.$arrayNotEmpty(cache[cacheName])||(cache[cacheName]=Q.$asCollection([]))}$export(SearchCache),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;const cacheName="saerch@cache";class Search extends awr.Service{static get $require(){return{searchCache:"service:searchCache",server:"service:serverCall",remoteCnf:"config:remoteConnection"}}constructor(){super(Search.$require),Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}search(query,limit,target){let cachedResult,{server:server,remoteCnf:remoteCnf,superScope:superScope,searchCache:searchCache}=this,user_id=Q.$objectExist(superScope.currentUser)?superScope.currentUser.id:null,devId=remoteCnf.deviceSessionId,url=`${remoteCnf.serverURL}/api/search?query=${encodeURIComponent(query)}`;return Q.$stringExist(query)?limit<15&&searchCache.inCache(cacheName,query)?($emit("search:story-search",{results:cachedResult=searchCache.getFromCache(cacheName,query),query:query,target:target}),Promise.resolve({results:cachedResult,query:query})):(Q.$exist(limit)&&(url+=`&limit=${limit}`),Q.$exist(user_id)&&(url+=`&user_id=${user_id}`),Q.$stringExist(devId)&&(url+=`&device_session_id=${devId}`),new Promise((resolve,reject)=>{server.$get({url:url}).then(res=>{let results={stories:Q.$asCollection(res&&Q.$arrayNotEmpty(res.stories)?res.stories:[]).$map(nxt=>(nxt.resultType="story",nxt)),profiles:Q.$asCollection(res&&Q.$arrayNotEmpty(res.profiles)?res.profiles:[]).$map(nxt=>(nxt.resultType="profile",nxt))};$emit("search:story-search",{results:results,query:query,target:target}),resolve({items:results,query:query}),limit<15&&searchCache.putInCache(cacheName,query,res)},err=>{console.error(err)})})):Promise.reject("no query!")}}$export(Search),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class ShelfViewUpdater extends awr.Service{static get $require(){return{collFetcher:"service:collectionFetcher",remoteCnf:"config:remoteConnectionConfig",router:"service:router",roleHelper:"service:roleHelper",myDocModel:"model:MyDoc",docModel:"model:Doc"}}constructor(){super(ShelfViewUpdater.$require),Object.defineProperty(this,"superScope",{get:()=>$import("object:awr.superScope")})}update(scope){let{collFetcher:collFetcher,remoteCnf:remoteCnf,roleHelper:roleHelper,router:router,superScope:superScope}=this;!function({scope:scope,collFetcher:collFetcher,router:router,roleHelper:roleHelper,remoteCnf:remoteCnf,superScope:superScope}){(async function({collFetcher:collFetcher,superScope:superScope,router:router}){let current=collFetcher.getCurrent(),pubResolvable=$import("resolvable:ctrPublishers"),collections=current&&"agr"===current.id?Q.$asCollection([]):await collFetcher.findAll(),publishers=await pubResolvable.resolve(router.$getCurrentState());return superScope.cachedPublishers=publishers,{collections:collections,publishers:publishers,currentCollection:collFetcher.getCurrent(),currentUser:superScope.currentUser}})({collFetcher:collFetcher,superScope:superScope,router:router}).then(({collections:collections,publishers:publishers,currentCollection:currentCollection,currentUser:currentUser})=>{delete scope.canUserCreateDocs,Object.defineProperty(scope,"canUserCreateDocs",{get:()=>(!Q.$objectExist(currentCollection)||"agr"!==currentCollection.id)&&roleHelper.canCreateDocsInCollection(currentUser,currentCollection,publishers),configurable:!0}),Q.$objectExist(currentCollection)&&("agr"!==currentCollection.id&&Q.$objectExist(scope.coll)&&currentCollection.id===scope.coll.id||(setScopeItems(scope,collFetcher.getCurrent(),remoteCnf,superScope),scope.$recompile()))},err=>{})}({scope:scope,collFetcher:collFetcher,router:router,remoteCnf:remoteCnf,roleHelper:roleHelper,superScope:superScope})}setScopeItems(scope,coll){let{superScope:superScope,remoteCnf:remoteCnf}=this;setScopeItems(scope,coll,remoteCnf,superScope)}addItem(scope,itemId){let{myDocModel:myDocModel,docModel:docModel,superScope:superScope,collFetcher:collFetcher,remoteCnf:remoteCnf}=this;(Q.$objectExist(superScope.currentUser)?myDocModel:docModel).$findOne(itemId).then(docInstance=>{collFetcher.addDocIntoCache(scope.coll.id,docInstance),Q.$count(scope.coll.stories,nd=>nd.id===docInstance.id)<1&&scope.coll.stories.push(docInstance),setScopeItems(scope,scope.coll,remoteCnf,superScope),scope.$append({selector:".shelf .inner .s-items",segment:"shelfItem",dataContext:docInstance})},err=>{console.error(err)})}removeItem(scope,itemId){if(!Q.$numberExist(parseInt(itemId)))return;itemId=parseInt(itemId);let{collFetcher:collFetcher,remoteCnf:remoteCnf,superScope:superScope}=this;scope.coll.stories=scope.coll.stories.$reduce(nxt=>nxt.id!==itemId),collFetcher.removeDocFromCache(scope.coll.id,itemId),setScopeItems(scope,scope.coll,remoteCnf,superScope),scope.$getAllSegments().$each(nxt=>{parseInt(nxt.dataContext.id)===itemId&&nxt.$remove()})}removeItemIfNotAvailable(scope,itemId){if(!Q.$exist(itemId))return;let{myDocModel:myDocModel,docModel:docModel,superScope:superScope}=this;(Q.$objectExist(superScope.currentUser)?myDocModel:docModel).$findOne(itemId).then(docInstance=>{},err=>{this.removeItem(scope,itemId)})}handleItemBusyModes(scope,event){let{collFetcher:collFetcher,remoteCnf:remoteCnf,superScope:superScope}=this,item=$(scope.$getDom()).find(`.shelf-item[data-doc-id="${event.target_id}"]`);Q.$isEmpty(item)||scope.inControls||(event.name.endsWith("start-processing")?($(item).removeClass("loading"),$(item).addClass("processing")):event.name.endsWith("end-processing")&&($(item).removeClass("processing"),scope.coll.stories=Q.$map(scope.coll.stories,nxt=>nxt.id==event.target_id?(event.target.is_busy=!1,event.target):nxt),setScopeItems(scope,scope.coll,remoteCnf,superScope),scope.$getAllSegments().$each(nxt=>{parseInt(nxt.dataContext.id)===parseInt(event.target_id)&&nxt.$upgrade(event.target)})))}}function setScopeItems(scope,coll,remoteCnf,superScope){if(!Q.$objectExist(coll))return scope.coll={},void(scope.stories=Q.$asCollection([]));scope.coll=coll,scope.stories=Q.$isEmpty(coll.stories)?Q.$asCollection([]):Q.$asCollection(coll.stories).$map(nxt=>(nxt.isSelected=Q.$objectExist(superScope.currentDoc)&&nxt.id==superScope.currentDoc.id,nxt))}$export(ShelfViewUpdater),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class TokenService extends awr.Service{static get $require(){return{remoteConnCnf:"config:remoteConnection",server:"service:serverCall"}}constructor(){super(TokenService.$require)}getNewAccessToken(username,password){let appGroup,{remoteConnCnf:remoteConnCnf,server:server}=this;return Q.$numberExist(password)&&(password=`${password}`),Q.$stringExist(username)&&Q.$stringExist(password)?(appGroup=$('meta[name="awr-app-group"]').first(),server.$post({url:`${remoteConnCnf.authURL}/token`,data:{app_group:Q.$arrayNotEmpty(appGroup)?$(appGroup).attr("content"):"default",grant_type:"password",username:username,password:password,scope:"*"}})):Promise.reject("Bad credentials")}newEmailConfirmLink(token){if(!Q.$stringExist(token))return Promise.reject("Get token user: Bad token!");let{remoteConnCnf:remoteConnCnf,server:server}=this;return server.$post({url:`${remoteConnCnf.serverURL}/api/email_confirm_link`,headers:{authorization:token}})}destroyToken(token){let{remoteConnCnf:remoteConnCnf,server:server}=this;return Q.$stringExist(token)?server.$delete({url:`${remoteConnCnf.authURL}/token`,headers:{authorization:token}}):Promise.reject("Destroy token: Bad token!")}getTokenUser(token){let{remoteConnCnf:remoteConnCnf,server:server}=this;return Q.$stringExist(token)?server.$get({url:`${remoteConnCnf.authURL}/token_user`,headers:{authorization:token}}):Promise.reject("Get token user: Bad token!")}exchangeToken(exchange){let{remoteConnCnf:remoteConnCnf,server:server}=this;return server.$post({url:`${remoteConnCnf.serverURL}/xauth/token_exchange`,data:{key:exchange}})}}$export(TokenService),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class ConfirmModal extends awr.Component{static get $require(){return{}}constructor(){super(ConfirmModal.$require),this.controller="ConfirmModal",this.template="app/shared/components/confirm-modal/confirm-modal.hbs",this.scope={}}}$export(ConfirmModal),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class ConfirmModal extends awr.Controller{static get $require(){return{}}constructor(data,parent){super(ConfirmModal.$require,data,parent);let parentScope=this.$getParent(),{title:title,message:message,confirmText:confirmText,cancelText:cancelText,confirmBtnClass:confirmBtnClass,cancelBtnClass:cancelBtnClass,confirmBeforeIcon:confirmBeforeIcon,confirmAfterIcon:confirmAfterIcon,mainIcon:mainIcon,onConfirm:onConfirm,icon:icon}=Q.$objectExist(parentScope.scopeBody)?parentScope.scopeBody:{};this.body={icon:icon,title:title,message:message,confirmText:confirmText,cancelText:cancelText,confirmBtnClass:confirmBtnClass,cancelBtnClass:cancelBtnClass,confirmBeforeIcon:confirmBeforeIcon,confirmAfterIcon:confirmAfterIcon,mainIcon:mainIcon,onConfirm:onConfirm},Q.$stringExist(cancelText)||(this.body.cancelBtnClass="hidden")}confirm(){this.$preventDefault();let{onConfirm:onConfirm}=this.body;if(this.$getParent().modalOff(),Q.$functionExist(onConfirm))try{onConfirm()}catch(e){console.error("Confirm Error: onConfirm callback ended by an error."),console.error(e)}}cancel(){this.$preventDefault(),this.$getParent().modalOff()}}$export(ConfirmModal),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class CookieBanner extends awr.Component{static get $require(){return{}}constructor(){super(CookieBanner.$require),this.template="app/shared/components/cookie-banner/cookie-banner.hbs",this.controller="CookieBanner"}}$export(CookieBanner),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");const cookiePolicyKeyPrefix="ps_acp_";class CookieBanner extends awr.Controller{static get $require(){return{remoteCnf:"config:remoteConnectionConfig",superScope:"object:awr.superScope",base64:"service:uriBase64"}}constructor(data,parent){super(CookieBanner.$require,data,parent);let status,{superScope:superScope,base64:base64}=this;this.$init(_=>{status=function(user,base64){return localStorage.getItem(`${cookiePolicyKeyPrefix}${Q.$exists(user)?base64.encode(user.id).toLowerCase():"null"}`)}(superScope.currentUser,base64),$(this.$getDom()).find(".cookie-banner").toggleClass("on",!(Q.$stringExists(status)&&"true"===status))})}accept(){let{superScope:superScope,base64:base64}=this;!function(user,base64){localStorage.setItem(`${cookiePolicyKeyPrefix}${Q.$exists(user)?base64.encode(user.id).toLowerCase():"null"}`,"true")}(superScope.currentUser,base64)}}$export(CookieBanner),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class DocMenu extends awr.Component{static get $require(){return{}}constructor(){super(DocMenu.$require),this.controller="DocMenu",this.template="app/shared/components/doc-menu/doc-menu.hbs",this.scope={currentDoc:"="}}}$export(DocMenu),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,labels=($import("window:jQuery"),["collections","languages","authors","categories","year"]);class DocMenu extends awr.Controller{static get $require(){return{collFetcher:"service:collectionFetcher",superScope:"object:awr.superScope",roleHelper:"service:roleHelper",docSearch:"service:psDocSearch"}}constructor(data,parent){super(DocMenu.$require,data,parent);let{collFetcher:collFetcher,superScope:superScope,roleHelper:roleHelper}=this,scope=this;setupScopeItems(scope,labels,collFetcher,superScope),Object.defineProperty(this,"userCanEditDoc",{get(){if(!Q.$objectExist(superScope.currentDoc))return!1;let coll=collFetcher.getDocCollections(superScope.currentDoc.id);return coll=Q.$isEmpty(coll)?null:coll[0],roleHelper.canEditDoc(superScope.currentUser,superScope.currentDoc,coll,superScope.cachedPublishers||Q.$asCollection([]))}}),scope.$bind("observable:collectionEvents",{onEvent(event,preventDefault){preventDefault(),"new-doc-selected"===event.name&&(setupScopeItems(scope,labels,collFetcher,superScope),scope.$recompile())}})}handle(group,searchId,value){this.$preventDefault();let agrId,{docSearch:docSearch,collFetcher:collFetcher}=this;"collections"!==group&&docSearch.search(searchId).then(stories=>{agrId=collFetcher.aggregate(stories),collFetcher.setCurrent(agrId)},err=>{console.error(err)})}}function setupScopeItems(scope,groups,collFetcher,superScope){let currentDoc=superScope.currentDoc;groups=Q.$isEmpty(groups)?Q.$asCollection([]):Q.$asCollection(groups),Q.$objectExist(currentDoc)?(scope.docId=currentDoc.id,scope.items=Q.$asCollection(groups).$map(nxtGrp=>{let values=Q.$asCollection([]);return currentDoc.meta=Q.$isEmpty(currentDoc.meta)?Q.$asCollection([]):Q.$asCollection(currentDoc.meta),values="collections"===nxtGrp?collFetcher.getDocCollections(currentDoc.id).$map(nxtC=>(nxtC.value=nxtC.name,nxtC.searchId=nxtC.id,nxtC)):groups.$reduce(nxtG=>"collections"!==nxtG&&nxtG===nxtGrp).$map(nxtG=>currentDoc.meta.$reduce(nxtM=>nxtM.key===nxtGrp).$map(nxtM=>({value:Q.$setContainsString(["authors","languages"],nxtM)?Q.$capitalizeName(nxtM.value):nxtM.value,searchId:nxtM.value}))).$flatten(),{icon:getIcon(nxtGrp),group:nxtGrp,label:"year"===nxtGrp?"Year of publication":Q.$capitalizeFirstLetter(nxtGrp)+":",values:values}}).$reduce(nxt=>!Q.$isEmpty(nxt.values)),Q.$isEmpty(currentDoc.tags)||scope.items.push({icon:getIcon("categories"),group:"tags",label:"Tags",values:Q.$map(currentDoc.tags,nxt=>({value:nxt.name,searchId:nxt.name}))})):scope.items=Q.$asCollection([])}function getIcon(group){let gr=group.toLowerCase();return"collections"===gr?"fas fa-sitemap":"authors"===gr?"fas fa-pen-nib":"year"===gr?"fas fa-calendar":"categories"===gr?"fas fa-hashtag":"languages"===gr?"fas fa-globe":""}$export(DocMenu),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MainMenu extends awr.Component{static get $require(){return{}}constructor(){super(MainMenu.$require),this.controller="MainMenu",this.template="app/shared/components/main-menu/main-menu.hbs",this.scope={}}}$export(MainMenu),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class MainMenu extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope",remoteCnf:"config:remoteConnectionConfig",roleHelper:"service:roleHelper"}}constructor(data,parent){super(MainMenu.$require,data,parent);let{superScope:superScope,remoteCnf:remoteCnf}=this,scope=this;scope.$importProperty("currentUser"),Object.defineProperty(this,"publishers",{get:()=>Q.$asCollection(Q.$arrayExists(superScope.cachedPublishers)?superScope.cachedPublishers:[])}),setupMenuItems(scope),scope.$bind("observable:authEvents",{onEvent(event,preventDefault){preventDefault(),Q.$objectExist(event)&&Q.$setContainsString(["sign-in","sign-out"],event.type)&&("sign-in"===event.type?(scope.currentUser=event.user,setupMenuItems(scope)):"sign-out"===event.type&&(scope.currentUser=null,setupMenuItems(scope)),setTimeout(_=>{scope.$recompile()},0))}})}toggleMenu(){this.$preventDefault();let menu=$(this.$getDom()).find(".main-menu-expand"),toggle=$(this.$getDom()).find(".main-menu.menu-toggle");$(menu).animate({width:"toggle"},165,function(){$(menu).hasClass("on")?($(menu).removeClass("on"),$(toggle).removeClass("open")):($(menu).addClass("on"),$(toggle).addClass("open"))})}action(id){this.$preventDefault();let collsGroup,{superScope:superScope}=this;Q.$setContainsString(["signIn","signUp"],id)?Q.$functionExist(superScope.redirectToAuth)&&superScope.redirectToAuth.call(superScope,id):"scrollTop"===id?superScope.scrollToTop():"myShelf"===id?superScope.openMyShelf():"myCollections"===id?superScope.openMyCollections():"principles"===id?superScope.openPrinciples():"github"===id?window.open("https://github.com/Pageprism/pageprism","_blank"):"controls"===id?superScope.openControls():"colls"===id&&(collsGroup=$(this.$getDom()).find(".mv-item-container.colls-parent"),$(collsGroup).toggleClass("open",!$(collsGroup).hasClass("open")))}}function setupMenuItems(scope){let{superScope:superScope,roleHelper:roleHelper}=scope;scope.items=Q.$asCollection([{name:"Scroll to top",id:"scrollTop",icon:"fa fa-arrow-circle-up",class:"scroll-top"},{name:"Code",id:"github",icon:"fab fa-github"},{name:"principles",id:"principles",icon:"far fa-lightbulb"},{name:"collections",id:"colls",icon:"fa fa-sitemap",isCollections:!0},{name:"Sign in",id:"signIn",icon:"fas fa-sign-in-alt"},{name:"Register",id:"signUp",icon:"fas fa-user-plus"},{name:"My Shelf",id:"myShelf",icon:"fa fa-book-open"},{name:"My Collections",id:"myCollections",icon:"fas fa-boxes"},{name:"Controls",id:"controls",icon:"fa fa-wrench"}]),Q.$objectExist(scope.currentUser)?(scope.items=scope.items.$reduce(nxt=>!Q.$setContainsString(["signIn","signUp"],nxt.id)),roleHelper.canOwnPersonalCollections(scope.currentUser)||roleHelper.hasRole(scope,scope.currentUser.id,"creator")||roleHelper.hasRole(scope,scope.currentUser.id,"moderator")||roleHelper.hasRole(scope,scope.currentUser.id,"publisher")||(scope.items=scope.items.$reduce(nxt=>!Q.$setContainsString(["myShelf"],nxt.id)))):scope.items=scope.items.$reduce(nxt=>!Q.$setContainsString(["controls","myShelf","myCollections"],nxt.id))}$export(MainMenu),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class MenuCollections extends awr.Component{static get $require(){return{}}constructor(){super(MenuCollections.$require),this.controller="MenuCollections",this.template="app/shared/components/menu-collections/menu-collections.hbs",this.scope={}}}$export(MenuCollections),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class MenuCollections extends awr.Controller{static get $require(){return{collFetcher:"service:collectionFetcher",superScope:"object:awr.superScope",router:"service:router"}}constructor(data,parent){super(MenuCollections.$require,data,parent);let{collFetcher:collFetcher,superScope:superScope,router:router,screen:screen}=this,scope=this;updateView(scope,collFetcher,!1,!1),this.$bind("observable:collectionEvents",{onEvent(event,preventDefault){preventDefault(),"new-current"===event.name&&updateView(scope,collFetcher,!1,!1)}}),this.$bind("model:MyCollection",{onEvent(event,preventDefault){preventDefault(),Q.$setContainsString(["remove","create","save"],event.requestType)&&updateView(scope,collFetcher,!0,!0)}}),this.$init(_=>{let bodyHeight=$("body").height(),maxHeight=Math.min(600,Math.max(200,bodyHeight-238));$(this.$getDom()).find(".item-container").css("maxHeight",`${maxHeight}px`)})}openCollection(event,collId){this.$preventDefault();let{superScope:superScope}=this;$(this.$getDom()).find(".coll-item").removeClass("selected"),$(this.$getDom()).find(`.coll-item[data-cl-id='${collId}']`).addClass("selected"),superScope.openCollection(collId)}editColls(){this.$preventDefault();let{router:router}=this;router.$go("my-collections-view",{params:{cId:"index"},attrs:{}},!0)}}function updateView(scope,collFetcher,refresh=!1,isSave=!1){let cr,newHash,now,time=(new Date).getTime()+500;scope.colls=Q.$asCollection([]),collFetcher.findAll(refresh).then(res=>{scope.colls=res.$map(nxt=>(cr=collFetcher.getCurrent(),nxt.isCurrent=cr&&Q.$idEqual(cr.id,nxt.id),nxt)).$reduce(nxt=>nxt.name&&"principles"!==nxt.name.toLowerCase()),newHash=scope.colls.map(nxt=>nxt.id).join("-"),!isSave&&Q.$stringExist(newHash)&&scope.hash===newHash||(scope.hash=newHash,(now=(new Date).getTime())<time?setTimeout(_=>{scope.$recompile()},500):scope.$recompile())},err=>{})}$export(MenuCollections),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class PrivacyPolicyModal extends awr.Component{static get $require(){return{}}constructor(){super(PrivacyPolicyModal.$require),this.template="app/shared/components/privacy-policy-modal/privacy-policy-modal.hbs",this.controller="PrivacyPolicyModal"}}$export(PrivacyPolicyModal),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},$=(awr.Q,$import("window:jQuery"));class PrivacyPolicyModal extends awr.Controller{static get $require(){return{modal:"service:modal",superScope:"object:awr.superScope"}}constructor(data,parent){super(PrivacyPolicyModal.$require,data,parent);this.$disableDefaultActionAutoRecompile()}agree(){let{modal:modal,superScope:superScope}=this;$(superScope.$getDom()).find('input[type="checkbox"]').each((idx,elem)=>{"acceptTerms"!==$(elem).attr("name")||$(elem).prop("checked")||$(elem).trigger("click")}),setTimeout(_=>{modal.$exit()},0)}}$export(PrivacyPolicyModal),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class PsHeader extends awr.Component{static get $require(){return{}}constructor(){super(PsHeader.$require),this.controller="PsHeader",this.template="app/shared/components/ps-header/ps-header.hbs",this.scope={}}}$export(PsHeader),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class PsHeader extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope",router:"service:router"}}constructor(data,parent){super(PsHeader.$require,data,parent);let{superScope:superScope}=this,scope=this;scope.brandText=Q.$objectExist(superScope.currentDoc)&&Q.$stringExist(superScope.currentDoc.title)?superScope.currentDoc.title:"Pageshare",scope.hasDocMenu=Q.$objectExist(superScope.currentDoc),scope.$bind("observable:start@states@router",{onEvent(event,preventDefault){preventDefault(),scope.brandText="Pageshare",scope.hasDocMenu=!1,$(scope.$getDom()).find(".navbar-brand .text").text(scope.brandText),$(scope.$getDom()).find(".ps-header").toggleClass("has-doc-menu",scope.hasDocMenu)}}),scope.$bind("observable:collectionEvents",{onEvent(event,preventDefault){preventDefault(),"new-doc-selected"===event.name&&(event.doc&&Q.$stringExist(event.doc.title)?scope.brandText=event.doc.title:scope.brandText="Pageshare",scope.hasDocMenu=Q.$objectExist(superScope.currentDoc),$(scope.$getDom()).find(".navbar-brand .text").text(scope.brandText),$(scope.$getDom()).find(".ps-header").toggleClass("has-doc-menu",scope.hasDocMenu))}})}brandClick(){this.$preventDefault();let{router:router}=this;router.$goDefault()}toggleDocMenu(){this.$preventDefault();let menu=$(this.$getDom()).find(".ps-header .doc-menu"),parent=$(this.$getDom()).find(".ps-header");$(menu).animate({height:"toggle"},165,function(){$(parent).hasClass("doc-menu-open")?$(parent).removeClass("doc-menu-open"):$(parent).addClass("doc-menu-open")})}}$export(PsHeader),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class Shelf extends awr.Component{static get $require(){return{}}constructor(){super(Shelf.$require),this.controller="Shelf",this.template="app/shared/components/shelf/shelf.hbs",this.scope={}}}$export(Shelf),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class Shelf extends awr.Controller{static get $require(){return{remoteCnf:"config:remoteConnectionConfig",superScope:"object:awr.superScope",router:"service:router",viewUpdater:"service:shelfViewUpdater",psDocEvents:"observable:psDocEvents"}}constructor(data,parent){super(Shelf.$require,data,parent);let inControls,sectionName,{superScope:superScope,router:router,viewUpdater:viewUpdater,psDocEvents:psDocEvents}=this,scope=this,currentLeftScroll=0,ctrEnv=getCtrEnv(router.$getCurrentState());viewUpdater.setScopeItems(this,null),viewUpdater.update(this),this.isShelf=!0,this.inControls=ctrEnv.inControls,this.sectionName=ctrEnv.sectionName,this.cSections=[{name:"saved",id:"bookmarks",icon:"fas fa-bookmark"},{name:"tags",id:"tags",icon:"fas fa-hashtag"},{name:"users",id:"users",icon:"fas fa-user-friends"},{name:"My Publisher",id:"my-publisher",icon:"fas fa-cloud-upload-alt"},{name:"invite",id:"invite",icon:"fas fa-plus"}],inControls=this.inControls,sectionName=this.sectionName,this.$bind(psDocEvents,{onEvent(event,preventDefault){preventDefault(),Q.$setContainsString(["ps-doc:start-processing","ps-doc:end-processing"],event.name)?viewUpdater.handleItemBusyModes(scope,event):Q.$objectExist(event.target)&&Q.$objectExist(scope.coll)&&Q.$setContainsNumber(event.target.collection_membership,scope.coll.id)&&(docInShelf(scope,{modelInstance:event.target})||!event.name.endsWith("new")&&"ps-doc:publish"!==event.name?event.name.endsWith("remove")&&docInShelf(scope,{modelInstance:event.target})?viewUpdater.removeItem(scope,event.target_id):event.name.endsWith("unpublish")&&docInShelf(scope,{modelInstance:event.target})&&viewUpdater.removeItemIfNotAvailable(scope,event.target_id):(scope.coll.stories.push(event.target),viewUpdater.addItem(scope,event.target_id)))}}),this.$bind("observable:collectionEvents",{onEvent(event,preventDefault){preventDefault(),"new-current"===event.name?viewUpdater.update(scope):"new-doc-selected"!==event.name||Q.$isEmpty(scope.stories)||($(scope.$getDom()).find(".shelf-item").removeClass("selected"),Q.$objectExist(event.doc)&&scope.stories.$count(nxt=>event.doc&&nxt.id==event.doc.id)>0&&($(scope.$getDom()).find(`.shelf-item[data-doc-id='${event.doc.id}']`).addClass("selected"),viewUpdater.setScopeItems(scope,scope.coll)))}}),this.$bind("model:Collection",{onEvent(event,preventDefault){preventDefault(),scope.inControls||"findAll"===event.requestType&&viewUpdater.update(scope)}}),this.$bind("observable:start@states@router",{onEvent(event,preventDefault){preventDefault(),currentLeftScroll=$(this.$getDom()).find(".shelf").scrollLeft()}}),this.$bind("observable:success@states@router",{onEvent(event,preventDefault){preventDefault();let ctrEnv=getCtrEnv(event.to);inControls=ctrEnv.inControls,sectionName=ctrEnv.sectionName,(inControls||scope.inControls)&&(scope.inControls===inControls&&Q.$stringExist(scope.sectionName)&&scope.sectionName===sectionName||(scope.inControls=inControls,scope.sectionName=sectionName,scope.$recompile()))}}),this.$init(_=>{Q.$each(this.stories,nxt=>{let item=$(scope.$getDom()).find(`.shelf-item[data-doc-id="${nxt.id}"]`);Q.$booleanTrue(nxt.is_busy)&&($(item).removeClass("loading"),$(item).addClass("processing"))}),$(this.$getDom()).find(".shelf").scrollLeft(currentLeftScroll)}),this.$bind("observable:authEvents",{onEvent(event,preventDefault){preventDefault(),"sign-in"===event.type||"sign-out"===event.type&&$(scope.$getDom()).find(".shelf-item.add-doc").removeClass("on")}})}openCSection(id){this.$preventDefault();let{router:router}=this,state=router.$getCurrentState();"controls-view"===state.name&&state.params.section===id||Q.$setContainsString(["users","bookmarks","tags","invite","my-publisher"],id)&&router.$go(`${id}-view`,{params:{}},!0)}openDoc(docId,title){let{superScope:superScope}=this;this.$preventDefault(),Q.$exist(docId)&&($(this.$getDom()).find(".shelf-item").removeClass("selected"),$(this.$getDom()).find(`.shelf-item[data-doc-id='${docId}']`).addClass("selected"),superScope.openDoc(docId,title))}coverLoaded(docId){this.$preventDefault(),Q.$exist(docId)&&$(this.$getDom()).find(`.shelf-item[data-doc-id='${docId}']`).removeClass("loading")}}function getCtrEnv(state){let inControls=state&&Q.$setContainsString(["tags-view","users-view","bookmarks-view","invite-view","my-publisher-view"],state.name);return{inControls:inControls,sectionName:inControls?state.name.replace("-view",""):null}}function docInShelf(scope,event){return Q.$objectExist(event.modelInstance)&&!Q.$isEmpty(scope.stories)&&scope.stories.$count(nxt=>parseInt(nxt.id)===parseInt(event.modelInstance.id))>0}$export(Shelf),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class SmallNotifModal extends awr.Component{static get $require(){return{}}constructor(){super(SmallNotifModal.$require),this.controller="SmallNotifModal",this.template="app/shared/components/small-notif-modal/small-notif-modal.hbs",this.scope={}}}$export(SmallNotifModal),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class SmallNotifModal extends awr.Controller{static get $require(){return{}}constructor(data,parent){super(SmallNotifModal.$require,data,parent);let scope=this,parentScope=this.$getParent();scope.body=Q.$objectExist(parentScope.scopeBody)?parentScope.scopeBody:{},scope.$ready(_=>{let parentScopeReadyDom=$(scope.$getDom()).parent().parent();!scope.body.showRemove&&Q.$arrayNotEmpty(parentScopeReadyDom)&&$(parentScopeReadyDom).find("#awrModalRmBtn").addClass("hidden"),$(scope.$getDom()).find("p.msg-p").removeClass("hidden")})}}$export(SmallNotifModal),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class UserMenu extends awr.Component{static get $require(){return{}}constructor(){super(UserMenu.$require),this.controller="UserMenu",this.template="app/shared/components/user-menu/user-menu.hbs",this.scope={}}}$export(UserMenu),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q,$=$import("window:jQuery");class UserMenu extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope",remoteCnf:"config:remoteConnectionConfig"}}constructor(data,parent){super(UserMenu.$require,data,parent);let{superScope:superScope,remoteCnf:remoteCnf}=this,scope=this;scope.$importProperty("currentUser"),setupScopeUser(scope),scope.$bind("observable:authEvents",{onEvent(event,preventDefault){preventDefault(),Q.$objectExist(event)&&Q.$setContainsString(["sign-in","sign-out"],event.type)&&("sign-in"===event.type?(scope.currentUser=event.user,setupScopeUser(scope)):"sign-out"===event.type&&(scope.currentUser=null,setupScopeUser(scope)),scope.$recompile())}})}toggleUserMenu(){this.$preventDefault();let menu=$(this.$getDom()).find(".user-menu-expand");$(menu).animate({height:"toggle"},165,function(){$(menu).hasClass("on")?$(menu).removeClass("on"):$(menu).addClass("on")})}}function setupScopeUser(scope){let current=scope.currentUser;Q.$objectExist(current)?(scope.user={},scope.user.fullName=Q.$capitalizeName(current.name),scope.user.nickname=Q.$stringExist(scope.user.fullName)?current.name.split(" ")[0]:"",scope.user.email=Q.$stringExist(current.email)?current.email:"",scope.user.isAdmin=!1,Q.$isEmpty(current.roles)||(scope.user.isAdmin=Q.$asCollection(current.roles).$count(nxt=>"admin@pageshare"===nxt.name)>0)):scope.user=null}$export(UserMenu),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{};awr.Q;class ShelfItem extends awr.Segment{static get $require(){return{}}constructor(){super(ShelfItem.$require),this.itemAs="item",this.template="app/shared/segments/shelf-item/shelf-item.hbs",this.bind="",this.bindOptions={}}setup(){}start(){}ready(){}}$export(ShelfItem),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){let awr=window.awr||{},Q=awr.Q;class Errors extends awr.Controller{static get $require(){return{superScope:"object:awr.superScope"}}constructor(data,parent){super(Errors.$require,data,parent);let{$state:$state,superScope:superScope}=this;this.code=$state.params.code,Q.$objectExist(superScope.currentUser)&&"e2"===this.code&&(this.code="404")}}$export(Errors),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){(window.awr||{}).Q;$import("service:router").$route({name:"errors-view",link:"errors/:code?",template:"app/shared/views/errors/errors_index.hbs",defaults:{params:{code:"404"},attrs:{}},resolve:{},controller:"ErrorsController"}),__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}(),function(){var __$$requires$$__=[];__pushToBootQueue__(function(){var global;(global=window).emptyTpls=global.emptyTpls||0,global.emptyTpls++,__callModuleMainFn__("function"==typeof $main?$main:null,__$$requires$$__)})}()}(window,jQuery);