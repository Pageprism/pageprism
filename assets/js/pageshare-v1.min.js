/**
 *	Pageshare-App v1.8
 *	Developed using liteUX library, by Awiar Solutions
 *	Say hello to hello@awiarsolutions.com
 *
 *   Report bugs and feature requests: https://bug.awiar.net
 *
 *	@author: kavan Soleimanbeigi
 *	@email: solxiom@gmail.com
 */
!function(a,b){function c(){function a(a,b){return a.user_name=b.name,a.user_id=b.id,a.user_email=b.email,a.main_collection=b.main_collection,a.user_modified=b.modified,a.user_last_login=b.last_login,a}function c(){var a=null;if("premium"!==b("body").attr("id"))return null;try{a=JSON.parse(localStorage.getItem("pageshare_user"))}catch(a){}return a}function g(a){null===a?localStorage.setItem("pageshare_user",null):a&&void 0!==a.name&&void 0!==a.email&&localStorage.setItem("pageshare_user",JSON.stringify(a))}function h(){localStorage.setItem("pageshare_user",null)}function i(){var a;e.$objectExist(f.currentCollection)&&e.$arrayNotEmpty(f.collections)&&(a=e.$collect(f.collections,function(a){return a=a||null,e.$stringEqual(f.currentCollection.id+"",this.id+"")&&(a=this),a}),e.$objectExist(a)&&(f.currentCollection=a)),"premium"!==b("body").attr("id")?f.UI.reload(!0):(f.UI.reload(!0),f.basicModal.stop())}var j=this,k=null;j.wrongUser=function(){h(),j.login()},j.login=function(a){a=a||{};var d=null;a&&a instanceof Event&&(d=a,a={},d.preventDefault());var e=void 0!==l&&null!==l,l=c(),m=Pageshare.Templates["assets/modules/activeLogin/activeLoginForm.hbs"],n=b('<div class="error"></div>'),o=b(m({defaultView:!0,hasUser:null!==l,userName:e?l.name:null,userEmail:e?l.email:null})),p=function(c){var d=new FormData(b("form.login-form")[0]),e="on"===d.get("saveUser");if("premium"!==b("body").attr("id")&&g(null),l&&d.append("user",b('input[name="saved-user"]').val()),d.get("user")&&""!==d.get("user")&&d.get("password")&&""!==d.get("password"))"premium"!==b("body").attr("id")?k.busy():(o=b(m({busyView:!0})),f.basicModal.busy({message:o,isInfo:!0})),setTimeout(function(){b.ajax({url:"/admin/auth/active_login",type:"POST",data:d,async:!0,cache:!1,contentType:!1,processData:!1,success:function(c){e?g({name:c.user.user_name,email:c.user.user_email}):h(),f.currentUser=c.user,o=b(m({successView:!0})),"premium"!==b("body").attr("id")||f.basicModal.update({title:"<h1 class='fa fa-lock'> Sign in</h1> ",message:o}),a&&"function"==typeof a.success&&a.success(),f.collServer.findAllCollections(function(a){f.collections=a,i()},function(){i()})},error:function(a){a=a.responseJSON||{error:a.responseText},l&&(a.error="Login failed!"),o=b(m({defaultView:!0,hasError:!0,errorMsg:a.error,hasUser:null!==l,userName:l?l.name:null,userEmail:l?l.email:null})),"function"==typeof c&&c(a.error),"premium"===b("body").attr("id")&&f.basicModal.release({title:"<h1 class='fa fa-lock'> Sign in</h1> ",message:o});var e=b('.login-form input[name="user"]'),g=b('.login-form input[type="password"]');l||(b(e).css("border-color","red"),b(e).css("color","red"),b(e).val(d.get("user"))),b(g).css("border-color","red"),b(g).css("color","red"),b(g).val(d.get("password"))}})},500);else{var j="Username and password are required and should not be empty!";l&&(j="Password is required and should not be empty!"),o=b(m({defaultView:!0,hasError:!0,errorMsg:j,hasUser:null!==l,userName:l?l.name:null,userEmail:l?l.email:null})),"premium"!==b("body").attr("id")||f.basicModal.release({title:"<h1 class='fa fa-lock'> Sign in</h1> ",message:o}),"function"==typeof c&&c(j)}};if("premium"!==b("body")){var q=b(o),r=b('<span class="awr-btn">Log in</span>');b(r).on("click",function(){p(function(a){j.login();var c=b('<span class="field text-danger fa fa-remove">&nbsp;'+a+"</span>");b(n).append(c),b(".community-login").append(n)})}),b(q).append(r),b(".community-login").html(q)}else f.basicModal.start({mainClass:"active-login",actionName:"Sign in",actionClass:"btn-primary",isInfo:!1,action:p}),f.basicModal.update({title:"<h1 class='fa fa-lock'> Sign in</h1> ",message:o})},j.toggleCommunityAuthUI=function(){k=f.communityAuthUIDriver,"premium"!==b("body").attr("id")&&(k.start({}),k.busy(),setTimeout(function(){k.update({currentUser:f.currentUser}),f.mainHeader.reload()},500))},j.findCurrentUser=function(c){var e=null,g=d.importClass("RemoteModel"),h=new g({api_path:"api",url:"user"});b.ajax({url:"admin/auth/active_user",type:"GET",async:!0,cache:!1,contentType:!1,processData:!1,success:function(b){h.$findOne(b.user_id).then(function(d){if(e=a(b,d),f.currentUser=e,j.toggleCommunityAuthUI(),"function"==typeof c)return c(e)})},error:function(a){if(f.currentUser=null,"function"==typeof c)return c(null)}})},j.logout=function(a){var c=null;(a=a||{})&&a instanceof Event&&(c=a,a={},c.preventDefault());var d=Pageshare.Templates["assets/modules/activeLogin/activeLoginForm.hbs"],e=b(d({logoutView:!0}));"premium"!==b("body").attr("id")?f.communityAuthUIDriver.busy():(f.basicModal.start({mainClass:"active-login",isInfo:!0,action:null}),f.basicModal.busy({title:"<h1 class='fa fa-lock'> Sign out</h1> ",message:e})),b.ajax({url:"/logout",type:"GET",async:!0,cache:!1,success:function(b){f.currentUser=null,a&&"function"==typeof a.success&&a.success(),i()},error:function(a){a=a.responseJSON||{error:a.responseText};var c=b(d({logoutErrorView:!0,hasError:!0,errorMsg:a.error}));setTimeout(function(){i(),"premium"===b("body").attr("id")&&f.basicModal.release({message:c})},1e3)}})}}var d=a.awr||{},e=d.Q,f=a.pageshare||{};f.activeLogin=new c,a.pageshare=f}(window,jQuery),function(a,b){function c(){d()}function d(){g.router.config({mode:"hash",prefix:"app"}),g.router.on("onStateBusy",function(){b("body > #contents").hide(),b("body > #loading").show(),b("body").removeClass("awr-ready"),b("body").addClass("awr-busy")}),g.router.listen().route({name:"default",link:"?:v",runner:function(a){f.openFirstCover()}}).route({name:"coll-index",link:"c/:cId",defaultParams:{cId:"index"},replaceNullString:!0,runner:function(a){var b=a.params||{},c=b.cId;h.$setContainsString(["index","aggregated","aggregated-collection","undefined","null","not-found"],c+"")?(f.currentCollection=null,f.appStart(!0)):h.$stringExist(c+"")?(f.mainMenu.setSelected(c),f.collServer.loadAsCurrentCollection(c,function(a){if(a){var b=a&&a.docs?a.docs:null,d=b&&b.length?b[0]:null;d=f.collServer.fixMissingLegacyDocAPI(d);var e=d&&d.book_name?d.book_name:"not_found",h=d&&d.id?d.id:"0";g.router.go("doc-link",{params:{docId:h,docName:e},attrs:{c:c}})}else f.UI.showNotFound()},function(a){g.errorLog("appStart@UI@app","failed to load main collection for current user",a),f.UI.showNotFound()})):f.UI.showNotFound()}}).route({name:"add-doc",link:"collection/:cId/add",defaultParams:{},replaceNullString:!0,runner:function(a){var b=a.params||{},c=b.cId;f.shelfCtrl.close(),f.UI.show(function(){f.docForm.start(c)})}}).route({name:"share-link",link:"share/:docName/:docId/:pageNumber?:c",defaultParams:{pageNumber:"index",docId:"index"},replaceNullString:!0,runner:function(a){var b=(a.params,a.attrs||{});h.$or(h.$booleanFalse(h.$stringExist(b.c+"")),h.$setContainsString(["undefined","null","0","-1",""],b.c+""))&&(a.attrs.c="index",g.router.go("share-link",a,!1)),(new e).openByIgnoreLegacy(a)}}).route({name:"share-legacy-link",link:"share/legacy/:docName/:docId/:pageNumber?",defaultParams:{pageNumber:"index",docId:"index"},replaceNullString:!0,runner:function(a){var b=(a.params,a.attrs||{});h.$or(h.$booleanFalse(h.$stringExist(b.c+"")),h.$setContainsString(["undefined","null","0","-1",""],b.c+""))&&(a.attrs.c="index",g.router.go("share-legacy-link",a,!1)),(new e).openByPreferLegacy(a)}}).route({name:"doc-link",link:"v/:docName/:docId/:pageNumber?:c",defaultParams:{pageNumber:"index",docId:"index"},replaceNullString:!0,runner:function(a){var b=(a.params,a.attrs||{});h.$or(h.$booleanFalse(h.$stringExist(b.c+"")),h.$setContainsString(["undefined","null","0","-1",""],b.c+""))&&(a.attrs.c="index",g.router.go("doc-link",a,!1)),(new e).openByPreferLegacy(a)}}).route({name:"tag-search",link:"collect/tag/:group/:query?:current",defaultParams:{group:"any"},replaceNullString:!0,runner:function(a){h.$waitForComps({name:"pageshare.simpleSearch",type:"object"}).then(function(){f.simpleSearch.start(a)},function(){})}}).route({name:"easy-signup",link:"signup/basic?:b_name&:b_ref",runner:function(a){a.params,a.attrs;f.UI.show(),f.easySignup.start()}}).route({name:"collections-edit",link:"collections/edit?:view",runner:function(a){a.params,a.attrs;f.UI.show(function(){f.editCollections.start()},{hideShelf:!0})}}).route({name:"doc-edit",link:"edit/:docId?:view",runner:function(a){var b=a.params||{},c=a.attrs||{};h.$or(h.$booleanFalse(h.$stringExist(c.view)),h.$setContainsString(["undefined","null","0","-1",""],c.view+""))&&(a.attrs.view="open",g.router.go("doc-edit",a,!1));var d=b.docId&&(b.docId.startsWith("doc-")||b.docId.startsWith("d")),e={success:function(a){f.docEdit.edit(a),f.UI.show()}};b.docId&&(d?(e.doc_id=b.docId,e.doc_id=e.doc_id.startsWith("doc-")?e.doc_id.replace("doc-",""):e.doc_id.startsWith("d")?e.doc_id.replace("d",""):e.doc_id):e.id=b.docId,f.docServer.findDoc(e))}}).route({name:"invite-view",link:"invite/:view",runner:function(a){a.params,a.attrs;f.UI.hide(),f.UI.show(function(){if(!f.currentUser||f.currentUser.is_admin!==!0)return void g.router.go("default",{},!0);f.shelfCtrl.close(),f.inviteView.start(),g.router.go("invite-view",{params:{view:"index"}},!1)})}})}function e(){function a(a){return h.$stringExist(a+"")?a.startsWith("d")&&!a.startsWith("doc-")?a.replace("d","doc-"):a:"-1"}function b(a){var b=h.$stringExist(a+"")&&h.$numberExist(parseInt(a)),c=h.$stringExist(a)&&a.startsWith("d"),d=h.$stringExist(a)&&a.startsWith("doc-");return b?"doc-"+a:c&&!d?a.replace("d","doc-"):d?a:"-1"}function c(a){var b=h.$stringExist(a)&&h.$stringEqual(a,"index"),c=h.$stringExist(a)&&a.startsWith("p")&&h.$numberExist(parseInt(a.replace("p","")));return b||c}function d(a,b){h.$qTry(function(){f.UI.openDocInReader(a,b).then(function(){},function(a){g.errorLog("route@openDocLink@UI@app",a," Forwarded error.")})},function(a){g.errorLog("route@config@UI@app","Error stopped attempt for opening a direct doc link in reader. \n\t + Details: "+a)})}function e(b){var e=b.params||{},f=(b.attrs,e.docId),i=e.pageNumber;if(i=c(i)?i:"p1",f=a(f),h.$stringEqual(f,"-1"))return void g.errorLog("route@config@UI@app","direct doc link not valid for doc-link state. \n\t +Details: Bad value for [docId].");d(f,i)}function i(a){var e=a.params||{},f=(a.attrs,e.docId),i=e.pageNumber;if(f=b(f),i=c(i)?i:"p1",h.$stringEqual(f,"-1"))return void g.errorLog("route@config@UI@app","direct doc link not valid for doc-link state. \n\t +Details: Bad value for [docId].");d(f,i)}return{openByPreferLegacy:e,openByIgnoreLegacy:i}}var f=a.pageshare||{},g=a.awr||{},h=g.Q;f.basicModal=g.basicModal,f.appConfig=c}(window,jQuery),function(a,b){function c(a){var b=i.$arrayNotEmpty(a)?i.$collect(a,function(a){return a=i.$stringEqual(this.id,g.currentUser.main_collection)?this:a}):null;return!i.$objectExist(b)&&i.$arrayNotEmpty(a)?a[0]:b}function d(){var a=h.router.getCurrentState(),b=i.$objectExist(a)&&i.$stringExist(a.link)&&!i.$stringEqual(a.name,"default");return i.$booleanFalse(b)}function e(a){var b=h.router.getCurrentState(),d=i.$objectExist(b.attrs)&&i.$stringExist(b.attrs.c+"")?b.attrs.c:null;i.$stringExist(d)?g.currentCollection=i.$collect(a,function(a){if(i.$stringEqual(this.id+"",d+""))return this}):i.$objectExist(g.currentCollection)||(i.$objectExist(g.currentUser)?g.currentCollection=c(a):g.currentCollection=a[0])}function f(){if(!g.currentCollection)return[];var a=g.currentCollection.docs,b=g.currentUser;return a=i.$arrayExist(a)?a:[],i.$reduce(a,function(){var a=i.$stringEqual(this.visibility+"","1")||i.$stringEqual(this.public+"","1"),c=i.$objectExist(b)&&(i.$stringEqual(this.owner_id,b.user_id)||i.$stringEqual(this.author_id,b.user_id));return i.$booleanTrue(a)||i.$booleanTrue(c)})}var g=a.pageshare||{},h=a.awr||{},i=h.Q;b(document).ready(function(){i.$waitForComps({name:"awr.routeManager",type:"object"}).then(function(){setTimeout(function(){g.appConfig(),g.UI.reloadMainHeader(),g.appStart()},300)},function(a){console.error("Failed to init APP! \n\t + Details: "+a)})}),g.appStart=function(a){i.$qTry(function(){Handlebars.registerHelper("shorten",function(a){return a&&a.length>40&&(a=a.slice(0,37)+"..."),a})},function(a){console.error("@APPStart: failed to register Handlebar helper[shorten].\\t + Details:"+a)}),g.getAppData().then(function(){var b=i.$booleanTrue(a)?a:d();e(g.collections),i.$booleanTrue(b)?setTimeout(function(){i.$objectExist(g.currentCollection)&&i.$stringExist(g.currentCollection.id+"")?h.router.pushLink("/app#c/"+g.currentCollection.id):i.$arrayNotEmpty(g.collections)&&h.router.pushLink("/app#c/"+g.collections[0].id)},200):g.UI.initUI(!1,function(){h.router.reloadCurrentState()})})},g.openFirstCover=function(){var a,b;g.UI.hide(),g.activeLogin.findCurrentUser(function(c){a=f(),i.$arrayNotEmpty(a)?(b=a[0],h.router.go("doc-link",{params:{docName:b.book_name,docId:b.id,pageNumber:"index"}},!0)):g.UI.showNotFound(!0)})},g.findIndexCover=function(){var a=f();return i.$arrayNotEmpty(a)?a[0]:null},g.getUserMainCollection=function(){return c(g.collections)},g.getAppData=function(){return new Promise(function(a,b){g.activeLogin.findCurrentUser(function(b){g.currentUser=b,g.collServer.findAllCollections(function(b){a("done")})})})}}(window,jQuery),function(a){"use strict";function b(){function b(a,b){var d;r.$findAll().then(function(b){e(b,a),p.$objectExist(pageshare.currentCollection)&&(d=p.$collect(pageshare.collections,function(a){return a=a||null,p.$stringEqual(pageshare.currentCollection.id,this.id)&&(a=this),a}),pageshare.currentCollection=p.$objectExist(d)?d:pageshare.currentCollection)},function(a){var d=a&&a.statusText?a.statusText:p.$functionExist(a.toString)?a.toString():"";c.errorLog("findAllCollections@collServer@app","Failed to fetch collections from server",d),p.$functionExist(b)&&b(a)})}function d(a,b,d){r.$findOne(a).then(function(a){a.docs=p.$map(a.docs,function(){return this.book_name=this.name,this}),p.$functionExist(b)&&b(a)},function(a){var b=a&&a.statusText?a.statusText:p.$functionExist(a.toString)?a.toString():"";c.errorLog("findDocsByCollections@collServer@app","Failed to fetch docs for collections from server",b),p.$functionExist(d)&&d(a)})}function e(a,b){var c=f(a);p.$objectExist(pageshare.currentUser)?(b(c),pageshare.mainMenu.reload()):p.$waitForComps({name:"pageshare.currentUser",type:"object"}).then(function(){c=f(a),p.$functionExist(b)&&(b(c),setTimeout(function(){pageshare.mainMenu.reload()},300))},function(a){b(c),pageshare.mainMenu.reload()})}function f(b){var c=pageshare.currentUser,d=p.$map(b,function(){this.docs=p.$arrayExist(this.docs)?this.docs:[];var a=p.$collect(this.docs,function(a){return a=a||0,(p.$stringEqual(this.visibility,"1")||p.$stringEqual(this.public,"1"))&&a++,a});a=p.$numberExist(a)?a:0;var b=p.$objectExist(c)&&p.$stringEqual(this.owner_id,c.user_id),d=b||a>0;if(p.$booleanTrue(d))return this});return d=j(d),a.collections=d,pageshare.collections=d,d}function g(a){pageshare.currentCollection=a,t=a}function h(a,b,d){var e,f=!1;p.$arrayNotEmpty(pageshare.collections)&&(e=p.$collect(pageshare.collections,function(b){return b=b||null,p.$stringEqual(a+"",this.id+"")&&(b=this),b}),p.$objectExist(e)&&(g(e),p.$functionExist(b)&&(f=!0,p.$qTry(function(){b(e)},function(a){console.error("loadAsCurrentCollection@collServer@App: Bad success callback. \n\t + Details: "+a)})))),r.$findOne(a).then(function(c){c=j([c])[0],g(c),p.$arrayNotEmpty(pageshare.collections)&&(pageshare.collections=p.$map(pageshare.collections,function(){return p.$stringEqual(this.id+"",a+"")?c:this})),p.$functionExist(b)&&p.$booleanFalse(f)&&p.$qTry(function(){b(c)},function(a){console.error("loadAsCurrentCollection@collServer@App: Bad success callback. \n\t + Details: "+a)})},function(a){var b=a&&a.statusText?a.statusText:p.$functionExist(a.toString)?a.toString():"";c.errorLog("findDocsByCollections@collServer@app","Failed to load current collection from server",b),p.$functionExist(d)&&d(a)})}function i(a,b,d){var e;s.$findOne(pageshare.currentUser.user_id).then(function(a){r.$findAll().then(function(c){e=p.$collect(c,function(b){if(p.$stringEqual(a.main_collection+"",this.id))return this}),e=j([e])[0],g(e),p.$functionExist(b)&&b(e)},function(a){var b=a&&a.statusText?a.statusText:p.$functionExist(a.toString)?a.toString():"";c.errorLog("findAllCollections@collServer@app","Failed to fetch collections from server",b),p.$functionExist(d)&&d(a)})},function(a){})}function j(a){return p.$map(a,function(){return this.docs=l(this.docs),p.$arrayNotEmpty(this.docs)&&(this.docs=p.$map(this.docs,function(){var a=pageshare.docServer.isDocVisible(this);if(p.$or(a,k()))return this})),this})}function k(){return p.$objectExist(pageshare.currentUser)&&p.$booleanTrue(pageshare.currentUser.is_admin)}function l(a){var b=p.$arrayNotEmpty(a)?p.$map(a,function(){return this}):p.$objectExist(a)?[a]:[];return b=p.$map(b,function(){return n(this),p.$objectExist(this.book)||(this.book=p.$mapObject(this,function(){return this})),this}),p.$arrayExist(a)?b:p.$objectExist(a)?b[0]:null}function m(a){return n(a),p.$objectExist(a)?(a.id=p.$stringExist(a.id)&&a.id.startsWith("doc-")?a.id.replace("doc-","d"):a.id,a.book=p.$mapObject(a,function(){return this}),a):null}function n(a){if(!p.$objectExist(a))return null;a.name=p.$stringExist(a.name)?a.name:p.$stringExist(a.book_name)?a.book_name:p.$stringExist(a.book_name_clean)?a.book_name_clean:"No Name detected for this Doc!",a.book_name=a.book_name_clean=a.name}function o(){return{findDocsByCollection:d,findAllCollections:b,loadAsCurrentCollection:h,loadUserMainCollection:i,fixMissingLegacyDocAPI:m,getCurrentCollection:function(){return t}}}var p=this,q=c.importClass("RemoteModel"),r=new q({api_path:"api",url:"collection"}),s=new q({api_path:"api",url:"user"}),t=null;a.pageshare=a.pageshare||{},a.pageshare.collServer=new o,this.$qBundle.$createBundle("PageshareCollServerGroup",[{name:"pageshare.collServer",type:"object"}])}a.awr=a.awr||{},a.awr.bootQueue=a.awr.bootQueue||[];var c=a.awr||{},d=c.bootQueue,e=(a.jQuery,a.Promise,{moduleName:"$$collServer@Module",requires:[{name:"awr.$$appEssentials",type:"object"}],wTime:6e3,init:b,QAsContext:!0});d.push(e)}(window),function(a,b){function c(){function c(a){h.initLock=e.ux.initLock(h.initLock),h.initLock.setDuration(500),e.ux.execWithLock(h.initLock,function(){d(a)})}function d(a){a=a||{};var c=f.$objectExist(a.currentUser)&&a.currentUser.is_admin;b(j).find("#mainMenuLoginBtn").remove(),a.currentUser?(k=a.currentUser.user_name,n=!0):(n=!1,k=null),m=!1,l=b(i({loadingMode:!1,outMode:n,userName:k,isAdmin:f.$booleanTrue(c)})),b(j).append(l)}function g(a){var c=b(b(j));b(c).find("#mainMenuLoginBtn").remove(),l=b(i({loadingMode:!0})),b(c).append(l)}e=a.awr||{},f=e.Q;var h=this,i=Pageshare.Templates["assets/modules/communityAuthUIDriver/communityLoginBtn.hbs"],j="#mainMenu > .menu-content > ul",k="",l=null,m=!1,n=!1;return e.notifManager.implementOutDriver({onStart:c,onUpdate:c,onBusy:g,onRelease:c,onStop:function(a){b(b(j)).find("#mainMenuLoginBtn").remove()}})}var d=a.pageshare||{},e=a.awr||{},f=e.Q;d.communityAuthUIDriver=new c,a.pageshare=d}(window,jQuery),function(a,b){function c(c){function g(){if("form"===c.dataGroupType?v=new FormData(b(c.dataElement)[0]):"formData"===c.dataGroupType&&c.dataElement instanceof FormData&&(v=c.dataElement),v&&c.appends)for(var a in c.appends){var d=c.appends[a];v.append(a,"function"==typeof d?d():d)}return v}function h(){var a=new FormData,b=d.currentUser.user_id?d.currentUser.user_id:-1,c=g(),e=1===parseInt(c.get("public"))||"on"===c.get("public")?1:0,f=1===parseInt(c.get("allow_aggregating"))||"on"===c.get("allow_aggregating")?1:0;return a.append("user_id",b),a.append("doc_name",c.get("book_name")),a.append("shelf_id",c.get("shelf_id")),a.append("collection_id",c.get("shelf_id")),a.append("public",e),a.append("allow_aggregating",f),a}function i(){var a=new FormData,b=g(),c=1===parseInt(b.get("public"))||"on"===b.get("public")?1:0,d=1===parseInt(b.get("allow_aggregating"))||"on"===b.get("allow_aggregating")?1:0;return a.append("doc_id",b.get("doc_id")),a.append("doc_name",b.get("book_name")),a.append("shelf_id",b.get("shelf_id")),f.$exist(b.get("original_collection")&&f.$stringExist(b.get("original_collection")+""))?a.append("original_collection",b.get("original_collection")):a.append("original_collection",b.get("shelf_id")),a.append("collection_id",b.get("collection_id")),a.append("public",c),a.append("allow_aggregating",d),a}function j(){var a=new FormData,b=g();return a.append("doc_id",b.get("doc_id")),a.append("legacy_id",b.get("legacy_id")),a.append("pdf_path",b.get("pdf_path")),a.append("epub_path",b.get("epub_path")),a.append("audio_path",b.get("audio_path")),a}function k(){return"cmd/doc/init"}function l(){return"cmd/doc/update"}function m(){return"cmd/meta/save_meta"}function n(){return"cmd/doc/upload"}function o(){return"cmd/doc/upgrade_legacy"}function p(){return g().get("book_name")}function q(){return g().get("shelf_id")}function r(a){var b=g(),c={doc_id:b.get("doc_id"),doc_meta:{Languages:b.get("Languages").split(","),Authors:b.get("Authors").split(","),Categories:b.get("Categories").split(","),Meme:b.get("Meme").split(","),Designs:b.get("Designs").split(","),Print:b.get("Print").split(","),"Year of publication":b.get("pub_year")}};return a===!0?JSON.stringify(c):c}function s(){var a=t(),b=g(),c=[];return a.hasPdfFile&&c.push(b.get("pdffile")),a.hasEpubFile&&c.push(b.get("epubfile")),a.hasAudioFile&&c.push(b.get("audiozipfile")),c}function t(){var a=[],b=[],c=g(),d=c.get("book_name"),e=c.get("Authors"),f=3,h=c.get("pdffile"),i=c.get("epubfile"),j=c.get("audiozipfile");return(""===d||d.length<3)&&(a.push("Document / file name should not be empty!"),b.doc_name="Document / file name should not be empty!"),(""===e||e.length<3)&&(a.push("Specify at least one author for the new document!"),b.authors="Specify at least one author for the new document!"),(h.size<=0||""===h.name)&&(b.pdf_file="Pdf file not selected!",f--),(i.size<=0||""===i.name)&&(b.epub_file="Epub file not selected!",f--),(j.size<=0||""===j.name)&&(b.audio_file="Audio file not selected!",f--),f<=0&&(a.push("Select at least one document for upload!"),b.files="Select at least one document for upload!"),{error_msgs:a,warnings:b,errors_size:a.length,warnings_size:b.length,filesCount:f,hasDocName:void 0===b.doc_name,hasAuthors:void 0===b.authors,hasPdfFile:void 0===b.pdf_file,hasEpubFile:void 0===b.epub_file,hasAudioFile:void 0===b.audio_file}}function u(){return t().error_msgs.length<1}d=a.pageshare||{},e=a.awr||{},f=e.Q,c=c||{};var v=null;return{getData:g,getDocName:p,getDocInitForm:h,getDocUpdateForm:i,getDocMetaAsJSON:r,getDocInitUrl:k,getDocUpdateUrl:l,getDocMetaUrl:m,getLegacyUpgradeData:j,getLegacyUpgradeUrl:o,getFileUploadUrl:n,getCollectionId:q,getFiles:s,validate:t,isValid:u,append:function(a,d,e){"form"===c.dataGroupType&&c.dataElement?(b(b(c.dataElement)[0]).find('input[name="'+a+'"]').remove(),b(b(c.dataElement)[0]).append('<input type="hidden" name="'+a+'" value="'+d+'" />')):"formData"===c.dataGroupType&&c.dataElement instanceof FormData&&(c.dataElement.delete(a),c.dataElement.append(a,d)),void 0!==e&&"function"==typeof e.append&&e.append(a,d)}}}var d=a.pageshare||{},e=a.awr||{},f=e.Q;d.DocData=c}(window,jQuery),function(a,b){"use strict";function c(){function c(){for(var a=(new Date).getFullYear();a>=1800;a--)p.push({value:a,selected:a===(new Date).getFullYear()?"selected":""});f.$arrayNotEmpty(d.collections)?o=d.collections:d.collServer.findAllCollections(function(a){o=a})}function g(){d.collServer.findAllCollections(function(a){var b=d.docEdit.currentEditDoc,c=f.$collect(d.collections,function(a){return a=a||d.currentCollection,f.$exist(b.original_collection)&&f.$stringEqual(b.original_collection+"",this.id+"")&&(a=this),a});f.$objectExist(c)&&!f.$stringEqual(d.currentCollection.id,c.id)&&(d.currentCollection=c,d.shelfCtrl.open())},function(a){})}function h(a){return f.$arrayNotEmpty(a)?f.$reduce(a,function(){var a=f.$objectExist(d.currentUser)?d.currentUser.user_id:null,b=f.$objectExist(d.docEdit.currentEditDoc)?d.docEdit.currentEditDoc.original_collection:null;return!(!f.$exist(b)||!f.$stringEqual(b+"",this.id+""))||f.$exist(a)&&f.$stringEqual(this.owner_id+"",a+"")}):[]}function i(){b("#collectionSelect").on("change",function(a){var c=b(a.target).val(),e=f.$objectExist(d.docEdit.currentEditDoc)?d.docEdit.currentEditDoc:null;f.$objectExist(e)&&(e.original_collection=f.$exist(c)&&f.$stringExist(c+"")?c+"":e.original_collection)})}function j(a){return a&&a instanceof Array?a[0].value:""}function k(a){return a&&a instanceof Array?a:a&&a.length>0?[a]:[]}function l(a){var b=a;return a.length>26&&(b=a.substring(0,13)+"(...)"+a.substring(a.length-13)),b}function m(a){a=a||{},a.attributes=a.attributes||{},a.attributes.attribute=a.attributes.attribute||{};var c=1900,d=a.attributes.attribute["Year of publication"];d instanceof Array&&d[0].value&&(c=d[0].value),1===parseInt(a.public)&&b('input[name="public"]').attr("checked",a.public),1===parseInt(a.allow_aggregating)&&b('input[name="allow_aggregating"]').attr("checked",a.allow_aggregating);var e=b("#collectionSelect option[value='"+a.shelf_id+"']");e&&b(e).attr("selected","selected"),b("#yearSelect option[value='"+c+"']").attr("selected","selected"),n.adjustInputSize(b('input[name="doc_name"]')),n.adjustInputSize(b('textarea[name="doc_name"]'))}var n=this;n.tags={},n.selects={},n.checkboxes={},n.inputs={},n.currentEditDoc=null;var o=[],p=[];b(document).ready(function(){d=a.pageshare||{},e=a.awr||{},f=e.Q,f.$waitForComps({name:"pageshare.collServer",type:"object"}).then(function(){c()},function(a){})}),n.edit=function(c,q){d.docServer.initMetaDataDB(),g(),d=a.pageshare||{},e=a.awr||{},f=e.Q;var r,s,t,u,v,w,x;if(!f.$objectExist(d.currentUser))return void(f.$objectExist(e.router)&&e.router.goToRoot());d.viewName="doc-edit",r=Pageshare.Templates["assets/modules/docEdit/docEdit.hbs"],c=c&&c.book?c.book:d.currentDoc.book,n.currentEditDoc=c,b(".doc-edit")&&b(".doc-edit").remove(),c.meta={},c.attributes&&c.attributes.url&&(c.meta.designs=j(c.attributes.url.Designs),c.meta.print=j(c.attributes.url.Print),c.meta.meme=j(c.attributes.url.Meme)),c.attributes.attribute&&(c.meta.authors=k(c.attributes.attribute.Authors),c.meta.languages=k(c.attributes.attribute.Languages),c.meta.categories=k(c.attributes.attribute.Categories)),s=c.file_url_pdf?c.file_url_pdf.split("/"):[],t=c.file_url_epub?c.file_url_epub.split("/"):[],c.pdfFile?c.pdf_name=c.pdfFile.name:s.length>0&&(c.pdf_name=s[s.length-1],c.pdf_name=l(c.pdf_name)),c.epubFile?c.epub_name=c.epubFile.name:t.length>0&&(c.epub_name=t[t.length-1],c.epub_name=l(c.epub_name)),u={doc:c,collections:h(o),years:p},v=b(r(u)),b("#ajax-content").html(v),i(),setTimeout(function(){m(c),b(".doc-edit .back-link").on("click",function(){e.router.back({onStateChange:function(){d.mainHeader.reload()}})})},500),b("body").ready(function(){m(c),b(".doc-edit .back-link").on("click",function(){e.router.back({onStateChange:function(){d.mainHeader.reload()}})}),f.$stringEqual(b("body").attr("id"),"premium")||d.shelfCtrl.open()}),c.doc_id?n.enableEdit():n.disableEdit(),e.ux&&(f.$exist(c.doc_id)&&f.$stringExist(c.doc_id+"")||(w={ntfText:"This document must be upgraded before it can be edited.",actionName:"Upgrade",moreInfoText:"more info...",type:"warning",hasIcon:!0,hasMoreInfo:!0,hasAction:!0,parentElemKey:"#ajax-content",moreInfo:function(){d.basicModal.start({mainClass:"upgrade-info",actionName:"Upgrade",title:" Upgrade recommended for this document!",titleIcon:"fa fa-exclamation-triangle text-warning",message:"This document was created using the legacy system. The current system provides limited support for legacy documents. This means that the legacy documents are not compatible with many new features introduced by the current system, such as edit and update, tag based search, auto-complete for data fields, file replace, and etc. We highly recommend that you upgrade this document now.",actionClass:"btn-success",action:function(){d.basicModal.stop(),n.upgrade()},cancelName:"Cancel"})},action:function(){d.basicModal.stop(),n.upgrade()}},e.ux.notifBar.show(w)),x=d.docServer.searchInMeta,n.tags.authors=e.ux.tagField("#authorsField",{capitalize:!0,tags:c.meta.authors,onSearch:function(a,b){var c=x("Authors",a);a.length<1&&(c=[]),"function"==typeof b&&b(c)}}),n.tags.languages=e.ux.tagField("#langsField",{capitalize:!0,tags:c.meta.languages,onSearch:function(a,b){var c=x("languages",a);a.length<1&&(c=[]),"function"==typeof b&&b(c)}}),n.tags.categories=e.ux.tagField("#categsField",{capitalize:!0,tags:c.meta.categories,onSearch:function(a,b){var c=x("categories",a);a.length<1&&(c=[]),"function"==typeof b&&b(c)}}),c.doc_id&&d.docServer.getDocState(c.doc_id,function(f){if(f.is_busy===!0){var g=b(".side .img-cover");b(g).css("display","block"),b(g).parent().find("img").attr("src","assets/img/hourglass.gif");var h={ntfText:"This document is currently being processed. You can edit the document when this job is done.",actionName:"",moreInfoText:"more info...",type:"warning",hasIcon:!0,hasMoreInfo:!1,hasAction:!1,parentElemKey:"#ajax-content",moreInfo:function(){},action:function(){}};e.ux.notifBar.show(h),n.disableEdit(),d.docServer.waitForBusyDoc(c.doc_id,function(){"doc-edit"===a.pageshare.viewName&&d.docServer.findDoc({doc_id:c.doc_id,success:function(a){n.edit(a)},fail:function(){console.error("docEdit: could not open ready document for editing.")}})})}})),n.selects.publicationYear=b("#yearSelect"),n.selects.collections=b("#collectionSelect"),n.checkboxes.public=b('input[name="public"]'),n.checkboxes.allowAggregating=b('input[name="allow_aggregating"]'),"block"===b('textarea[name="doc_name"]').css("display")?n.inputs.docName=b('textarea[name="doc_name"]'):n.inputs.docName=b('input[name="doc_name"]'),n.inputs.designs=b('input[name="designs"]'),n.inputs.print=b('input[name="print"]'),n.inputs.meme=b('input[name="meme"]'),n.doc=c,d.mainHeader.reload(),d.UI.setDefaultEventHandlers()},n.addFile=function(a,b){d.basicModal.start({mainClass:"no-edit-notice",actionName:"ok",actionClass:"btn-primary",isInfo:!0}),d.basicModal.update({title:"<span class='fa fa-exclamation-circle'></span> Feature not available",message:"<Strong>Note:</Strong> The edit feature currently does not support file upload. This complementary feature become available in near future!"})},n.adjustInputSize=function(a){if(b(a)[0]){var c=b(a).text()?b(a).text():b(a).val();if(b(a)&&"textarea"===b(a)[0].nodeName.toLowerCase())b(a).height(0),b(a).width(b(".doc-edit .header").width()-15),b(a).height(b(a)[0].scrollHeight);else{var d=b(a).parent(),e=d.width();(20*(c.length+1)<e-15||b(a).width()<e-15)&&Math.min(b(a).width(20*(c.length+1)),e-15)}}},n.getEditData=function(){var a=new FormData,b=n.doc.doc_id?n.doc.doc_id:n.doc.id;return a.append("doc_id",b),new d.DocData({dataGroupType:"formData",dataElement:a,appends:{book_name:n.inputs.docName.val(),shelf_id:n.selects.collections.val(),original_collection:n.selects.collections.val(),collection_id:n.selects.collections.val(),Authors:n.tags.authors.getTags,Languages:n.tags.languages.getTags,Categories:n.tags.categories.getTags,pub_year:n.selects.publicationYear.val(),public:n.checkboxes.public.is(":checked")?1:0,allow_aggregating:n.checkboxes.allowAggregating.is(":checked")?1:0,Meme:n.inputs.meme.val(),Print:n.inputs.print.val(),Designs:n.inputs.designs.val()}})},n.disableEdit=function(){b(".doc-edit .disabled-overlay").css("display","block"),b(".doc-edit .footer .edit").addClass("disabled")},n.enableEdit=function(){b(".doc-edit .disabled-overlay").css("display","none"),b(".doc-edit .footer .edit").removeClass("disabled")},n.update=function(a){function c(a){f.$numberExist(a)&&a>1&&(g(),d.docServer.refreshCache({doc_id:"doc-"+h.getData().get("doc_id")}))}if(!b(a.target).hasClass("disabled")){d.basicModal.start({mainClass:"saving-doc",actionName:"save"}),d.basicModal.busy({title:"<span class='fa fa-spinner text-muted'></span>&nbsp;&nbsp;Saving document",message:" Please wait..."})
;var e=0,h=n.getEditData(),i=f.$exist(d.currentUser.user_id)&&f.$exist(n.doc.author_id)&&f.$stringEqual(n.doc.author_id,d.currentUser.user_id);setTimeout(function(){f.$booleanTrue(d.currentUser.is_admin)||f.$booleanTrue(i)?(d.docServer.updateDocInfo({docData:h,success:function(a){e++,c(e)},fail:function(a){}}),d.docServer.saveDocMeta({docData:h,success:function(a){e++,c(e)},fail:function(a){}}),d.basicModal.stop()):n.releaseByForbiddenError()},1e3)}},n.releaseByForbiddenError=function(a){a=a||"Saving document failed",d.basicModal.release({title:"<span class='fa fa-meh-o text-danger'></span><span class='text-danger'>&nbsp;&nbsp;"+a+"</span>",message:"Server rejected your request with status <strong class='text-warning'>404 Forbidden!</strong><br>Sorry, but you are not authorized for doing this action.",isInfo:!0,cancelName:"Ok"})},n.upgrade=function(){var b=null;n.currentLegacy=n.doc,d.basicModal.start({mainClass:"upgrade-progress",titleIcon:"fa fa-cube text-warning",title:"Upgrade",actionClass:"btn-primary",isInfo:!0}),d.basicModal.busy({message:"<div class='upgrade-wait'><img src='assets/img/spining_dots.gif' style='width: 60px'/> <strong class='tex-info'>Upgrading the document. Initializing new document...</strong></div>"});var c=n.getEditData(),e=n.currentLegacy||{};e.file_url_pdf&&c.append("pdf_path",e.file_url_pdf),e.file_url_epub&&c.append("epub_path",e.file_url_epub),e.file_url_audio&&c.append("audio_path",e.file_url_audio),e.id&&c.append("legacy_id",e.id),setTimeout(function(){d.currentUser.is_admin===!0||d.currentUser.user_id===n.doc.author_id?d.docServer.createDoc({docData:c,success:function(e){setTimeout(function(){d.basicModal.busy({message:"<div class='upgrade-wait'><img src='assets/img/spining_dots.gif' style='width: 60px'/> <strong class='tex-info'>Upgrading the document. Saving meta data...</strong></div>"}),c.append("doc_id",e.doc_id),b=e.doc_id,a.editData=c,d.docServer.saveDocMeta({docData:c,success:function(a){setTimeout(function(){if(d.basicModal.busy({message:"<div class='upgrade-wait'><img src='assets/img/spining_dots.gif' style='width: 60px'/> <strong class='tex-info'>Upgrading the document. Copying files...</strong></div>"}),!b)return void console.error("Failed to proceed with upgrade. No new document could be initialized!");d.docServer.upgradeLegacyFiles({docData:c,success:function(a){setTimeout(function(){d.basicModal.busy({message:"<div class='upgrade-wait'><img src='assets/img/spining_dots.gif' style='width: 60px'/> <strong class='tex-info'>Upgrading the document. Creating image files and scaling...</strong></div>"}),d.docServer.findDoc({doc_id:b,success:function(a){n.edit(a),d.currentDoc=a,d.basicModal.stop(),d.basicModal.start({mainClass:"upgrade-info",actionName:"Remove legacy",title:" Upgrade complete!",titleIcon:"fa fa-thumbs-o-up text-success",message:"Document upgrade completed successfully.  The legacy version of this document still exist in the system but no longer needed. Do you want to remove it?",action:function(){d.docRemove&&d.docRemove.remove(n.currentLegacy,function(){d.docEdit.edit(a)})},cancelName:"Keep it!"})},fail:function(a){console.error("Upgrade failed \n"+a)}})},1e3)},fail:function(a){console.error(a)}})},1e3)},fail:function(a){}})},1e3)},fail:function(a){}}):n.releaseByForbiddenError("Upgrading document failed!")},1e3)}}var d=a.pageshare||{},e=a.awr||{},f=e.Q;d.docEdit=new c}(window,jQuery),function(a,b){function c(){function a(a,b){var c="col-md-12 col-sm-12 col-xs-12";return b===!0&&(c="col-md-6 text-info col-md-offset-1 col-sm-offset-1 col-sm-8 col-xs-12"),'<li class="fa fa-square-o pending '+c+'"> '+a+"...</li>"}function c(){b("#docWorkingLog").css("display","inline-block"),b("#docWorkingLog").empty()}function d(c,d){var e=b(a(c,d));return b("#docWorkingLog").append(e),{done:function(a){b(e).removeClass("fa-square-o"),b(e).removeClass("fa-exclamation-triangle"),b(e).removeClass("pending"),b(e).removeClass("fail"),b(e).removeClass("text-info"),b(e).removeClass("text-danger"),b(e).addClass("fa-check-square-o"),b(e).addClass("done"),b(e).addClass("text-success"),a&&a.length>0&&b(e).html(a)},fail:function(a){b(e).removeClass("fa-square-o"),b(e).removeClass("fa-check-square-o"),b(e).removeClass("pending"),b(e).removeClass("done"),b(e).removeClass("text-success"),b(e).removeClass("text-info"),b(e).addClass("fa-exclamation-triangle"),b(e).addClass("done"),b(e).addClass("text-danger"),a&&a.length>0&&b(e).html(a)}}}return{initLog:c,initWork:d}}function d(){function d(){var a=[],c=null;return i.$arrayNotEmpty(g.collections)&&i.$objectExist(g.currentUser)&&(a=i.$collect(g.collections,function(a){if(i.$stringEqual(this.owner_id+"",g.currentUser.main_collection+""))return this})),a&&a.length&&(c="/app#c/"+(i.$objectExist(a)?a.id:"index")),g.currentUploadCollectionId&&(b(".to-home a").off("click"),b(".to-home a").on("click",function(a){a.preventDefault(),h.router.go("coll-index",{params:{cId:g.currentUploadCollectionId}})})),c}function e(){f.tags={},h.ux&&(f.tags.authors=h.ux.tagField(".doc-form #authorsField",{capitalize:!0,placeholder:"Enter an author name",tags:[],onSearch:function(a,b){var c=g.docServer.searchInMeta("Authors",a);a.length<1&&(c=[]),"function"==typeof b&&b(c)}}),f.tags.languages=h.ux.tagField(".doc-form #langsField",{capitalize:!0,placeholder:"Enter a Language name",tags:[],onSearch:function(a,b){var c=g.docServer.searchInMeta("Languages",a);a.length<1&&(c=[]),"function"==typeof b&&b(c)}}),f.tags.categories=h.ux.tagField(".doc-form #categsField",{capitalize:!0,placeholder:"Enter a category name",tags:[],onSearch:function(a,b){var c=g.docServer.searchInMeta("Categories",a);a.length<1&&(c=[]),"function"==typeof b&&b(c)}}))}var f=this;return h=a.awr||{},i=h.Q,f.isAudioType=function(a){var b=["mp3","ogg","flac","alac","wav","mp4","zip","gz","tar.gz","wmv","mp4b","raw","m4b","spx","aac","vox","amr","3ga","aa","asx","efa","rma","orc","rmx","ima4","rmj","m2a","mp1","mp2","mpga","mg4"];for(var c in b)if(a.endsWith("."+b[c])||a.endsWith("."+b[c].toUpperCase()))return!0;return!1},f.showLevel1=function(){b(j.level1[0]).val(100),b(j.level2[0]).val(0),b(j.level3[0]).val(0),b("#docFrmMain .head").addClass("level-1"),b("#docFrmMain .head").removeClass("level-2"),b("#docFrmMain .head").removeClass("level-3"),b("#docFrmMain .head").removeClass("level-4"),b("#docFrmMain .content").addClass("level-1"),b("#docFrmMain .content").removeClass("level-2"),b("#docFrmMain .content").removeClass("level-3"),b("#docFrmMain .content").removeClass("level-4"),b("#docFrmMain #formGeneralTab").addClass("active"),b("#docFrmMain #formUrlsTab").removeClass("active"),b("#docFrmMain #formFilesTab").removeClass("active"),b("h4.progress_level.level-badge").html("1 / 3")},f.showLevel2=function(){b(j.level1[0]).val(100),b(j.level2[0]).val(100),b(j.level3[0]).val(0),b("#docFrmMain .head").addClass("level-2"),b("#docFrmMain .head").removeClass("level-1"),b("#docFrmMain .head").removeClass("level-3"),b("#docFrmMain .head").removeClass("level-4"),b("#docFrmMain .content").addClass("level-2"),b("#docFrmMain .content").removeClass("level-1"),b("#docFrmMain .content").removeClass("level-3"),b("#docFrmMain .content").removeClass("level-4"),b("#docFrmMain #formGeneralTab").removeClass("active"),b("#docFrmMain #formUrlsTab").addClass("active"),b("#docFrmMain #formFilesTab").removeClass("active"),b("h4.progress_level.level-badge").html("2 / 3")},f.showLevel3=function(){b(j.level1[0]).val(100),b(j.level2[0]).val(100),b(j.level3[0]).val(100),b("#docFrmMain .head").addClass("level-3"),b("#docFrmMain .head").removeClass("level-1"),b("#docFrmMain .head").removeClass("level-2"),b("#docFrmMain .head").removeClass("level-4"),b("#docFrmMain .content").addClass("level-3"),b("#docFrmMain .content").removeClass("level-1"),b("#docFrmMain .content").removeClass("level-2"),b("#docFrmMain .content").removeClass("level-4"),b("#docFrmMain #formGeneralTab").removeClass("active"),b("#docFrmMain #formUrlsTab").removeClass("active"),b("#docFrmMain #formFilesTab").addClass("active"),b("h4.progress_level.level-badge").html("3 / 3"),b("#pdf-select").fileinput({showUpload:!1,previewFileType:"any"}),b("#epub-select").fileinput({showUpload:!1,previewFileType:"any"}),b("#audio-select").fileinput({showUpload:!1,previewFileType:"any"}),b("#pdf-select").on("fileselect",function(a,c,d){c>1&&alert("Only 1 pdf file is allowed to be uploaded at once"),d.endsWith(".pdf")||(alert("Only pdf files are allowed to be chosen here!"),b(".pdf-input button.fileinput-remove").trigger("click"),setTimeout(function(){b("#pdf-select").fileinput("reset")},200)),f.validate("all")}),b("#epub-select").on("fileselect",function(a,c,d){d.endsWith(".epub")||d.endsWith(".mobi")||(alert("Only ePub or mobi file formats are allowed to be chosen here!"),b(".epub-input button.fileinput-remove").trigger("click"),setTimeout(function(){b("#epub-select").fileinput("reset")},200)),f.validate("all")}),b("#audio-select").on("fileselect",function(a,c,d){f.isAudioType(d)||(alert("Only audio / audio zip files are allowed to be chosen here!"),b(".audio-input button.fileinput-remove").trigger("click"),setTimeout(function(){b("#audio-select").fileinput("reset")},200)),f.validate("all")})},f.initUploadView=function(){b(".doc-form .collection-name select#shelfSelect").attr("disabled","disabled"),b(j.level1[0]).val(100),b(j.level2[0]).val(100),b(j.level3[0]).val(100),b("#docFrmMain .head").addClass("level-4"),b("#docFrmMain .head").removeClass("level-1"),b("#docFrmMain .head").removeClass("level-2"),b("#docFrmMain .head").removeClass("level-3"),b("#docFrmMain .content").addClass("level-4"),b("#docFrmMain .content").removeClass("level-1"),b("#docFrmMain .content").removeClass("level-2"),b("#docFrmMain .content").removeClass("level-3"),b("#docFrmMain #formGeneralTab").removeClass("active"),b("#docFrmMain #formUrlsTab").removeClass("active"),b("#docFrmMain #formFilesTab").removeClass("active"),b("h4.progress_level.level-badge").html("3 / 3")},f.activateSuccessView=function(){b("#docFrmMain .content.level-4 .working").css("display","none"),b("#docFrmMain .content.level-4 .failed").css("display","none"),b("#docFrmMain .content.level-4 .success").css("display","block"),d()},f.activateFailedView=function(){b("#docFrmMain .content.level-4 .working").css("display","none"),b("#docFrmMain .content.level-4 .failed").css("display","block"),b("#docFrmMain .content.level-4 .success").css("display","none"),d()},f.activateWorkingView=function(){b("#docFrmMain .content.level-4 .working").css("display","block"),b("#docFrmMain .content.level-4 .failed").css("display","none"),b("#docFrmMain .content.level-4 .success").css("display","none")},f.getFileInputs=function(){function a(a){a=a.replace(".","").replace("#","");var c="",d="";"pdf"!==a&&"pdf-select"!==a&&"pdf-input"!==a||(c=".pdf-input",d="#pdf-select"),"epub"!==a&&"epub-select"!==a&&"epub-input"!==a||(c=".epub-input",d="#epub-select"),"audio"!==a&&"audio-select"!==a&&"audio-input"!==a||(c=".audio-input",d="#audio-select");var e=b(c);return{plugin:function(){return b(d).fileinput()},remove:function(){try{b(e).find("button.fileinput-remove").trigger("click"),b(d).fileinput("clear")}catch(a){console.info("docForm: [warning] "+a)}}}}return{pdfInput:a,epubInput:a,audioInput:a,get:a}},f.startUpload=function(){var a=f.tags.authors,b=i.$objectExist(g.currentCollection)?g.currentCollection.id:null,d=f.tags.languages,e=f.tags.categories,h=new g.DocData({dataGroupType:"form",dataElement:".doc-form form",appends:{Authors:a.getTags,Languages:d.getTags,Categories:e.getTags}}),j=g.docServer,k=new c;if(k.initLog(),!h.isValid())return void console.error("docForm: [Error] : The form is not valid. Aborting upload process!");f.initUploadView(),f.activateWorkingView();var l=k.initWork(" Connecting to Server..."),m=k.initWork(" Initializing new Document...");j.createDoc({docData:h,success:function(a){l.done(" Connecting to Server."),m.done(" Initializing new Document.");var c=k.initWork(" Sending meta data to server.."),d=a.doc_id;h.append("doc_id",d),j.saveDocMeta({docData:h,success:function(a){c.done(" Sending meta data to server.");var e=j.buildFilesGroup(h,f.getFileInputs()),l=k.initWork(" Uploading Files");j.uploadFiles({files:e.files,u_index:0,doc_id:d,clean:e.clean,cleanAll:e.cleanAll,uploadUrl:e.uploadUrl,success:function(a){k.initWork(" File ["+a.file_name+"] uploaded.",!0).done()},fail:function(a){},complete:function(a){a&&a.isSuccess===!0&&g.collServer.findAllCollections(function(a){g.mainMenu.reload(),i.$exist(b)&&(g.currentCollection=i.$collect(a,function(a){return i.$stringEqual(this.id+"",b+"")&&(a=this),a})),g.shelfCtrl.reload(),f.activateSuccessView();var c=e.files.length>1?" "+e.files.length+" files uploaded successfully.":" Upload job finished successfully";l.done(c)},function(){f.activateSuccessView();var a=e.files.length>1?" "+e.files.length+" files uploaded successfully.":" Upload job finished successfully";l.done(a)}),i.$objectExist(a)&&i.$booleanFalse(a.isSuccess)&&(f.activateFailedView(),l.fail(" Upload failed!"),f.activateFailedView())}})},fail:function(a){f.activateFailedView(),c.fail(" Failed on sending meta data.")}})},fail:function(a){f.activateFailedView(),l.done(" Failed on Connecting to Server."),m.done(" Failed on initializing new Document.")}})},f.setLevel=function(c){b("#pDocLevel1").ready(function(){var b=a.pageshare.docForm;(c>3||c<1)&&(c=1),1===c?f.showLevel1():2===c?f.showLevel2():3===c&&f.showLevel3(),b.currentLevel=c})},f.validate=function(a){var c=[],d=!1,e=f.tags.authors,h=f.tags.languages,i=f.tags.categories,j=g.DocData({dataGroupType:"form",dataElement:b(".doc-form form")[0],appends:{Authors:e.getTags,Languages:h.getTags,Categories:i.getTags}}),k=j.validate();if(j.isValid())return b("ul.error-list li").remove(),b("ul.error-list").removeClass("has-error"),b('.doc-form input[name="book_name"]').parent().find(".field-head .notif").removeClass("not-valid"),b('.doc-form input[name="Authors"]').parent().find(".field-head .notif").removeClass("not-valid"),[];if(("all"===a||a>0)&&(k.hasDocName?b('.doc-form input[name="book_name"]').parent().find(".field-head .notif").removeClass("not-valid"):(b('.doc-form input[name="book_name"]').parent().find(".field-head .notif").addClass("not-valid"),c.push(k.warnings.doc_name),d=!0),k.hasAuthors?b('.doc-form input[name="Authors"]').parent().find(".field-head .notif").removeClass("not-valid"):(b('.doc-form input[name="Authors"]').parent().find(".field-head .notif").addClass("not-valid"),c.push(k.warnings.authors),d=!0),d?b(".doc-form #formGeneralTab").addClass("not-valid"):b(".doc-form #formGeneralTab").removeClass("not-valid")),("all"===a||a>=3)&&(k.filesCount<1?(b(".doc-form #formFilesTab").addClass("not-valid"),c.push(k.warnings.files)):b(".doc-form #formFilesTab").removeClass("not-valid")),b("ul.error-list li").remove(),b("ul.error-list").removeClass("has-error"),c.length>0){b("ul.error-list").addClass("has-error");for(var l in c){var m=b('<li> <span class="notif text-danger fa fa-exclamation-triangle pull-left"> '+c[l]+"</span></li>");b("ul.error-list").append(m)}}return c},f.initShelfOptions=function(){if(!g.currentUser&&g.docForm.initShelf!==!0)return void setTimeout(function(){g.docForm.initShelf=!0,f.initShelfOptions()},1e3);var a=[],c=g.currentCollection;g.collections&&(a=b.grep(g.collections,function(a,b){return g.currentUser&&a.owner_id+""===g.currentUser.user_id}));for(var d in a){var e=a[d];e.id!==c.id&&b("#shelfSelect").append('<option value="'+e.id+'">'+e.name+"</option>")}g.currentUploadCollectionId=b('input[name="shelf_id"]').val(),b("#shelfSelect").on("change",function(a){b('input[name="shelf_id"]').val(b(this).val()),g.docForm.shelfId=b(this).val(),g.currentUploadCollectionId=b(this).val()})},f.watchForm=function(){var a=g.docForm;if(a){a.watchId!=-1&&clearInterval(a.watchId);var c=setInterval(function(){if(a.watchId=c,b(".doc-form-section #kvFileinputModal").length>0&&b(".doc-form-section #kvFileinputModal").appendTo("body"),a.currentLevel>0&&a.currentLevel<4){f.validate(a.currentLevel).length>0?b(".doc-form button.upload").addClass("disabled"):b(".doc-form button.upload").removeClass("disabled")}},500)}},f.reset=function(){b(".doc-form .collection-name select#shelfSelect").removeAttr("disabled"),b('.doc-form input[type="text"]').val(""),b('.doc-form input[type="checkbox"]').attr("checked","1"),b("#docWorkingLog").css("display","none");try{b(".pdf-input button.fileinput-remove").trigger("click"),b(".epub-input button.fileinput-remove").trigger("click"),b(".audio-input button.fileinput-remove").trigger("click"),b("#pdf-select").fileinput("reset"),b("#epub-select").fileinput("reset"),b("#audio-select").fileinput("reset")}catch(a){}},{level1:b(f.lev1),level2:b(f.lev2),level3:b(f.lev3),currentLevel:0,watchId:-1,init:function(){b(".doc-form").ready(function(){var a=g.docForm;a.reset(),a.level1=b("#pDocLevel1"),a.level2=b("#pDocLevel2"),a.level3=b("#pDocLevel3"),f.setLevel(1),f.initShelfOptions(),e(),b(".doc-form").slideDown("fast"),i.$stringEqual(b("body").attr("id"),"premium")||g.shelfCtrl.open()})},reset:f.reset,restart:function(){g.docServer.initMetaDataDB(),g.docForm.init()},next:function(){var a=g.docForm;f.validate(a.currentLevel),a.currentLevel++,f.setLevel(a.currentLevel),f.watchForm()},back:function(){var a=g.docForm;f.validate(a.currentLevel),a.currentLevel--,f.setLevel(a.currentLevel),f.watchForm()},startUpload:function(){if(f.validate("all").length<1){var a=g.docForm;clearInterval(a.watchId),f.startUpload()}},setLevel:f.setLevel,validate:f.validate,noopLink:function(a){a.preventDefault()},start:function(c){function d(c){function d(){var c=Pageshare.Templates["assets/modules/docForm/docForm.hbs"],d=b(c(f));b("#docFrmMain").html(d),b("#docFrmMain .doc-form").ready(function(){a.docForm=g.docForm,g.docForm.init()}),g.UI.compile&&(g.UI.compile(),g.UI.setDefaultEventHandlers())}var f={title:"Add to collection: ",shelf:{id:c.id,name:c.name},document:{},years:e};"undefined"==typeof jQuery?setTimeout(d,500):d()}g=a.pageshare||{},h=a.awr||{},i=h.Q,b("#ajax-content").html("<div id='docFrmMain' class=''></div>"),g.allShelves=g.collections,g.preChosenShelf=g.currentCollection;for(var e=[],f=(new Date).getFullYear();f>=1800;f--)e.push({value:f,selected:f===(new Date).getFullYear()?"selected":""});i.$objectExist(g.currentCollection)?d(g.currentCollection):g.collServer.loadAsCurrentCollection(c,function(a){d(a)},function(){})}}}function e(){var a=new FormData(b("form")[0]);b.ajax({url:b(b("form")[0]).attr("action"),type:"POST",data:a,async:!0,cache:!1,contentType:!1,processData:!1,success:function(a){console.log(a)},error:function(a){console.log("error in ajax form submission"),console.log(a)}})}function f(){b("input").each(function(){"book_name"===b(this).attr("name")&&b(this).val("Best audio file"),"Authors"===b(this).attr("name")&&b(this).val("Some Author"),"Designs"===b(this).attr("name")&&b(this).val("http://somelink.com/designs"),"Print"===b(this).attr("name")&&b(this).val("http://somelink.com/prints"),"Meme"===b(this).attr("name")&&b(this).val("http://somelink.com/meme"),"pub_year"===b(this).attr("name")&&b(this).val("2016"),"Languages"===b(this).attr("name")&&b(this).val("English"),"public"===b(this).attr("name")&&(b(this).attr("checked","1"),b(this).val("1")),"allow_aggregating"===b(this).attr("name")&&(b(this).attr("checked","1"),b(this).val("1"))}),setTimeout(function(){var a=b('#authorsField input[type="text"]');b(a).val("Qoli Guy");var c=b.Event("keypress");c.which=13,b(a).trigger(c)},500)}var g=a.pageshare||{},h=a.awr||{},i=h.Q,j=new d;g.docForm=j,a.dummySend=e,a.addDummyValues=f}(window,jQuery),function(a,b){function c(){function c(){var a=b("#mainlogo"),c=b("#book_info");a.find(".text").text("PageShare"),c.empty(),b("body").removeClass("has_book_info book_info_open")}function g(a){if(a=a||{},a.book=a.book||{name:"nullBook"},"premium"!==b("body").attr("id")&&f.$objectExist(a)){b("#mainlogo .arrows").removeClass("hidden"),a.editable=!!f.$stringEqual("editable",a.editable)||a.editable,a.collections=f.$arrayNotEmpty(a.collections)&&f.$exist(a.collections[0])?a.collections:[];var c=b("#mainlogo"),e=f.$stringExist(a.shelf_id)||f.$numberExist(a.shelf_id)?a.shelf_id+"":f.$stringExist(a.book.shelf_id)||f.$numberExist(a.book.shelf_id)?a.book.shelf_id+"":null,g=f.$stringExist(a.original_collection)||f.$numberExist(a.original_collection)?a.original_collection+"":f.$objectExist(a.book)&&f.$stringExist(a.book.original_collection)||f.$numberExist(a.book.original_collection)?a.book.original_collection+"":null,h=f.$map(a.collections,function(){return this.id+""}),i=f.$stringExist(e)?f.$collect(d.collections,function(a){if(f.$stringEqual(this.id+"",e))return this}):null,j=f.$stringExist(g)?f.$collect(d.collections,function(a){if(f.$stringEqual(this.id+"",g))return this}):null,k=b("#book_info"),l=Pageshare.Templates["assets/modules/docReader/doc_info.hbs"];c.find(".text").text(a.book.book_name),f.$objectExist(j)&&!f.$setContainsString(h,j.id+"")&&(a.collections.push(j),h.push(j.id+"")),f.$objectExist(i)&&!f.$setContainsString(h,i.id+"")&&(a.collections.push(i),h.push(i.id+""));var m=f.$objectExist(a.book)?a.book:a;a.edit_id=f.$stringExist(m.doc_id)?"doc-"+m.doc_id:f.$or(f.$stringExist(m.id),f.$numberExist(m.id))?m.id:"",a.id=a.edit_id,f.$objectExist(a.book)&&(a.id=a.edit_id),f.$waitForComps({name:"pageshare.bookInfoDom",type:"object"}).then(function(){var c=b(l(a));k=b("#mainHeaderContainer #book_info"),b(k).html(b(c)),b(k).removeClass("hidden"),b("body").addClass("has_book_info")},function(a){console.error("docReader@Pageshare: Failed to load book info. Framework wait timeout interrupted the dom compile.\n\t + Details: Header components could not be detected before the maximum allowed wait. ")})}}function h(b){var c=b.book.id,d=b.book.book_name.split(" ").join("_").toLowerCase(),e=c.startsWith("doc-")||c.startsWith("d"),g=f.$booleanTrue(e)?"/app#share/":"/app#share/legacy/";return d=d.replace(/[\?\!\#\.\/\&\=]/g,""),c=f.$booleanTrue(e)?c.replace("doc-","").replace("d",""):c,a.location.origin+g+d+"/"+c}function i(a){var b=h(a);return b.length>50?b.substring(0,30)+"..."+b.substring(b.length-20):b}function j(a,b){var c=a;return f.$objectExist(b)&&f.$objectExist(b.book)&&f.$booleanFalse(b.book.id.startsWith("d")||b.book.id.startsWith("doc-"))&&(c=f.$stringExist(b.book.id+"")?b.book.id+"":c),c=f.$stringExist(c)&&c.startsWith("d")&&!c.startsWith("doc-")?"doc-"+c.replace("d",""):c}function k(c,g,k){if(!f.$or(l(),m(g)))return void d.UI.showNotFound();var o,p,q=j(c);if(k=b(k&&b(k).length>0?k:"#ajax-content"),d.currentView={id:"doc-reader-"+q,name:"doc-reader"},a.calls=a.calls||{},a.calls[q]=null,d=a.pageshare||{},g.book){g.editable=d.currentUser?"editable":"",g.direct_link=h(g),g.direct_link_label=i(g),g.edit_link="#edit/"+q+"?view=open",o=b.extend(g,z),o.url_links=n(g),p=b(y(o)),p.find("img").each(function(){this.src=x(this)}),b(k).html(p);var r,s,t,u=b(k).find(".single-page img");f.$objectExist(e.imgCache)&&(u=f.$reduce(u,function(){if(t=b(this).data("original"),f.$stringExist(t)&&!e.imgCache.inCache("single-pages",t))e.imgCache.addToGroup("single-pages",t);else if(r=f.$stringExist(t)?e.imgCache.getImg("single-pages",t,{placeHolder:x,width:f.$numberExist(b(s).attr("width"))?b(s).attr("width"):b(a).width(),height:f.$numberExist(b(s).attr("height"))?b(s).attr("height"):2*b(a).height()}):null,s=b(k).find('.single-page img[data-original="'+t+'"]'),f.$arrayNotEmpty(s)&&f.$objectExist(r))return b(r).addClass("img-responsive"),b(s).replaceWith(r),!1;return!0})),b(u).lazyload({threshold:5*b(a).height()}),b(k).find(".single-page:visible:first .page-share").addClass("open"),b(k).find(".single-page").on("click",function(a){var c=a.currentTarget,d=b(c).find(".tools");b(d).hasClass("on")?(b(d).removeClass("on"),b(d).addClass("off")):(b(d).addClass("on"),b(d).removeClass("off"))}),d.UI.setDefaultEventHandlers()}}function l(){return f.$objectExist(d.currentUser)&&f.$booleanTrue(d.currentUser.is_admin)}function m(a){return d.docServer.isDocVisible(a)}function n(a){var b=f.$objectExist(a)&&f.$objectExist(a.book)&&f.$exist(a.book.attributes)&&f.$exist(a.book.attributes.url)?a.book.attributes.url:null;return f.$objectExist(b)?{Meme:b.Meme,Print:b.Print,Designs:b.Designs}:{}}function o(a,c,g,h){if(!f.$exist(a)||a<=0||f.$setContainsString(["0","-1","null"],a))return void console.error("openDoc@Reader@Pageshare: Bad document id [ "+a+" ]. Aborting.");h=h||{};var i=d.currentDoc?d.currentDoc.book.id:null;i!==a&&b(document).trigger("shelf:bookClosing",[i]),b("#shelf .cover").each(function(){b(this).toggleClass("selected",b(this).data("book-id")==a)}),b("#ajax-content").empty(),w.getDoc(a,function(g){if(!g)return void console.error("getDoc@Reader: no doc data for id ["+a+"]. Aborting.");if(!d.currentUser){if("0"===g.book.public)return void e.router.goToRoot()}setTimeout(function(){w.buildDocInfoUI(g),f.$waitForComps({name:"pageshare.bookInfoDom",type:"object"}).then(function(){setTimeout(function(){e.domAttrs.$compile(b("#book_info"),{router:e.router})},700)},function(a){}),w.buildReadUI(a,g,b("#ajax-content")),f.$objectExist(e.domAttrs)&&e.domAttrs.$compile(b("#ajax-content"),{router:e.router}),f.$booleanTrue(g.book.isBusy)&&t(a,function(){w.openDoc(a,function(a){},function(){})});try{if(f.$arrayNotEmpty(d.collections)){var h=b.grep(d.collections,function(a,b){return g.book.shelf_id===a.id});d.currentCollection=h[0]||{}}d.currentDoc=g,d.UI.compile()}catch(a){e.errorLog("openDoc@docReader@app","UI compile failed for UI.compile@openDoc@docReader",a)}"function"==typeof c&&c(g)},500)},g)}function p(a){a=a||{};var c=a.docId||0,e=a.complete||null,f=a.fail||null,g=b('<div class="doc-preview-instance"></div>');w.getDoc(c,function(a){c+="",c=c.startsWith("doc-")||c.startsWith("d")?"doc-"+c.replace("doc-","").replace("d",""):c,w.buildReadUI(c,a,b(g)),void 0!==a.book.isBusy&&a.book.isBusy===!0&&t(c,function(){w.buildReadUI(c,a,b(g))}),d.UI.compile(!0),d.currentDoc=a,"function"==typeof e&&e(b(g))},f)}function q(c){var e=d.currentDoc||null;if(e&&e.book&&!isNaN(parseInt(c))){var f=parseInt(c),g=b("#ajax-content").find(".single-page");if(!(f>g.length||f<1)){var h=b.grep(g,function(a,c){return b(a).data("page-number")<f&&b(a).addClass("close"),b(a).data("page-number")>=f&&b(a).removeClass("close"),b(a).data("page-number")<f});if(h.length>0){var i=b("<div class='pre-open'>Load previous pages</div>");b(i).on("click",function(){var c=b.grep(b(".single-page"),function(a,c){return!b(a).hasClass("close")});w.goToPage(1),setTimeout(function(){a.scrollTo(0,b(c[0]).position().top)},200)}),b(h).parent().prepend(i)}else b("#ajax-content").find(".pre-open").remove();w.updatePageNumberInURL(e,c)}}}function r(a,b){a=a||{};var c=null,d=null;if(e.router&&a.book){var g=a.book.book_name,h=a.book.id&&a.book.id.startsWith("doc-")?a.book.id.replace("doc-","d"):a.book.id;f.$qTry(function(){g=g.replace(/[\!\?\#\:\%\=\&\.\;]/g,"").replace(/\s/g,"_").toLowerCase()},function(){g="user_document"}),f.$qTry(function(){c=e.router.getCurrentState(),d=c.name},function(){c=null,d="doc-link"}),f.$setContainsString(["share-link"],d)&&f.$stringExist(h)&&(h=h.replace("doc-","").replace("d","")),e.router.go(d,{params:{docName:g,docId:h,pageNumber:1===parseInt(b)?"index":"p"+b},attrs:f.$objectExist(c)?c.attrs:{}},!1)}}function s(b,c){a.pageshare=a.pageshare||{};var e=a.pageshare.activeGetState;f.$stringEqual(e,b)||(a.pageshare.activeGetState=b,d.docServer.getDocState(b,function(){if(a.pageshare.activeGetState=null,f.$functionExist(c))return c(state)}))}function t(a,b){var c="doc-reader-"+a;d.docServer.waitForBusyDoc(a,function(a){var e=d.currentView&&d.currentView.id?d.currentView.id:null;if(e&&e===c)return f.$functionExist(b)?b(a):void 0},c)}function u(a,b,c){if(a){a=""+a;var e={};a.startsWith("doc-")?e.doc_id=a.replace("doc-",""):e.id=a,e.success=function(a){f.$functionExist(b)&&b(a)},e.fail=function(a){return f.$functionExist(c)?c(a):void 0},d.docServer.findDoc(e)}}function v(){var a=d.currentDoc?d.currentDoc.book:{};w.openDoc(a.id)}e=a.awr||{},f=e.Q,f.$waitForComps({name:"awr.imgCache",type:"object"}).then(function(){e.imgCache.initCache(),e.imgCache.createGroup("single-pages")},function(a){});var w=this,x=function(){var a={},b=!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect,c=document.createElement("canvas"),d=c.getContext&&c.toDataURL("image/png").indexOf("data:image/png")!=-1;if(b){var e=Handlebars.compile('<?xml version="1.0" standalone="no"?><svg width="{{w}}" height="{{h}}" viewBox="0 0 {{w}} {{h}}" xmlns="http://www.w3.org/2000/svg" version="1.1"><text font-size="30" font-family="Open Sans" y="60"><tspan x="{{m}}" text-anchor="middle">Loading...</tspan></text></svg>');return function(b){var c=b.width,d=b.height,f=c+"x"+d;return a[f]||(a[f]="data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(e({w:c,h:d,m:c/2}))),a[f]}}if(d){var f=c.getContext?c.getContext("2d"):{};return function(b){var d=b.width,e=b.height,g=d+"x"+e;return a[g]||(c.width=d,c.height=e,f.fillStyle="transparent",f.fillRect(0,0,d,e),f.font="30px Open Sans",f.fillStyle="black",f.textAlign="center",f.fillText("Loading...",d/2,60),a[g]=c.toDataURL("image/png")),a[g]}}return function(){return"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"}}(),y=Pageshare.Templates["assets/modules/docReader/doc_pages.hbs"],z={base_url:b('link[rel="top"]').attr("href")};b(document).on("shelf:bookClosing",function(a,b){w.clearDocInfoUI()}),b(document).on("shelf:bookOpened",function(a,b,c){w.buildDocInfoUI(c)}),w.getDoc=u,w.getDocState=s,w.buildReadUI=k,w.openDoc=o,w.goToPage=q,w.updatePageNumberInURL=r,w.reload=v,w.clearDocInfoUI=c,w.buildDocInfoUI=g,w.openPreview=p,w.togglePageInfo=function(c){e=a.awr||{},f=e.Q,f.$objectExist(c)&&f.$objectExist(c.target)&&b(c.target).parent().toggleClass("open")}}var d=a.pageshare||{},e=a.awr||{},f=e.Q,g=new c;d.docReader=g}(window,jQuery),function(a,b){"use strict";function c(){}var d=a.awr||{},e=d.bootQueue||[],f=(a.pageshare,{moduleName:"$$appEssentials@CORE",requires:[{name:"awr.$$appEssentials",type:"object"}],wTime:500,init:c,QAsContext:!0});e.push(f)}(window,jQuery),function(a,b){"use strict";function c(){function a(a,b){e.$objectExist(f.currentCollection)&&e.$arrayNotEmpty(f.currentCollection.docs)&&(f.currentCollection.docs=e.$reduce(f.currentCollection.docs,function(){return!e.$setContainsString(["doc-"+a,"d"+a,a+"",b+""],this.id+"")}),f.shelfCtrl.reload()),e.$arrayNotEmpty(f.collections)&&(f.collections=e.$map(f.collections,function(){return e.$arrayNotEmpty(this.docs)&&(this.docs=e.$reduce(this.docs,function(){return!e.$setContainsString(["doc-"+a,"d"+a,a+"",b+""],this.id+"")})),this}),f.mainMenu.reload())}var b=this,c=function(b,g,h){var i=e.$or(e.$stringExist(b.doc_id),e.$numberExist(b.doc_id))?b.doc_id:null,j=e.$numberExist(b.id)?b.id:null,k=e.$exist(i)?"cmd/doc/remove/"+i:e.$exist(j)?"cmd/doc/legacy_remove/"+j:null;if(e.$booleanFalse(e.$stringExist(k)))return!!e.$functionExist(g)&&g();d.serverCall.$post({url:k,data:{confirm:!0}}).then(function(b){f.docServer.invalidateCache({doc_id:e.$numberExist(i)?"doc-"+i:e.$stringExist(i)?i:j}),a(i,j),e.$objectExist(f.currentCollection)?d.router.pushLink("/app#c/"+f.currentCollection.id):d.router.pushLink("/app#c/index"),e.$functionExist(g)&&g()},function(a){var d=a.responseJSON||{error:a.responseText};return e.$numberEqual(a.status,403)&&e.$stringEqual(a.status,"Forbidden")?f.activeLogin.login({success:function(){c(b,g)}}):!!e.$functionExist(h)&&h(d)})};b.quickRemove=function(a){var b=f.currentUser,d=e.$objectExist(b)&&e.$or(b.is_admin,a.author_id===b.user_id);if(!e.$booleanFalse(d))return c(a,null,function(a){console.error((e.$objectExist(a),a.statusText))})},b.remove=function(a,d){var g=f.currentUser,h=e.$objectExist(g)&&e.$or(g.is_admin,a.author_id===g.user_id);if(f.basicModal.busy({title:"<span class='fa fa-spinner fa-spin text-muted'></span>&nbsp;&nbsp;Removing document",message:" Please wait..."}),
e.$booleanFalse(h))return void setTimeout(function(){b.releaseByForbiddenError()},1e3);c(a,function(){setTimeout(function(){f.basicModal.stop()},700),e.$functionExist(d)&&e.$qTry(function(){d()},function(a){console.error("proceed@Remove@Pageshare: error in complete block.\n\t + Details: "+a)})},function(){setTimeout(function(){f.basicModal.stop()},700)})},b.releaseByForbiddenError=function(a){a=a||"Removing document failed",f.basicModal.release({title:"<span class='fa fa-meh-o text-danger'></span><span class='text-danger'>&nbsp;&nbsp;"+a+"</span>",message:"Server rejected your request with status <strong class='text-warning'>404 Forbidden!</strong><br>Sorry, but you are not authorized for doing this action.",isInfo:!0,cancelName:"Ok"})},b.confirm=function(a,c){if(!a||!a.id&&!a.doc_id)return void console.error("docRemove: bad doc object. aborting..");f.basicModal.start({mainClass:"confirm-remove",actionName:"remove",title:" Are you sure?",titleIcon:"fa fa-exclamation-triangle text-danger",message:"If you proceed the document will be permanently removed. Please note that proceeding with this action can't be undone!",actionClass:"btn-danger",action:function(){return b.remove(a,function(){e.$functionExist(c)&&e.$qTry(function(){c()},function(a){console.error("confirm@Remove@Pageshare: error in complete block.\n\t + Details: "+a)})})}})}}var d=a.awr||{},e=d.Q,f=a.pageshare||{};f.docRemove=new c,a.pageshare=f}(window,jQuery),function(a,b){function c(){l.serverCall.basicGET({url:"cmd/meta/pairs",success:function(a){o=a},error:function(a){l.errorLog("initMetaData@docServer","Failed to fetch metaGroups from server",a.statusText)}})}function d(a,c){var d=f(a);return b.grep(d,function(a,b){var f=a.toLowerCase(),g=c.toLowerCase(),h=a.split(" ");return 2===h.length?d[b]=e(h[0])+" "+e(h[1]):d[b]=e(a),m.$stringEqual(f,g)||f.startsWith(g)||g.startsWith(f)})}function e(a){return a.substring(0,1).toUpperCase()+a.substring(1).toLowerCase()}function f(a){for(var b in o)if(o[b].name.toLowerCase()===a.toLowerCase())return g(o[b].values);return[]}function g(a){var b=[];for(var c in a)b.push(a[c].value);return b}function h(a){return m.$numberExist(a)?a:m.$stringExist(a)?a.replace("doc-","").replace("d",""):""}function i(a){a=m.$objectExist(a)?a:{};var b=m.$objectExist(a.book)?a.book.public+"":"NO LEGACY Visibility",c=j(a),d=m.$stringEqual(a.visibility+"","1")||m.$stringEqual(b,"1");return c||d}function j(a){var b=a||{},c=m.$objectExist(n.currentUser)?n.currentUser:{user_id:"no user id"};return b.book=b.book||{},m.$setContainsString([b.owner_id+"",b.book.author_id+"",b.author_id+"",b.book.owner_id+""],c.user_id+"")}function k(){var a=this;c(),a.busyWatchers={},a.initMetaDataDB=c,a.searchInMeta=d,a.isDocVisible=i,a.isUserDocOwner=j,a.invalidateCache=function(a){a=a||{};var b="/cmd/doc/doc_info?";if(a.doc_id)b+="doc_id="+h(a.doc_id);else{if(!a.id)return;b+="id="+h(a.id)}m.$objectExist(p[b])&&(p[b]=null)},a.refreshCache=function(b){a.invalidateCache(b),a.findDoc(b)},a.findDoc=function(a){a=a||{};var b="/cmd/doc/doc_info?";if(a.doc_id)b+="doc_id="+h(a.doc_id);else{if(!a.id)return;b+="id="+h(a.id)}if(m.$objectExist(p[b]))return void(m.$functionExist(a.success)&&a.success(p[b]));try{l.serverCall.basicGET({url:b,success:function(c){p[b]=c,m.$functionExist(a.success)&&a.success(c)},error:a.error,fail:a.fail})}catch(b){"function"==typeof a.fail&&a.fail(b),l.errorLog("findDoc@docServer@app","Error occurred with server call ",b)}},a.getDocState=function(a,b){l.serverCall.basicGET({url:"cmd/doc/state/"+h(a),success:b})},a.waitForBusyDoc=function(b,c,d){m.$stringExist(d)&&m.$functionExist(c)&&(a.busyWatchers[d]=c);var e=setInterval(function(){!m.$stringExist(d)&&m.$functionExist(c)&&(n.watchBusyCallback=c),a.getDocState(h(b),function(c){if(a.invalidateCache({doc_id:b}),m.$booleanTrue(c.is_done)){clearInterval(e),m.$functionExist(n.watchBusyCallback)&&n.watchBusyCallback(c);for(var d in a.busyWatchers){var f=a.busyWatchers[d];m.$functionExist(f)&&f(c)}}m.$booleanTrue(c.is_busy)})},2e3)},a.createDoc=function(a){a=a||{};var b=a.docData;a.onSuccess=a.success,a.onError=a.fail,a.url=b.getDocInitUrl(),a.data=b.getDocInitForm(),l.serverCall.basicFormPOST(a)},a.updateDocInfo=function(a){a=a||{};var b=a.docData;a.onSuccess=a.success,a.onError=a.fail,a.url=b.getDocUpdateUrl(),a.data=b.getDocUpdateForm(),l.serverCall.basicFormPOST(a)},a.upgradeLegacyFiles=function(a){a=a||{};var b=a.docData;a.onSuccess=a.success,a.onError=a.fail,a.url=b.getLegacyUpgradeUrl(),a.data=b.getLegacyUpgradeData(),l.serverCall.basicFormPOST(a)},a.saveDocMeta=function(a){a=a||{};var b=a.docData;a.onSuccess=a.success,a.onError=function(b){return"function"==typeof a.fail?a.fail(b):null},a.url=b.getDocMetaUrl(),a.data=b.getDocMetaAsJSON(!0),l.serverCall.basicPOST(a)},a.buildFilesGroup=function(a,b){var c=a.validate(),d=a.getFiles(),e=[],f=[];return f=["pdf-input","epub-input","audio-input"],c.hasPdfFile&&e.push("pdf-input"),c.hasEpubFile&&e.push("epub-input"),c.hasAudioFile&&e.push("audio-input"),{files:d,uploadUrl:a.getFileUploadUrl(),clean:function(a){void 0!==e[a]&&e[a].length>0&&b.get(e[a]).remove()},cleanAll:function(){for(var a in f)void 0!==f[a]&&f[a].length>0&&b.get(f[a]).remove()}}},a.uploadFiles=function(b){var c=b.files,d=b.u_index;return d=d&&d>0?d:0,a.fileUpload({file:c[d],doc_id:h(b.doc_id),success:function(a){a.isSuccess=!0,"function"==typeof b.success&&b.success(a)},error:function(a){a.isSuccess=!1,"function"==typeof b.fail&&b.fail(a),"function"==typeof b.error&&b.error(a)},uploadUrl:b.uploadUrl,complete:function(e){return"function"==typeof b.clean&&b.clean(d),d<c.length-1?(b.u_index++,a.uploadFiles(b)):(e.isSuccess=!0,"function"==typeof b.cleanAll&&b.cleanAll(d),"function"==typeof b.complete?b.complete(e):void 0)}})},a.fileUpload=function(a){return a=a||{},l.serverCall.basicFileUpload({url:a.uploadUrl,data:{doc_id:h(a.doc_id),file_key:"client_file",file:a.file},success:a.success,error:a.error,fail:a.fail,complete:a.complete}),!0}}var l=a.awr||{},m=l.Q,n=a.pageshare||{};n.docServer=new k,n.watchBusyCallback=null;var o=[],p={}}(window,jQuery),function(a,b){function c(){var a=this;a.showGotShortKeyInfo=function(){b(".invite-key #shortKeyInfoToggle").addClass("hidden"),b(".invite-key #shortKeyInfo").removeClass("hidden")},a.getRegistrationKey=function(){return"string"==typeof a.fullKey?a.fullKey:null},a.setTicket=function(a){var b={fullKey:a,expires:new Date((new Date).getTime()+3e5)};localStorage.setItem("registrationTicket",JSON.stringify(b))},a.resetTicket=function(){localStorage.setItem("registrationTicket",null)},a.authorizeUI=function(b,c){var d=localStorage.getItem("registrationTicket");return d&&null!==d&&"null"!==d?(d=JSON.parse(d),"string"==typeof d.fullKey&&d.expires&&(new Date).getTime()<=new Date(d.expires).getTime()&&f.serial.basicPrime.check(d.fullKey)?void e.inviteView.validateAndReserveFullKey(d.fullKey,function(c){return a.setTicket(d.fullKey),"function"==typeof b&&b({fullKey:d.fullKey})},function(b){return a.resetTicket(),"function"==typeof c&&c()}):(a.resetTicket(),"function"==typeof c&&c())):(a.resetTicket(),"function"==typeof c&&c())},a.activate=function(c){b(".activate-field").addClass("activating"),setTimeout(function(){if("string"==typeof a.fullKey&&"function"==typeof e.inviteView.validateAndReserveFullKey){var c=b("#inviteFormLevel1"),d=b("#inviteFormLevel2");e.inviteView.validateAndReserveFullKey(a.fullKey,function(f){b(".activate-field").removeClass("activating"),b(d).removeClass("hidden"),b(c).addClass("hidden"),b(d).find("#accepted").removeClass("hidden"),b(d).find("#rejected").addClass("hidden"),b(d).find("#accepted").find(".key-preview").prepend(a.fullKey),b(d).find("#accepted").find("button.btn-success").on("click",function(b){a.setTicket(a.fullKey),e.easySignup.start()})},function(f){b(".activate-field").removeClass("activating"),b(c).addClass("hidden"),b(d).removeClass("hidden"),b(d).find("#accepted").addClass("hidden"),b(d).find("#rejected").removeClass("hidden"),b(d).find("#rejected").find(".key-preview").prepend(a.fullKey),b(d).find("#rejected").find("button.btn-success").on("click",function(a){e.easySignup.start()})})}else b(".invite-key .activate-field span.fa-remove").removeClass("hidden"),b(".invite-key .activate-field span.fa-check").addClass("hidden"),console.error("Can not proceed with key activation: bad key or required module [inviteView] missing")},2e3)},a.validate=function(c){var d=c&&c.target?c.target:{},e=b(d).val(),g=[8,37,38,39,40],h=[4,9,14,18];if(g.includes(c.keyCode)&&"paste"!==c.type)return void(e.length<=1&&b(".invite-key .activate-field span.fa-remove").addClass("hidden"));if("paste"===c.type||h.includes(e.length)&&c.keyCode>=48&&c.keyCode<=90){"paste"!==c.type&&189!==c.keyCode&&18!==e.length&&b(d).val(e+"-"),b(d).val(b(d).val().replace(/--/g,"-"));var i="paste"!==c.type?b(d).val()+String.fromCharCode(c.keyCode):c.clipboardData.getData("text"),j=f.serial.basicPrime.startsWithPattern(i,h.indexOf(i.length)+1);j?b(".invite-key .activate-field span.fa-remove").addClass("hidden"):(b(".invite-key .activate-field span.fa-remove").removeClass("hidden"),b(".invite-key .activate-field span.fa-check").addClass("hidden")),19===i.length&&j&&(j=f.serial.basicPrime.check(i),b(".invite-key .activate-field span.fa-remove").addClass("hidden"),b(".invite-key .activate-field span.fa-check").removeClass("hidden"),b(d).val(i),j?(b(d).attr("disabled","true"),b(".invite-key button").removeClass("disabled"),a.fullKey=i):(b(".invite-key .activate-field span.fa-remove").removeClass("hidden"),b(".invite-key .activate-field span.fa-check").addClass("hidden")))}}}function d(){function a(a,c,d){b(a).parent().hasClass("visited")||b(a).parent().addClass("visited"),b(a).parent().removeClass("valid"),b(a).parent().removeClass("not-valid"),b(a).parent().addClass(d?"not-valid":"valid"),d?b(c).addClass("not-valid"):b(c).removeClass("not-valid"),b(c).hasClass("visited")||b(c).addClass("visited")}function c(c,d){var e=b(c).attr("name");if("first_name"===e){var f=b('.error-desc li[name="fName"]'),g=!d.isFirstNameValid;a(c,f,g)}if("last_name"===e){var f=b('.error-desc li[name="lName"]'),g=!d.isLastNameValid;a(c,f,g)}if("email"===e){var f=b('.error-desc li[name="email"]'),g=!d.isEmailValid;a(c,f,g)}if("password"===e){var f=b('.error-desc li[name="password"]'),g=!d.isPasswordValid;a(c,f,g)}if("password_confirmation"===e){var f=b('.error-desc li[name="passwordConfirm"]'),g=!d.isPasswordConfirmationValid;a(c,f,g)}}function d(){var a=new FormData(b(".easy-signup form")[0]);return{firstName:a.get("first_name"),lastName:a.get("last_name"),email:a.get("email"),password:a.get("password"),passwordConfirmation:a.get("password_confirmation"),optional:[]}}function g(a,c,d){if("string"==typeof k.registrationKey){var f=k.registrationKey.split("-"),g=[f[0],f[1]].join("-");a.append("registrationKey",g)}b.ajax({url:"admin/auth/signup",type:"POST",data:a,async:!0,processData:!1,contentType:!1,success:function(a){e.limitedSignup.resetTicket(),"function"==typeof c&&c(a)},error:function(a){e.limitedSignup.resetTicket();var b=a.responseJSON||{};console.error("Pageshare: Failed to register new user"),"function"==typeof d&&d(b)}})}function h(){e.basicModal.busy({message:'<div class="signup-wait"><img src="assets/img/spining_dots.gif" style="width: 60px"/> <strong class="tex-info">Signed up successfully. Logging in...</strong></div>'}),e.UI.reload(),setTimeout(function(){e.basicModal.stop(),f.router.goToRoot()},500)}function i(){e.basicModal.busy({message:'<div class="signup-wait"><img src="assets/img/spining_dots.gif" style="width: 60px"/> <strong class="tex-info">Please Wait a moment...</strong></div>'})}function j(a,c){a=a||{},e.basicModal.release({message:""});var d=b(l({values:{fName:a.firstName||"",lName:a.lastName||"",email:a.email||"",password:a.password||"",passwordConfirm:a.passwordConfirmation||""}}));k.index(d),setTimeout(function(){c.signup_msg&&"email in use"===c.signup_msg&&(b('.error-desc li[name="emailInUse"]').addClass("error"),b('.easy-signup form input[name="email"]').css("background","pink"),c.data&&c.data.email&&k.takenEmails.push(c.data.email))},200)}var k=this;k.takenEmails=[];var l=Pageshare.Templates["assets/modules/easySignup/easySignup.hbs"],m=Pageshare.Templates["assets/modules/easySignup/easySignupLimited.hbs"];k.visited={fName:!1,lName:!1,email:!1,password:!1,passwordConfirm:!1},k.start=function(a){if(void 0!==e.currentUser&&null!==e.currentUser)return e.UI.reload(),void f.router.goToRoot();var c=b(l({values:{}}));e.shelfCtrl&&e.shelfCtrl.close,e.basicModal.stop(),e.basicModal.start({mainClass:"active-login",actionName:"",actionClass:"btn-primary",isInfo:!1,action:null,hideFooter:!0,onClose:function(){f.router.back(!0)}}),k.index(c),f.router&&f.router.go("easy-signup",{attrs:{b_name:"redirect",b_ref:"index"}},!1)},k.index=function(a){var d=function(){e.basicModal.update({title:"<h1 class='fa fa-lock '> Please sign up for Pageshare <small>It's free!</small></h1>",message:b(a)});var d=b(".easy-signup form input");b(d).on("keypress",function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation())}),b(d).on("keydown",function(a){setTimeout(function(){c(a.target,k.validate())},300)})};e.limitedSignup.authorizeUI(function(c){c=c||{},k.registrationKey="string"==typeof c.fullKey?c.fullKey:null,b(a).find(".main .panel.form-panel").removeClass("hidden"),d()},function(){b(a).find(".main").prepend(b(m({}))),d()})},k.register=function(){var a=f.validation.basicUserInfoValidator,c=d(),e=a.isValid(c),k=new FormData(b(".easy-signup form")[0]);e?(i(),setTimeout(function(){g(k,function(){h()},function(a){j(c,a)})},500)):(b(".easy-signup .form-group").addClass("visited"),b(".easy-signup .form-group input").trigger("keydown"))},k.validate=function(){var a=f.validation.basicUserInfoValidator,c=d(),e=a.test(c);if(b('.error-desc li[name="emailInUse"]').removeClass("error"),b.inArray(c.email,k.takenEmails)>=0){e.isEmailValid=!1;b(b('.error-desc li[name="emailInUse"]')).addClass("error"),b('.easy-signup form input[name="email"]').css("background","pink")}else b('.easy-signup form input[name="email"]').css("background","#fff");return e}}var e=a.pageshare||{};e.easySignup=new d,e.limitedSignup=new c;var f=a.awr||{};a.pageshare=e}(window,jQuery),function(a,b){"use strict";function c(){function a(){var a=this,g=d.importClass("BasicTable@UIComps"),h=d.importClass("BasicTableContext@UIComps"),i=d.importClass("BasicTableCTR@UIComps"),k=d.importClass("BasicTableCTRConf@UIComps"),l=new c(a),m=new k(l),n=new i(m),o=new h(new f);this.view=new g(n,o),this.start=function(){if(b("#mainlogo > div.text").text("PageShare"),b("body").removeClass("has_book_info"),e.bookInfoDom=null,!j.$objectExist(e.currentUser))return void d.router.pushLink("/app#c/index");a.view.$start(),e.shelfCtrl.open(),e.UI.setDefaultEventHandlers()}}function c(a){function b(){j.$objectExist(e.collServer)&&e.collServer.findAllCollections(function(a){e.mainMenu.reload(a)})}this.userModelParams={api_path:"api",url:"user"},this.collectionModelParams={api_path:"api",url:"collection"},this.removeConfirmFunction=g,this.loggedInUserDetector=h,this.getLoggedInUserId=i,this.afterSave=function(a,c){b()},this.afterRemove=function(a,c){b()},this.afterCreate=function(a,c){b()},this.afterToggle=function(c,d){j.$objectExist(e.currentUser)&&j.$objectExist(d)&&(e.currentUser.main_collection=d.main_collection,e.currentCollection=j.$collect(e.collections,function(a){if(j.$stringEqual(this.id+"",d.main_collection+""))return this}),a.view.$rebuild(),b())},this.beforeToggle=function(a,b){b.main_collection=j.$stringEqual(b.main_collection,a.id)?null:a.id+""},this.getToggleModel=function(a,b){return b}}function f(){this.mainTableTitle="Edit Collections:",this.createTitle="Create new collection",this.itemCountTitle="Documents",this.itemDateTitle="Created",this.toggleTitle="Main collection",this.toggleOnName="Main",this.itemName="Collection",this.backLink=function(){var a="#c/16",b=j.$functionExist(e.getUserMainCollection)?e.getUserMainCollection():null;return j.$objectExist(b)&&j.$stringExist(b.id)&&(a="#c/"+b.id),a},this.backLinkName="Back to collection",this.tableId="editCollectionsMain",this.rootContainerSelector="#ajax-content",this.itemCountFunction=function(a){return j.$arrayExist(a.docs)?a.docs.length:0}}function g(a,b){e.basicModal.start({mainClass:"remove-coll-info",actionName:"Remove",title:" Remove collection",titleIcon:"fa fa-exclamation-triangle text-warning",message:"If you proceed you will loose the access for all the documents containing this collection. This action can not be undone!",actionClass:"btn-danger",action:function(){j.$functionExist(a)&&j.$qTry(a),this.stop()},cancelName:"Cancel"})}function h(){return j.$objectExist(e.currentUser)&&j.$exist(e.currentUser.user_id)}function i(){return j.$objectExist(e.currentUser)&&j.$exist(e.currentUser.user_id)?e.currentUser.user_id:null}var j=this;e.editCollections=new a}a.awr=a.awr||{},a.awr.bootQueue=a.awr.bootQueue||[];var d=a.awr||{},e=a.pageshare||{},f=d.bootQueue,g=(a.Promise,{moduleName:"editCollections@AppModule",requires:[{name:"awr.$$appEssentials",type:"object"},{name:"BasicTableGroup@AWRBundle",type:"bundle"}],wTime:6e3,init:c,QAsContext:!0});f.push(g)}(window,jQuery),function(a,b){"use strict";function c(){function c(){}function e(){}var f,g=this,h=Pageshare.Templates["assets/modules/imgCache/imgCache.hbs"];c.prototype.initCache=function(){g.$arrayNotEmpty(b("#awrImgCache"))||(f=b(h({})),b("body").append(f))},c.prototype.createGroup=function(a){g.$stringExist(a)&&!g.$arrayNotEmpty(b("#awrImgCache").find("div#grp-"+a))&&b("#awrImgCache").append('<div id="grp-'+a+'"></div>')},c.prototype.addToGroup=function(a,c){var d=b("#awrImgCache").find("#grp-"+a);g.$stringExist(a)&&g.$arrayNotEmpty(d)&&g.$stringExist(c)&&!g.$arrayNotEmpty(b(d).find('img[src="'+c+'"]'))&&b(d).append('<img src="'+c+'" />')},c.prototype.inCache=function(a,c){var d=b("#awrImgCache").find("#grp-"+a);return g.$stringExist(a)&&g.$arrayNotEmpty(d)&&g.$arrayNotEmpty(b(d).find('img[src="'+c+'"]'))},c.prototype.getImg=function(a,c,d){function e(){var a=this;b(this).off("load",e),setTimeout(function(){b(a).attr("src",b(a).data("original-src"))},500)}d=d||{};var f,h=null,i=d.placeHolder;return f=this.inCache(a,c)?b("#awrImgCache").find("#grp-"+a).find('img[src="'+c+'"]').clone():b('<img src=" '+c+'"'),g.$exist(d.width)&&b(f).attr("width",d.width),g.$exist(d.height)&&b(f).attr("height",d.height),g.$exist(i)&&(f.width=d.width,f.height=d.height,h=b('<img data-original-src=" '+c+'" />'),b(h).on("load",e).attr("src",g.$stringExist(i)?i:g.$functionExist(i)?i(f):"")),g.$objectExist(h)?h:f};var i={$$imgCache:new c};d.imgCache=i.$$imgCache,this.$installInAWRGlobal("imgCache","$$imgCache",i);var j=!!a.opr&&!!opr.addons||!!a.opera||navigator.userAgent.indexOf(" OPR/")>=0,k="undefined"!=typeof InstallTrigger,l=/constructor/i.test(a.HTMLElement)||function(a){return"[object SafariRemoteNotification]"===a.toString()}(!a.safari||safari.pushNotification),m=!!document.documentMode,n=!m&&!!a.StyleMedia,o=!!a.chrome&&!!a.chrome.webstore,p=(o||j)&&!!a.CSS;e.prototype.$isOpera=function(){return j},e.prototype.$isFirefox=function(){return k},e.prototype.$isSafari=function(){return l},e.prototype.$isIE=function(){return m},e.prototype.$isEdge=function(){return n},e.prototype.$isChrome=function(){return o},e.prototype.$isBlink=function(){return p},d.agentDetect=new e,this.$installInAWRGlobal("agentDetect","$$agentDetect",{$$agentDetect:new e})}a.awr=a.awr||{},a.awr.bootQueue=a.awr.bootQueue||[];var d=a.awr||{},e=d.bootQueue,f={moduleName:"$$imgCache@APP",requires:[{name:"awr.$$appEssentials",type:"object"}],wTime:500,init:c,QAsContext:!0};e.push(f)}(window,jQuery),function(a,b){function c(){function a(a){return a?b(a).find("span.key")[0]:null}function c(a){return a?b(a).parent().parent().parent().parent():null}function d(a){a=a||{},b.ajax({url:"cmd/serial/"+a.path,type:a.type,data:a.data,async:!0,cache:!1,contentType:"application/json",processData:!0,success:function(b){return"function"==typeof a.success?a.success(b):void 0},error:function(b){return"function"==typeof a.error?a.error(b):void 0}})}function e(a){var b=a.key;if("BasicPrime AD"===a.mode){var c=a.key.split("-");b=awr.serial.basicPrime.generateOne({alpha:c[0].split(""),delta:c[1].split("")})}return{keyStatus:a.status,serialNumber:b,createdBy:"Admin",created:a.created,expires:f(new Date(a.expires)),serverObject:a,domId:"key-"+a.key}}function f(a){if(a&&a instanceof Date){var b=[a.getDate(),a.getMonth()+1,a.getFullYear()],c=[a.getHours(),a.getMinutes()];return c[0]=c[0]<10?"0"+c[0]:c[0],c[1]=c[1]<10?"0"+c[1]:c[1],b.join(".")+" at "+c.join(":")}return"-"}function g(a){return awr&&awr.ux&&"function"==typeof awr.ux.copyToClipboard?awr.ux.copyToClipboard(a):null}var h=this,i=Pageshare.Templates["assets/modules/inviteView/inviteView.hbs"],j=Pageshare.Templates["assets/modules/inviteView/inviteKey.hbs"];h.keys=[],h.currentFilterQuery="all",h.generateSet=function(){b(".invite-view .header > .panel > .panel-footer").addClass("generating");var a=awr.serial.basicPrime.generate(10),c=[];for(var f in a){var g=a[f].split("-");c.push({group:"registration",key:g[0]+"-"+g[1]})}d({path:"push",data:JSON.stringify({group:"registration",set:c}),type:"POST",success:function(a){for(var c in a.setForGroup){var d=a.setForGroup[c],f=e(d);h.keys.push(f)}setTimeout(function(){h.filterByStatus(h.currentFilterQuery),b(".invite-view .header > .panel > .panel-footer").removeClass("generating")},1e3)},error:function(a){console.error(a)}})},h.start=function(){var a=b(i({}));b("#ajax-content").html(a),d({path:"list",data:JSON.stringify({group:"registration"}),type:"POST",success:function(a){for(var b in a){var c=a[b],d=e(c);h.keys.push(d)}h.showKeys(h.keys)},error:function(a){console.error(a)}})},h.filterByStatus=function(a,c){if(a instanceof Event&&"string"!=typeof a?a.preventDefault():c=a,c&&"string"==typeof c&&c.length>0){var d=b.grep(h.keys,function(a,b){return"all"===c||a.keyStatus===c}),e="valid-key"===c?"validKeysTab":"expired-key"===c?"expiredKeysTab":"reserved-key"===c?"reservedKeysTab":"allKeysTab";b(b(".invite-view  .header  .panel  .panel-footer  ul  li")).removeClass("active"),b("#"+e).addClass("active"),h.showKeys(d),h.currentFilterQuery=c}},h.showKeys=function(a){var c=b(".invite-view .main");if(b(c).html(""),a&&a instanceof Array){a.sort(function(a,b){return new Date(a.created).getTime()-new Date(b.created).getTime()}),a.reverse();for(var d in a){var e=a[d],f=b(j(e));b(c).append(f)}}},h.reserve=function(f){var g=c(b(f.target));if(g){b(g).find(".tools .reserve").addClass("disabled"),b(g).find(".tools .invalidate").addClass("disabled"),b(g).addClass("seeking-key");var i=a(g),j=b(i).text(),k=j?j.split("-"):[];if("string"==typeof j&&k.length>=2){var l=[k[0],k[1]].join("-"),m="reserved-key";for(var n in h.keys){var o=h.keys[n];o.serialNumber===j&&"reserved-key"===o.keyStatus&&(m="valid-key")}d({path:"update",data:JSON.stringify({group:"registration",key:l,keyStatus:m}),type:"POST",success:function(a){var c=a.updated;if(c)for(var d in h.keys){var f=h.keys[d];f.serverObject.key===c.key&&(h.keys[d]=e(c))}setTimeout(function(){b(g).find(".tools .reserve").addClass("disabled"),b(g).find(".tools .invalidate").addClass("disabled"),b(g).addClass("seeking-key"),h.filterByStatus(h.currentFilterQuery)},2e3)},error:function(a){console.error(a)}})}}},h.invalidate=function(f){var g=c(b(f.target));if(g){b(g).find(".tools .reserve").addClass("disabled"),b(g).find(".tools .invalidate").addClass("disabled"),b(g).addClass("seeking-key");var i=a(g),j=b(i).text(),k=j?j.split("-"):[];if("string"==typeof j&&k.length>=2){var l=[k[0],k[1]].join("-");d({path:"invalidate",data:JSON.stringify({group:"registration",key:l}),type:"POST",success:function(a){var c=a.updated;if(c)for(var d in h.keys){var f=h.keys[d];f.serverObject.key===c.key&&(h.keys[d]=e(c))}setTimeout(function(){b(g).find(".tools .reserve").addClass("disabled"),b(g).find(".tools .invalidate").addClass("disabled"),b(g).addClass("seeking-key"),h.filterByStatus(h.currentFilterQuery)},2e3)},error:function(a){console.error(a)}})}}},h.copyKey=function(d){var e=c(b(d.target));if(e){var f=a(e);return e?g(f):null}},h.mobileCopyKey=function(c){var d=b(c.target).parent(),e=a(d);return e?g(e):null},h.validateAndReserveFullKey=function(a,b,c){var e="string"==typeof a?a.split("-"):[];if(!(e&&e instanceof Array&&e.length>=2))return"function"==typeof c&&c({reason:"Bad key"});var f=awr.serial.basicPrime.check(a),g=[e[0],e[1]].join("-");if(!f)return"function"==typeof c&&c({reason:"bad key"});d({path:"update",data:JSON.stringify({group:"registration",key:g,keyStatus:"reserved-key"}),type:"POST",success:function(a){var d=a.updated;return d?"function"!=typeof b||b(d):"function"==typeof c&&c({reason:"No confirmation from server"})},error:function(a){return"function"==typeof c&&c({reason:"Failed by server",errorResponse:a})}})}}var d=a.pageshare||{};d.inviteView=new c,a.pageshare=d}(window,jQuery),function(a,b){function c(){function c(){e=awr.router.getCurrentState()||{},d.bookInfoDom=null;var a=Pageshare.Templates["assets/modules/mainHeader/mainHeader.hbs"],c=b("#book_info"),g=b("#frontPageLink").val(),h=a({frontPageLink:g,hasBookName:d.currentDoc&&d.currentDoc.book&&d.currentDoc.book.book_name,bookName:d.currentDoc&&d.currentDoc.book?d.currentDoc.book.book_name:"PageShare"});b("#mainHeaderContainer").html(h),f.loadFreemiumLogo(),"premium"!==b("body").attr("id")&&(b(c).length<=0?b(".navbar-fixed-top").append('<div id="book_info" class="book-info"></div>'):b(".navbar-fixed-top").append(b(c)),b("#book_info").removeClass("hidden"),b("#mainlogo").find(".arrows").removeClass("hidden")),setTimeout(function(){e=awr.router.getCurrentState()||{},d.currentUser&&"doc-link"===e.name&&(b("#book_info").find(".editBook").removeClass("hidden"),b("#book_info").find(".link-element").on("click",function(){awr.router.go("doc-edit",{params:{docId:d.currentDoc.book.id}})})),"doc-edit"===e.name&&(b("#book_info").addClass("hidden"),b("#mainlogo").find(".text").text("PageShare"),b("#mainlogo").find(".arrows").addClass("hidden")),b("#sidebar-toggle").click(function(){}),b("#contents").off("click"),b("#sidebar-toggle").off("click"),b("#contents").on("click",function(){b("body").removeClass("book_info_open")}),b("#sidebar-toggle").on("click",function(a){a.preventDefault(),d.mainMenu.toggleMainMenu(),d&&d.userNav&&d.userNav.hideInfo()}),d.bookInfoDom=b("#book_info")},200)}var e,f=this;b(document).ready(function(){awr.Q.$waitForComps({name:"awr.routeManager",type:"object"}).then(function(){c()},function(a){console.error("Failed to init mainHeader in APP! \n\t +Details: "+a)})}),f.reload=c,f.loadFreemiumLogo=function(){b("#mainlogo span.text").click(function(c){if("premium"!==b("body").attr("id"))if(b("body").is(".has_book_info"))c.preventDefault(),c.stopPropagation(),b.each(b("#book_info a"),function(a,c){a>0&&b(this).text(awr.ux.capitalizeName(b(c).text()))}),b("body").toggleClass("book_info_open");else{c.preventDefault(),c.stopPropagation();var d=b("#frontPageLink").val();d&&(a.location=d)}}),b("#mainlogo .arrows").click(function(a){b("body").is(".has_book_info")&&(a.preventDefault(),a.stopPropagation(),b.each(b("#book_info a"),function(a,c){a>0&&b(this).text(awr.ux.capitalizeName(b(c).text()))}),b("body").toggleClass("book_info_open"))})}}var d=a.pageshare||{};d.mainHeader=new c,a.pageshare=d}(window,jQuery),function(a,b){function c(){function c(){var c=a.sessionStorage.getItem("toggleMainMenu"),g=f.$numberEqual(c,1)||f.$stringEqual(c,"1");a.sessionStorage.setItem("toggleMainMenu",g?0:1),b("body").toggleClass("open-sidebar",!g),(e.agentDetect.$isFirefox()||e.agentDetect.$isSafari())&&setTimeout(function(){d.mainMenu.reload()},1500)}function g(){console.error("someone toggled"),a.sessionStorage.setItem("toggleMainMenu",1),b("body").toggleClass("open-sidebar",!0)}function h(){a.sessionStorage.setItem("toggleMainMenu",0),b("body").toggleClass("open-sidebar",!1)}function i(a){var c,g=f.$map(a,function(){if(f.$booleanFalse(f.$setContainsString(["Principles","principles"],this.name)))return this});!function(a){f.$forEachIndex(a,function(a,b){a.isSelected=f.$objectExist(d.currentCollection)&&f.$exist(a.id)&&f.$stringEqual(a.id+"",d.currentCollection.id+""),a.$$visibleDocCount$$=f.$collect(a.docs,function(a){a=a||0;var b=f.$booleanTrue(d.docServer.isDocVisible(this)),c=f.$objectExist(d.currentUser)&&f.$booleanTrue(d.currentUser.is_admin);return f.$or(c,b)&&a++,a}),a.$$visibleDocCount$$=f.$numberExist(a.$$visibleDocCount$$)?a.$$visibleDocCount$$:0}),c=b(m({collections:a,userExist:f.$objectExist(d.currentUser)})),f.$objectExist(e.domAttrs)&&f.$functionExist(e.domAttrs.$compile)&&e.domAttrs.$compile(c,{router:e.router}),b("#mainMenu").html(c),d.currentCollection&&d.collections&&j.resetSelected(),b("#mainMenu").perfectScrollbar(),d.activeLogin.toggleCommunityAuthUI()}(g)}var j=this,k=a.sessionStorage.getItem("toggleMainMenu"),l=f.$numberEqual(k,1)||f.$stringEqual(k,"1"),m=Pageshare.Templates["assets/modules/mainMenu/mainMenu.hbs"];b("body").removeClass("open-sidebar"),"premium"===b("body").attr("id")?(a.sessionStorage.setItem("toggleMainMenu",0),j.close()):(a.sessionStorage.setItem("toggleMainMenu",l?1:0),setTimeout(function(){b("body").removeClass("open-sidebar"),b("body").toggleClass("open-sidebar",l)},200)),j.updateMenuScrollbar=function(a){setTimeout(function(){b("#mainMenu").perfectScrollbar("update")},a||1)},j.open=g,j.close=h,j.toggleMainMenu=c,j.menuAction=function(c,f){c.preventDefault();var g=null,h=d.serverVariables;if(f){if("scroll"===f)b("html, body").animate({scrollTop:0},"fast");else if("collections"===f){var i=b("#mainMenu").find("ul > li.collections.parent");b(i).toggleClass("open",!b(i).hasClass("open"))}else h&&h.legacyMainMenuModel&&("freeSoftware"===f?g=b.grep(h.legacyMainMenuModel,function(a,b){return(a.title||"").toLowerCase().startsWith("free software")}):"principles"===f&&(g=b.grep(h.legacyMainMenuModel,function(a,b){return"principles"===(a.title||"").toLowerCase()})));if(g=g&&g.length?g[0]:null){var j=g.url?g.url.split("/"):[];"principles"===f&&j.length?e.router.go("coll-index",{params:{cId:j[j.length-1]}}):a.location=g.url}}},j.resetSelected=function(){if(d.currentCollection&&d.collections){var a=d.currentCollection.id,c=b("#mainMenu").find(".parent").find("a"),e=b("#mainMenu").find(".parent").find('a[awr-link="#c/'+a+'"]');b(c).removeClass("selected"),b(e).addClass("selected")}},j.reload=function(){var a=d.collections;j.reloadLock=e.ux.initLock(j.reloadLock),j.reloadLock.setDuration(1e3),e.ux.execWithLock(j.reloadLock,function(){i(a)})},j.setSelected=function(a){var c=b("#mainMenu"),d=b(c).find('.c-item[data-c-id="'+a+'"]'),e=b(c).find('.c-item.selected[data-c-id="'+a+'"]');f.$stringExist(a+"")&&f.$arrayNotEmpty(d)&&!f.$arrayNotEmpty(e)&&(b(c).find(".c-item").removeClass("selected"),b(d).addClass("selected"))}}var d=a.pageshare||{},e=a.awr||{},f=e.Q;d.mainMenu=new c,a.pageshare=d}(window,jQuery),function(a,b){function c(){function a(){var a=b(d({}));b(".navbar .navbar-inner .container-fluid #mainlogo").after(b(a))}var c=this,d=Pageshare.Templates["assets/modules/searchBar/searchBar.hbs"];c.start=function(){a(),b.each(b("#mainMenu ul li.parent ul li"),function(){b(this).text();console.log(b(this).find("a").text())})}}var d=a.pageshare||{};d.searchBar=new c,a.pageshare=d}(window,jQuery),function(a,b){"use strict";function c(){function a(a){return new Promise(function(b,c){j.docServer.waitForBusyDoc(a,function(){b("ready")},"collection-"+a)})}function c(a){return new Promise(function(b,c){i.$stringExist(a+"")&&(a.startsWith("doc-")||a.startsWith("d"))||c("bad docId"),j.docServer.getDocState(a,function(a){b(a)})})}function d(a,c,d){if(d=i.$numberExist(d)&&d>=0?d:0,i.$stringExist(a+"")&&i.$stringExist(c)){var e=b("#shelf").find('.cover[data-book-id="'+a+'"]')[0],f=b(e).find("img.cover-img")
;if(i.$objectExist(h.imgCache)&&h.imgCache.inCache("shelf-covers",c))return b(e).find(".caption").removeClass("loading"),void b(e).find(".caption").fadeOut("fast",function(){f=h.imgCache.getImg("shelf-covers",c),b(f).addClass("cover-img"),b(f).css("display","inline"),b(e).find("img.cover-img").replaceWith(f)});i.$objectExist(h.imgCache)&&h.imgCache.addToGroup("shelf-covers",c),setTimeout(function(){b(f).attr("src",c),b(e).find(".caption").fadeOut(500,function(){b(f).fadeIn(1e3)})},d)}}return i.$waitForComps({name:"awr.imgCache",type:"object"}).then(function(){h.imgCache.initCache(),h.imgCache.createGroup("shelf-covers")},function(a){}),{$waitForBusyDoc:a,$getDocState:c,$setInReadyState:d}}function d(){function a(){b("#shelf").remove(),b(".book-content-separator").remove()}function c(){var a=b("#shelf");return i.$arrayNotEmpty(a)?a[0]:i.$objectExist(a)?a:null}function d(){b("#shelf").find(".cover .caption").addClass("loading")}function e(){var a=b("#shelf").find(".cover");return i.$arrayExist(a)?a:[]}function f(a){return b(a).data("book-id")}function g(a){i.$objectExist(a)&&(b("#shelf").find(".cover").removeClass("selected"),b("#shelf").find(".cover[data-book-id="+a.id+"]").addClass("selected"),i.$stringExist(a.id)&&a.id.startsWith("doc-")&&b("#shelf").find(".cover[data-book-id="+a.id.replace("doc-","d")+"]").addClass("selected"))}function h(a){a=i.$stringExist(a)?a:"--null---";var c=b("#shelf").find('.cover[data-book-id="'+a+'"]');return i.$arrayNotEmpty(c)?c[0]:i.$objectExist(c)?c:null}function j(a){return!!i.$objectExist(a)&&(b(a).find(".caption").addClass("forbidden"),b(a).find(".caption").removeClass("loading"),b(a).find(".caption").removeClass("working"),b(a).addClass("forbidden"),!0)}function k(a,c){i.$stringEqual(a.id+"","aggregated-collection")||(i.$objectExist(c)&&!i.$stringEqual(c.user_id+"",a.owner_id+"")?(b("#shelf .coll-owner-info").removeClass("hidden"),b("body").hasClass("open-sidebar")?b("#shelf .coll-owner-info").css("right","245px"):b("#shelf .coll-owner-info").css("right","15px"),b("#shelf .coll-owner-info .fa-remove").off("click"),b("#shelf .coll-owner-info .fa-remove").on("click",function(a){a.preventDefault(),b("#shelf .coll-owner-info").addClass("hidden")}),setTimeout(function(){b("#shelf .coll-owner-info").fadeOut(1e3)},4500),b("#shelf .cover.add-book").addClass("hidden")):(b("#shelf .coll-owner-info").addClass("hidden"),b("#shelf .cover.add-book").removeClass("hidden")))}function l(a){return!!i.$objectExist(a)&&(b(a).addClass("admin-only"),b(a).find(".caption").append("<span style='position:absolute;bottom:0;left:0;height:15px' class='fa fa-unlock'>&nbsp;admin</span>"),!0)}function m(a){return!!i.$objectExist(a)&&(b(a).find(".caption").removeClass("loading"),b(a).find(".caption").removeClass("loading"),b(a).find(".caption").addClass("working"),!0)}function n(a){return!!i.$objectExist(a)&&(b(a).remove(),!0)}return{$setCoversInLoadingMode:d,$getShelfDom:c,$getCovers:e,$setInAdminMode:l,$setInForbiddenMode:j,$setInSecureMode:n,$getCoverId:f,$getCoverByDocId:h,$setInWorkingMode:m,$removeShelf:a,$notifyWhoIsOwner:k,$setAsSelected:g}}function e(a,c){function d(a){j.shelfCtrl.currentShelfDom=null,c.$removeShelf();var b=j.currentCollection,d=j.currentUser,f=a,h=a.docs;h=i.$arrayExist(h)?h:[],h=i.$map(h,function(){var a=i.$objectExist(this.book)?this.book:this;return i.$functionExist(j.collServer.fixMissingLegacyDocAPI)&&j.collServer.fixMissingLegacyDocAPI(a),a}),f.docs=h,f=e(f),o(f),g(f.docs),i.$objectExist(b)&&i.$stringEqual(a.id+"",b.id+"")&&c.$notifyWhoIsOwner(b,d),j.shelfCtrl.currentShelfDom=c.$getShelfDom()}function e(a){var b=[],c=j.currentDoc?j.currentDoc.book:{};return i.$forEachIndex(a.docs,function(a,d){a=i.$objectExist(a.book)?a.book:a,i.$functionExist(j.collServer.fixMissingLegacyDocAPI)&&j.collServer.fixMissingLegacyDocAPI(a),a.isSelected=a.id===c.id;var e=a.name.replace(/[\!\?\/\=\#\.]/g,"").replace(/\s/g,"_").toLowerCase(),f=a.id.startsWith("doc-")?a.id.replace("oc-",""):a.id;a.uiLink="#v/"+e+"/"+f+"/index",b.push(a)}),a.shelf_editable=j.currentUser&&a&&j.currentUser.user_id===a.owner_id,{shelf_id:j.currentCollection?j.currentCollection.id:"main",shelf_editable:a.shelf_editable,docs:b}}function g(b){if(i.$arrayExist(b)){c.$setCoversInLoadingMode();var d=i.$map(b,function(){if(i.$booleanFalse(m(this)))return this.id}),e=i.$map(b,function(){return k(this)?this.id:void 0});i.$forEachIndex(c.$getCovers(),function(a,b){var f=c.$getCoverId(a),g=i.$setContainsString(d,f),h=i.$setContainsString(e,f);i.$booleanTrue(g)&&c.$setInForbiddenMode(a),i.$booleanTrue(h)&&c.$setInAdminMode(a),i.$booleanTrue(g)&&i.$booleanFalse(h)&&c.$setInSecureMode(a)}),i.$forEachIndex(b,function(b,d){var e=b.id,f=b.file_url_cover;i.$stringExist(e+"")&&(i.$objectExist(h.imgCache)&&h.imgCache.inCache("shelf-covers",f)&&a.$setInReadyState(e,f,0),a.$getDocState(e).then(function(b){i.$booleanTrue(b.is_busy)?(c.$setInWorkingMode(c.$getCoverByDocId(e)),a.$waitForBusyDoc(e).then(function(){a.$setInReadyState(e,f,400)})):a.$setInReadyState(e,f,400)},function(){i.$stringExist(f)&&a.$setInReadyState(e,f,400)}))})}}function k(a){return i.$booleanFalse(j.docServer.isUserDocOwner(a))&&i.$booleanFalse(n(a))&&i.$booleanTrue(l())}function l(){return i.$objectExist(j.currentUser)&&i.$booleanTrue(j.currentUser.is_admin)}function m(a){return i.$or(l(),n(a))}function n(a){return i.$objectExist(j.docServer)?j.docServer.isDocVisible(a):(h.errorLog("shelfCtrl@App","App module docServer is missing, but required.","Pageshare.docServer is required for determining doc visibility in shelf"),!1)}function o(a){a=a||{};var c,d,e=Pageshare.Templates["assets/modules/shelfCtrl/shelf.hbs"],g=i.$objectExist(j.currentDoc)&&i.$objectExist(j.currentDoc.book)?j.currentDoc.book:i.$objectExist(j.currentDoc)?j.currentDoc:null,k=f(g);a.docs=i.$arrayNotEmpty(a.docs)?i.$map(a.docs,function(){return c=f(this),this.isSelected=i.$exist(c)&&i.$exist(k)&&i.$exist(g)&&i.$stringEqual(k,c),this}):a.docs,d=b(e(a)),i.$objectExist(h.domAttrs)&&h.domAttrs.$compile(d,{router:h.router}),b("#contents").prepend(d)}return{setCurrentCollectionInView:d}}function f(a){var b;return i.$objectExist(a)?(b=i.$stringExist(a.id)?a.id:i.$objectExist(a.book)&&i.$stringExist(a.book.id)?a.book.id:null,b=i.$stringExist(b)&&b.startsWith("d")&&i.$booleanFalse(b.startsWith("doc-"))?b.replace("d","doc-"):b):null}function g(){function a(){j.collServer;j.shelfCtrl.currentShelfDom=null,h.Q.$waitForComps([{name:"pageshare.collServer",type:"object"},{name:"pageshare.currentCollection",type:"object"}]).then(function(){return i.$objectExist(j.currentDoc)?f():h.Q.$waitForComps([{name:"pageshare.currentDoc",type:"object"}]).then(function(){i.$objectExist(j.currentDoc)&&f()},function(a){f()})},function(a){})}function f(){var a=j.currentCollection;i.$objectExist(a)&&g.viewService.setCurrentCollectionInView(a)}var g=this,k=new c,l=new d;g.viewService=new e(k,l),g.close=function(){b("#shelf").css("display","none"),b(".book-content-separator").remove()},g.reload=function(){g.reloadLock=h.ux.initLock(g.reloadLock),g.reloadLock.setDuration(50),h.ux.execWithLock(g.reloadLock,function(){a()})},g.open=function(){g.openLock=h.ux.initLock(g.openLock),g.openLock.setDuration(50),h.ux.execWithLock(g.openLock,function(){f()})},g.resetSelected=function(){l.$setAsSelected(j.currentDoc)}}var h=a.awr||{},i=h.Q,j=a.pageshare||{};j.shelfCtrl=new g,j.shelfCtrl.currentShelfDom=null,a.pageshare=j}(window,jQuery),function(a,b){"use strict";function c(){function c(){function c(c){var d=e.$objectExist(c)?c:null,i=e.$objectExist(d)&&e.$objectExist(d.params)&&e.$stringExist(d.params.query+"")?d.params.query:"";i=i.replace(/\_/g," "),f=e.$objectExist(d)&&e.$objectExist(d.attrs)&&e.$exist(d.attrs.current)&&e.$stringExist(d.attrs.current+"")?d.attrs.current:"index",i=a.decodeURI(i);var k,l,m=[];pageshare.collServer.findAllCollections(function(a){k=e.$map(a,function(){return this.docs}),l=e.$flatten(k,function(){if(e.$stringExist(this.id+"")&&!e.$setContainsString(m,this.id+""))return m.push(this.id+""),this}),l=e.$arrayExist(l)?l:[],j=pageshare.scoredDocSearch.searchByQuery(l,i),j=e.$reduce(j,function(){return e.$stringEqual(this.allow_aggregating+"","1")}),pageshare.UI.show(function(){pageshare.currentCollection={id:"aggregated-collection",owner_id:e.$objectExist(pageshare.currentUser)?pageshare.currentUser.id:"0",docs:j},pageshare.shelfCtrl.open(),setTimeout(function(){b.each(b("#shelf .cover"),function(){b(this).attr("awr-link",null),b(this).off("click"),b(this).on("click",function(a){a.preventDefault(),h(b(this).data("book-id")+"",d)})})},250),e.$arrayNotEmpty(j)?e.$qTry(function(){h(e.$stringEqual(f+"","index")?j[0].id+"":f,d)},function(){g()}):g()})})}function g(){b("#shelf").css("min-height","250px"),b("#shelf").append('<div class="empty-search" style="width: 100%;text-align: center"><h3><span class="fa fa-meh-o fa-2x">&nbsp;</span></h3><br/><h3>Sorry, but there is no result to show for this search!</h3></div>'),b("#ajax-content").html("")}function h(a,b){var c=a+"";pageshare.UI.hide(),setTimeout(function(){c=e.$stringExist(c)&&c.startsWith("d")&&e.$booleanFalse(c.startsWith("doc-"))?"doc-"+c.replace("d",""):c,pageshare.docReader.openPreview({docId:c,complete:function(c){i(c,a,b)}})},50)}function i(a,c,f){var g=pageshare.currentDoc;g=e.$objectExist(g)&&e.$objectExist(g.book)?g.book:g,b('<div class="open-doc"></div>').html(a),d.domAttrs.$compile(b(a),{router:d.router}),b("#ajax-content").html(b(a).find(".open-doc")),e.$objectExist(f)&&(f.attrs=e.$objectExist(f.attrs)?f.attrs:{},f.attrs.current=e.$stringExist(c)?c:"index"),e.$objectExist(g)&&(g=pageshare.collServer.fixMissingLegacyDocAPI(g),pageshare.currentDoc=g,pageshare.docReader.buildDocInfoUI(g)),d.router.go(f.name,f,!1),pageshare.UI.show(function(){pageshare.currentCollection={id:"aggregated-collection",owner_id:e.$objectExist(pageshare.currentUser)?pageshare.currentUser.id:"0",docs:j},pageshare.shelfCtrl.open(),setTimeout(function(){b.each(b("#shelf .cover"),function(){b(this).attr("awr-link",null),b(this).off("click"),b(this).on("click",function(a){a.preventDefault(),h(b(this).data("book-id")+"",f)})}),pageshare.shelfCtrl.resetSelected()},250)})}var j=[];return{start:c}}var f;pageshare.simpleSearch=new c}a.awr=a.awr||{},a.awr.bootQueue=a.awr.bootQueue||[];var d=a.awr||{},e=d.Q,f=d.bootQueue,g={moduleName:"simpleSearch@App",requires:[{name:"awr.$$appEssentials",type:"object"},{name:"pageshare.collServer",type:"object"}],wTime:1500,init:c,QAsContext:!0};f.push(g)}(window,jQuery),function(a,b){function c(){function a(a){var b=a&&a.attributes.attribute?a.attributes.attribute:{};return b.book_name=a&&a.book_name?a.book_name:"",b}function c(b,c){var d=new a(b);return awr.ux.scoredSearch.buildScoreTable(d,c)}function d(a,b){return b>a?1:b===a?0:-1}return{scoreTable:c,searchByQuery:function(a,e,f){if(!e||!e.length)return[];var g=[];for(var h in a){var i=a[h];g[h]=i,g[h].scoreTable=c(i,e)}return g.sort(function(a,b){var c=a.scoreTable.score,e=b.scoreTable.score,g=f&&f.length&&f.startsWith("field:"),h=null;if(g&&(h=f.split(":").length>0?f.split(":")[1]:null),h){var i=h.substring(0,1).toUpperCase()+h.substring(1);return void 0!==c[h]&&void 0!==e[h]?d(c[h],e[h]):void 0!==c[i]&&void 0!==e[i]?d(c[i],e[i]):d(c.total,e.total)}return d(c.total,e.total)}),g=b.grep(g,function(a,b){return a.scoreTable.score.total})}}}function d(){function a(){var a=function(c){c.preventDefault(),c.stopPropagation(),b(".doc-search .results-main").off("click",".cover",a),b(b(".doc-search .preview-main")).addClass("loading"),b(".doc-search .results-main .cover").removeClass("p-selected"),b(this).addClass("p-selected"),e.docReader.openPreview({docId:b(this).data("book-id"),complete:function(a){setTimeout(function(){g.showPreview(a)},500)},fail:function(){}})};b(".doc-search .results-main .cover").on("click",a)}function d(a){a=a||{};var c=a.query||"",d=a.group||"",f=d&&d.length?" in "+d:"";setTimeout(function(){e.shelfCtrl.close();var a=b(h({searchTitle:c+f}));b("#ajax-content").html(a),g.initC=0},200);var i=[],j=[];e.docServer.findAllCollections(function(c){for(var d in c){var f=c[d],g=c.length;f&&f.id&&function(c,d){e.docServer.findDocsByCollection(c.id,function(c){if(g--,c&&c.docs){var d;d=b.grep(c.docs,function(a){return i.indexOf(a.id)<0}),d.length>0&&j.push(d),b.each(j,function(a,c){b.each(c,function(a,b){i.indexOf(b.id)<0&&i.push(b.id)})}),g<1&&(b.each(j,function(a,c){j[a]=b.grep(c,function(a,b){return i.indexOf(a.id+"")>=0})}),"function"==typeof a.ready&&a.ready(j))}})}(f)}})}function f(a,c){var d=[].concat.apply([],g.results),e=[];d=b.grep(d,function(a,b){return!!(a&&a.id&&e.indexOf(a.id)<0)&&(e.push(a.id),!0)});var f=g.searchManager.searchByQuery(d,a,c);b(".doc-search .main .results-main .content").find(".result-group").remove(),g.insertResultsInUI(f,f[0],function(){b(b(".doc-search .main .results-main .content .cover")[0]).addClass("p-selected")})}var g=this,h=Pageshare.Templates["assets/modules/tagSearch/tagSearch.hbs"],i=Pageshare.Templates["assets/modules/tagSearch/resultGroup.hbs"];g.searchManager=new c,g.results=[],g.initC=0,g.start=function(a){a=a||{},a.query="Roosa Lehtinen",a.group="Authors";var b="field:"+a.group;g.initSearchViewLock=awr.ux.initLock(g.initSearchViewLock),g.initSearchViewLock.duration=500,awr.ux.execWithLock(g.initSearchViewLock,function(){d({query:a.query,group:a.group,ready:function(c){g.results=c,f(a.query,b)}})})},g.insertResultsInUI=function(c,d,f){if(c&&!(c.length<1)){var h=b(i({results:c,sortMode:""}));setTimeout(function(){b(".doc-search .main .results-main .content").append(h),a(),b(b(".doc-search .preview-main")).removeClass("empty"),d&&d.id&&(e.docReader.openPreview({docId:d.id,complete:function(a){g.showPreview(a),"function"==typeof f&&f()},fail:function(){}}),d=null)},500)}},g.showPreview=function(a){var c=b(".doc-search .preview-main");setTimeout(function(){var d=b(c).find(".content");b(d).html(b(a)),b(c).removeClass("loading"),b(d).height()<b(c).height()&&b(c).height(b(d).height()+50)},1500)},g.resizeView=function(a){a&&"large"===a?(b(".doc-search .icon-group.lg-mode").addClass("selected"),b(".doc-search .icon-group.md-mode").removeClass("selected"),b(".doc-search .main .preview-main").addClass("large"),b(".doc-search .main .results-main").addClass("large"),b(".doc-search .main .results-main").removeClass("medium")):(b(".doc-search .icon-group.md-mode").addClass("selected"),b(".doc-search .icon-group.lg-mode").removeClass("selected"),b(".doc-search .main .preview-main").removeClass("large"),b(".doc-search .main .results-main").addClass("medium"),b(".doc-search .main .results-main").removeClass("large"))}}var e=a.pageshare||{};e.tagSearch=new d,e.scoredDocSearch=new c,a.pageshare=e}(window,jQuery),function(a,b){"use strict";function c(){function c(){var c=0,e=null;b(a).scroll(function(){var f=a.scrollY>0;if(b("body").toggleClass("scrolled",f),!f)return void b("body").removeClass("show-navi");var g=a.scrollY-c;g>0?(b("body").removeClass("show-navi"),b("#mainMenu").css("top","0"),d.mainMenu.updateMenuScrollbar(250),c=a.scrollY,clearTimeout(e)):-g>8&&(b("body").addClass("show-navi"),b("#mainMenu").css("top","58px"),d.mainMenu.updateMenuScrollbar(250),clearTimeout(e),e=setTimeout(function(){c=a.scrollY},1e3))})}function g(a){var b,c,e=f.$reduce(d.collections,function(){return!(!f.$arrayNotEmpty(this.docs)||(b=f.$reduce(this.docs,function(){return c=this.book,f.$setContainsString([this.id,this.doc_id,"doc-"+this.doc_id,"d"+this.doc_id],a)||f.$objectExist(c)&&f.$setContainsString([c.id,c.doc_id,"doc-"+c.doc_id,"d"+c.doc_id],a)}),!f.$arrayNotEmpty(b)))});return f.$arrayNotEmpty(e)?e[0]:null}function h(){var a=f.$objectExist(d.currentUser)&&f.$exist(d.currentUser.user_id)?d.currentUser.user_id:null,c=f.$objectExist(d.currentCollection)&&f.$exist(d.currentCollection.owner_id)?d.currentCollection.owner_id:null,e=f.$exist(a)&&f.$exist(c)&&f.$stringEqual(a+"",c+"");q.show(function(){b("#contents #ajax-content").html("<div class='not-found'><strong>404 - Not Found!</strong><h1 class='fa fa-meh-o text-warning'>&nbsp;No content to show here!</h1></div>"),f.$booleanTrue(e)?f.$qTry(function(){d.shelfCtrl.open()},function(a){console.error(a)}):f.$qTry(function(){d.shelfCtrl.close()},function(a){console.error(a)}),o()})}function i(a){q.compileLock=e.ux.initLock(q.compileLock),q.compileLock.setDuration(200),e.ux.execWithLock(q.compileLock,function(){setTimeout(function(){e.domAttrs.$compile(b("body"),{router:e.router})},500),a!==!0&&"premium"===b("body").attr("id")&&(d.mainMenu.close(),d.tagSearch.start(),d.searchBar.start())})}function j(a,b){q.reloadLock=e.ux.initLock(q.reloadLock),q.reloadLock.setDuration(500),e.ux.execWithLock(q.reloadLock,function(){m(a,function(){e.router.reloadCurrentState()})})}function k(){setTimeout(function(){b(document).off("click","#contents",l),b(document).on("click","#contents",l)},500)}function l(c){var e=b(c.target);e.is(".page-share")||e.parents(".page-share").length>0||(b(a).width()<1600&&d.mainMenu.close(),b(this).parent().find(".page-share").removeClass("open"))}function m(b,g){d=a.pageshare||{},e=a.awr||{},f=e.Q,q.hide(),q.show(function(){q.reloadShelf(),q.reloadCurrentDoc(),q.reloadCurrentUser(b),q.compile(),q.reloadMainMenu(),q.reloadMainHeader(),c(),setTimeout(function(){q.compile(),d.mainMenu.resetSelected(),f.$functionExist(g)&&g()},200)})}function n(a,c){b("#mainlogo > .text").text("PageShare"),b("body").removeClass("has_book_info"),d.currentDoc=null;var e=!f.$exist(a)||a<=0||f.$setContainsString(["0","-1","null"],a);return e&&console.warn("openInReader@UI@Pageshare: nothing for be opened in reader. \n\t + Details: Bad docId ["+a+"]."),c=p(c)?c:"p1",new Promise(function(b,g){f.$booleanTrue(e)?(setTimeout(function(){h(),d.mainMenu.reload()},300),g("openInReader@UI@App: Bad docId!")):d.docReader.openDoc(a,function(){var a=f.$booleanTrue(d.currentDoc.book.isBusy);d.UI.show(),d.UI.reloadShelf(),a?d.docReader.updatePageNumberInURL(d.currentDoc,"1"):d.docReader.goToPage(c.replace("p","")),b(d.currentDoc)},function(a){h(),g(a)})})}function o(){var a,b,c=d.currentUser,g=d.currentCollection,h=e.router.getCurrentState(),i=f.$objectExist(h.attrs)?h.attrs.c:null,j=function(){setTimeout(function(){a=f.$objectExist(g)&&f.$collect(g.docs,function(a){return a=a||0,f.$stringEqual(this.visibility+"","1")&&a++,a}),b=f.$objectExist(c)&&f.$stringEqual(g.owner_id+"",c.user_id+""),(f.$booleanTrue(b)||a>0)&&d.shelfCtrl.open()},200)};!f.$objectExist(g)&&f.$stringExist(i)?d.collServer.loadAsCurrentCollection(i,function(a){g=a,d.currentCollection=a,j()},function(){j()}):j()}function p(a){var b=f.$stringExist(a)&&f.$stringEqual(a,"index"),c=f.$stringExist(a)&&a.startsWith("p")&&f.$numberExist(parseInt(a.replace("p","")));return b||c}var q=this;q.showNotFound=function(){h()},q.reloadMainHeader=function(){d.mainHeader.reload()},q.reloadShelf=function(){d.shelfCtrl.reload()},q.reloadMainMenu=function(){"premium"!==b("body").attr("id")&&d.mainMenu.reload()},q.reloadCurrentDoc=function(){f.$objectExist(d.currentDoc)&&f.$exist(d.currentDoc.id)&&d.docReader.reload()},q.reloadCurrentUser=function(a){d.userNav.reload(a)},q.reload=j,q.show=function(a,c){b("#shelf").addClass("hidden"),d.mainMenu.resetSelected(),setTimeout(function(){if(c&&c.hideShelf===!0&&d.shelfCtrl.close(),"function"==typeof a)try{a()}catch(a){console.error("UI: bad callback for UI.show! \n "+a)}b("body > #contents").fadeIn(300),b("body > #loading").hide(),b("body").removeClass("awr-busy"),b("body").addClass("awr-ready")},100)},q.hide=function(a){b("body > #contents").hide(),b("body > #loading").show()},q.compile=i,q.openDocInReader=function(a,b){var c=g(a);f.$objectExist(c)&&d.mainMenu.setSelected(c.id),q.inReaderLock=e.ux.initLock(q.inReaderLock),q.inReaderLock.setDuration(250);var h=e.ux.execWithLock(q.inReaderLock,function(){return n(a,b)});return f.$exist(h)&&f.$functionExist(h.then)?h:h.rejectAsPromise("openInReader@Pageshare@App")},q.initUI=m,q.setDefaultEventHandlers=k}var d=a.pageshare||{},e=a.awr||{},f=e.Q;d.UI=new c}(window,jQuery),function(a,b){function c(){function a(a){return a&&a.length>0?e(a.split(" ")[0]):""}function c(a){var b=a.split(" ");return b&&b.length>0?b.length>1?e(b[0])+" "+e(b[1]):e(b[0]):" "}function e(a){return a.substring(0,1).toUpperCase()+a.substring(1)}function f(a){if(a instanceof Date){var b={weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"};return a.toLocaleTimeString("en-us",b)}return""}function g(b){return{userName:a(b.user_name),fullName:c(b.user_name),userEmail:b.user_email,lastLogin:f(new Date(b.user_last_login)),userClass:"",logoutClass:"",loginClass:"hidden"}}var h=this;b("#sidebar-toggle").click(function(){h.hideInfo()}),b("#mainMenu").click(function(){h.hideInfo()}),b("#contents").click(function(){h.hideInfo()}),h.hideInfo=function(){if(d.currentUser){var a=b("#userNavInfo");b(a).removeClass("in"),b(a).addClass("out")}},h.showInfo=function(){if(d.currentUser){var a=b("#userNavInfo");b(a).removeClass("out"),b(a).addClass("in")}},h.toggleInfo=function(){var a=(d.currentUser,b("#userNavInfo"));b(a).hasClass("out")||!b(a).hasClass("in")?(b(a).removeClass("out"),b(a).addClass("in")):(b(a).removeClass("in"),b(a).addClass("out"))},h.reload=function(a){var c=Pageshare.Templates["assets/modules/userNav/userNav.hbs"],e="";if(a){var f=d.currentUser;e=b(f?c(g(f)):c({userClass:"hidden",logoutClass:"hidden",loginClass:"",userLevel:"guest"})),b("#userNavContainer").html(e),f&&f.is_admin===!0?(b("#userNav .user-info .fa-user").addClass("hidden"),b("#userNav .user-info .fa.admin").removeClass("hidden"),b("#userNav .user-info .user-role").removeClass("hidden"),b("#userNav .user-info #inviteButton").removeClass("hidden")):(b("#userNav .user-info .fa-user").removeClass("hidden"),b("#userNav .user-info .user-role").addClass("hidden"),b("#userNav .user-info .fa.admin").addClass("hidden"),b("#userNav .user-info #inviteButton").addClass("hidden"))}else d.activeLogin.findCurrentUser(function(a){e=b(a?c(g(a)):c({userClass:"hidden",logoutClass:"hidden",loginClass:"",userLevel:"guest"})),b("#userNavContainer").html(e),a&&a.is_admin===!0?(b("#userNav .user-info .fa-user").addClass("hidden"),b("#userNav .user-info .fa.admin").removeClass("hidden"),b("#userNav .user-info .user-role").removeClass("hidden"),b("#userNav .user-info #inviteButton").removeClass("hidden")):(b("#userNav .user-info .fa-user").removeClass("hidden"),b("#userNav .user-info .user-role").addClass("hidden"),b("#userNav .user-info .fa.admin").addClass("hidden"),b("#userNav .user-info #inviteButton").addClass("hidden"))})}}var d=a.pageshare||{};d.userNav=new c,a.pageshare=d}(window,jQuery);